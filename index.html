<!DOCTYPE html>
<html lang="ja">
<head>
  <!--
    Supabase ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¿…è¦ãªã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã™ã‚‹SQL:
    ALTER TABLE user_settings ADD COLUMN IF NOT EXISTS vision_api_key TEXT;
    ALTER TABLE expenses ADD COLUMN IF NOT EXISTS memo TEXT;
  -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#10b981">
  <meta name="description" content="Uber Eatsé…é”ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼å‘ã‘é€±é–“å£²ä¸Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼">
  <title>Uberè¨˜éŒ²</title>
  <link rel="manifest" href="manifest.json?v=5">
  <link rel="icon" type="image/jpeg" href="ã‚¢ã‚¤ã‚³ãƒ³.jpg?v=5">
  <link rel="apple-touch-icon" href="ã‚¢ã‚¤ã‚³ãƒ³.jpg?v=5">
  <script crossorigin="anonymous" src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin="anonymous" src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin="anonymous" src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overscroll-behavior-x: none;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Supabase initialization
    const SUPABASE_URL = 'https://gavepcaxauzmthpuqodg.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhdmVwY2F4YXV6bXRocHVxb2RnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMjU1OTMsImV4cCI6MjA3ODYwMTU5M30.u_65L-VfD7GdTVXDB_yql81YpRrEEztYLes-Greidlk';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Lucide icons as simple SVG components
    const Calculator = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <rect x="4" y="2" width="16" height="20" rx="2"/>
        <line x1="8" y1="6" x2="16" y2="6"/>
        <line x1="16" y1="14" x2="16" y2="14.01"/>
        <line x1="12" y1="14" x2="12" y2="14.01"/>
        <line x1="8" y1="14" x2="8" y2="14.01"/>
        <line x1="16" y1="18" x2="16" y2="18.01"/>
        <line x1="12" y1="18" x2="12" y2="18.01"/>
        <line x1="8" y1="18" x2="8" y2="18.01"/>
      </svg>
    );

    const DollarSign = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="12" y1="1" x2="12" y2="23"/>
        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
      </svg>
    );

    const Settings = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="12" cy="12" r="3"/>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
      </svg>
    );

    const Package = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="16.5" y1="9.4" x2="7.5" y2="4.21"/>
        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
        <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
        <line x1="12" y1="22.08" x2="12" y2="12"/>
      </svg>
    );

    const Award = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="12" cy="8" r="7"/>
        <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/>
      </svg>
    );

    const Calendar = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
        <line x1="16" y1="2" x2="16" y2="6"/>
        <line x1="8" y1="2" x2="8" y2="6"/>
        <line x1="3" y1="10" x2="21" y2="10"/>
      </svg>
    );

    const Receipt = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1-2-1Z"/>
        <path d="M14 8H8"/>
        <path d="M16 12H8"/>
        <path d="M13 16H8"/>
      </svg>
    );

    // Authentication Component
    function AuthUI({ onAuthSuccess }) {
      const [isSignUp, setIsSignUp] = useState(false);
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [showBiometricButton, setShowBiometricButton] = useState(false);

      // ç”Ÿä½“èªè¨¼ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
      const handleBiometricLogin = async () => {
        if (!window.PasswordCredential) return;

        try {
          setLoading(true);
          setError('');

          // ä¿å­˜ã•ã‚Œã¦ã„ã‚‹èªè¨¼æƒ…å ±ã‚’å–å¾—ï¼ˆç”Ÿä½“èªè¨¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
          const credential = await navigator.credentials.get({
            password: true,
            mediation: 'required' // å¿…ãšèªè¨¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤º
          });

          if (credential && credential.type === 'password') {
            // èªè¨¼æƒ…å ±ã‚’å–å¾—ã§ããŸå ´åˆã€è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³
            const result = await supabaseClient.auth.signInWithPassword({
              email: credential.id,
              password: credential.password,
            });

            if (result.error) throw result.error;
            onAuthSuccess(result.data.session);
          }
        } catch (err) {
          console.log('Biometric login cancelled or failed:', err);
          setError('ç”Ÿä½“èªè¨¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
        } finally {
          setLoading(false);
        }
      };

      // è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ï¼ˆç”Ÿä½“èªè¨¼ï¼‰
      useEffect(() => {
        const tryAutoLogin = async () => {
          // Credential Management APIãŒåˆ©ç”¨å¯èƒ½ã‹ç¢ºèª
          if (!window.PasswordCredential || isSignUp) return;

          try {
            // ä¿å­˜ã•ã‚Œã¦ã„ã‚‹èªè¨¼æƒ…å ±ã‚’è‡ªå‹•çš„ã«å–å¾—ã‚’è©¦ã¿ã‚‹
            const credential = await navigator.credentials.get({
              password: true,
              mediation: 'silent' // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œãªã—ã§è‡ªå‹•çš„ã«å–å¾—
            });

            if (credential && credential.type === 'password') {
              // èªè¨¼æƒ…å ±ã‚’å–å¾—ã§ããŸå ´åˆã€è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³
              setLoading(true);

              const result = await supabaseClient.auth.signInWithPassword({
                email: credential.id,
                password: credential.password,
              });

              if (result.error) throw result.error;
              onAuthSuccess(result.data.session);
            } else {
              // è‡ªå‹•å–å¾—ã§ããªã‹ã£ãŸå ´åˆã€ç”Ÿä½“èªè¨¼ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
              setShowBiometricButton(true);
            }
          } catch (err) {
            console.log('Auto login skipped:', err);
            // è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ã§ããªã„å ´åˆã€ç”Ÿä½“èªè¨¼ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            setShowBiometricButton(true);
          } finally {
            setLoading(false);
          }
        };

        tryAutoLogin();
      }, [isSignUp, onAuthSuccess]);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
          let result;
          if (isSignUp) {
            // Sign up
            result = await supabaseClient.auth.signUp({
              email,
              password,
            });
            if (result.error) throw result.error;

            // Check if email confirmation is required
            if (result.data.user && result.data.user.identities && result.data.user.identities.length === 0) {
              setError('ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
              setIsSignUp(false);
            } else if (result.data.session) {
              onAuthSuccess(result.data.session);
            } else {
              alert('ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„ã€‚');
            }
          } else {
            // Sign in
            result = await supabaseClient.auth.signInWithPassword({
              email,
              password,
            });
            if (result.error) throw result.error;

            // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸå¾Œã€èªè¨¼æƒ…å ±ã‚’ä¿å­˜ï¼ˆæ¬¡å›ã®è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ç”¨ï¼‰
            if (window.PasswordCredential) {
              try {
                const credential = new PasswordCredential({
                  id: email,
                  password: password,
                });
                await navigator.credentials.store(credential);
              } catch (storeErr) {
                console.log('Credential store skipped:', storeErr);
              }
            }

            onAuthSuccess(result.data.session);
          }
        } catch (err) {
          console.error('Auth error:', err);
          setError(err.message || 'èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-emerald-50 to-teal-100 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
            <div className="text-center mb-8">
              <h1 className="text-3xl font-bold text-gray-800 mb-2">Uberè¨˜éŒ²</h1>
              <p className="text-gray-600">
                {isSignUp ? 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ' : 'ãƒ­ã‚°ã‚¤ãƒ³'}
              </p>
            </div>

            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
                </label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  required
                  autoComplete="email"
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
                  placeholder="example@email.com"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
                </label>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  required
                  minLength="6"
                  autoComplete="current-password"
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
                  placeholder="6æ–‡å­—ä»¥ä¸Š"
                />
              </div>

              {error && (
                <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
                  {error}
                </div>
              )}

              <button
                type="submit"
                disabled={loading}
                className="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {loading ? 'å‡¦ç†ä¸­...' : (isSignUp ? 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ' : 'ãƒ­ã‚°ã‚¤ãƒ³')}
              </button>
            </form>

            {/* ç”Ÿä½“èªè¨¼ãƒœã‚¿ãƒ³ */}
            {!isSignUp && showBiometricButton && (
              <div className="mt-4">
                <div className="relative flex items-center justify-center my-4">
                  <div className="border-t border-gray-300 w-full"></div>
                  <span className="bg-white px-3 text-sm text-gray-500 absolute">ã¾ãŸã¯</span>
                </div>
                <button
                  type="button"
                  onClick={handleBiometricLogin}
                  disabled={loading}
                  className="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                  </svg>
                  ç”Ÿä½“èªè¨¼ã§ãƒ­ã‚°ã‚¤ãƒ³
                </button>
              </div>
            )}

            <div className="mt-6 text-center">
              <button
                onClick={() => {
                  setIsSignUp(!isSignUp);
                  setError('');
                }}
                className="text-emerald-600 hover:text-emerald-700 text-sm font-medium"
              >
                {isSignUp ? 'æ—¢ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã®æ–¹ã¯ã“ã¡ã‚‰' : 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Main App Component with Auth
    function App() {
      const [session, setSession] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        // Check active sessions
        supabaseClient.auth.getSession().then(({ data: { session } }) => {
          setSession(session);
          setLoading(false);
        });

        // Listen for auth changes
        const {
          data: { subscription },
        } = supabaseClient.auth.onAuthStateChange((_event, session) => {
          setSession(session);
        });

        return () => subscription.unsubscribe();
      }, []);

      if (loading) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-emerald-50 to-teal-100 flex items-center justify-center">
            <div className="text-center">
              <div className="inline-block animate-spin rounded-full h-12 w-12 border-4 border-emerald-500 border-t-transparent"></div>
              <p className="mt-4 text-gray-600">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
          </div>
        );
      }

      if (!session) {
        return <AuthUI onAuthSuccess={setSession} />;
      }

      return <UberEatsSimulator session={session} />;
    }

    function UberEatsSimulator({ session }) {
      // å®šæ•°å®šç¾©
      const days = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
      const weekdays = ['æœˆ', 'ç«', 'æ°´', 'æœ¨'];
      const weekends = ['é‡‘', 'åœŸ', 'æ—¥'];

      // çµŒè²»ã‚«ãƒ†ã‚´ãƒªãƒ¼
      const expenseCategories = {
        fuel: { name: 'ã‚¬ã‚½ãƒªãƒ³ä»£', emoji: 'â›½' },
        maintenance: { name: 'è»Šä¸¡æ•´å‚™', emoji: 'ğŸ”§' },
        parking: { name: 'é§è»Šå ´ä»£', emoji: 'ğŸ…¿ï¸' },
        phone: { name: 'é€šä¿¡è²»', emoji: 'ğŸ“±' },
        insurance: { name: 'ä¿é™ºæ–™', emoji: 'ğŸ›¡ï¸' },
        equipment: { name: 'è£…å‚™å“', emoji: 'ğŸ’' },
        other: { name: 'ãã®ä»–', emoji: 'ğŸ“' }
      };

      // å€Ÿæ–¹ç§‘ç›®ï¼ˆå‹˜å®šç§‘ç›®ï¼‰- é’è‰²ç”³å‘Šç”¨
      const accountingSubjects = {
        travel: 'æ—…è²»äº¤é€šè²»',
        supplies: 'æ¶ˆè€—å“è²»',
        communication: 'é€šä¿¡è²»',
        misc: 'é›‘è²»',
        depreciation: 'æ¸›ä¾¡å„Ÿå´è²»',
        insurance: 'æå®³ä¿é™ºæ–™',
        repairs: 'ä¿®ç¹•è²»',
        utilities: 'æ°´é“å…‰ç†±è²»',
        rent: 'åœ°ä»£å®¶è³ƒ',
        welfare: 'ç¦åˆ©åšç”Ÿè²»',
        tax: 'ç§Ÿç¨å…¬èª²',
        advertising: 'åºƒå‘Šå®£ä¼è²»',
        entertainment: 'æ¥å¾…äº¤éš›è²»',
        shipping: 'è·é€ é‹è³ƒ',
        // æ—§ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰ã®ãƒãƒƒãƒ”ãƒ³ã‚°
        fuel: 'æ—…è²»äº¤é€šè²»',
        maintenance: 'ä¿®ç¹•è²»',
        parking: 'æ—…è²»äº¤é€šè²»',
        phone: 'é€šä¿¡è²»',
        equipment: 'æ¶ˆè€—å“è²»',
        other: 'é›‘è²»',
        repair: 'ä¿®ç¹•è²»',
        vehicle: 'è»Šä¸¡è²»'
      };

      // è²¸æ–¹ç§‘ç›®ï¼ˆæ”¯æ‰•æ–¹æ³•ï¼‰
      const creditAccountSubjects = {
        cash: 'ç¾é‡‘',
        credit: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ',
        ordinaryDeposit: 'æ™®é€šé é‡‘'
      };

      // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã”ã¨ã®æ¨å¥¨å€Ÿæ–¹ç§‘ç›®
      const categoryToSubjects = {
        fuel: ['fuel', 'travel', 'vehicle'],
        maintenance: ['repair', 'vehicle'],
        parking: ['rent', 'travel', 'vehicle'],
        phone: ['communication'],
        insurance: ['insurance'],
        equipment: ['supplies'],
        other: ['misc', 'travel', 'vehicle', 'supplies', 'commission']
      };

      // localStorageã®å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯ã¨ä¿®å¾©
      const validateAndFixLocalStorage = () => {
        try {
          // å„ã‚­ãƒ¼ã‚’æ¤œè¨¼
          const keysToValidate = [
            'weekdayAvgPrice', 'weekendAvgPrice',
            'weekdayDeliveriesPerHour', 'weekendDeliveriesPerHour',
            'useAutoCalculate', 'weekdayQuests', 'weekendQuests',
            'hours', 'targetAmount', 'dailyData',
            'currentWeekStart', 'lastAccessDate'
          ];

          keysToValidate.forEach(key => {
            try {
              const value = localStorage.getItem(key);
              if (value && value !== 'undefined' && value !== 'null') {
                // JSON.parseã‚’è©¦ã™
                JSON.parse(value);
              }
            } catch (e) {
              console.warn(`Removing corrupted localStorage key: ${key}`);
              localStorage.removeItem(key);
            }
          });
        } catch (error) {
          console.error('localStorage validation error:', error);
        }
      };

      // ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«å®Ÿè¡Œ
      validateAndFixLocalStorage();

      // ãƒ¢ãƒ¼ãƒ€ãƒ«çŠ¶æ…‹
      const [showBasicSettings, setShowBasicSettings] = useState(false);
      const [showQuestSettings, setShowQuestSettings] = useState(false);
      const [showCalendar, setShowCalendar] = useState(false);
      const [showTotalStats, setShowTotalStats] = useState(false);
      const [totalStatsTab, setTotalStatsTab] = useState('summary'); // 'summary' or 'daily'
      const [showWeeklySalesList, setShowWeeklySalesList] = useState(false);

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®refï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ãƒªã‚»ãƒƒãƒˆç”¨ï¼‰
      const questModalContentRef = React.useRef(null);

      // å¤ã„localStorageã‚­ãƒ¼ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆä¸€åº¦ã ã‘å®Ÿè¡Œï¼‰
      try {
        if (typeof window !== 'undefined' && typeof localStorage !== 'undefined' && !localStorage.getItem('cleanupDone_v2')) {
          // å¤ã„ã‚­ãƒ¼ã‚’å‰Šé™¤
          localStorage.removeItem('avgPrice');
          localStorage.removeItem('deliveriesPerHour');
          localStorage.setItem('cleanupDone_v2', 'true');
        }
      } catch (error) {
        console.error('localStorage cleanup error:', error);
      }

      // localStorageã‹ã‚‰åˆæœŸå€¤ã‚’èª­ã¿è¾¼ã‚€ï¼ˆå®‰å…¨ç‰ˆï¼‰
      const loadFromStorage = (key, defaultValue) => {
        try {
          if (typeof window !== 'undefined' && typeof localStorage !== 'undefined') {
            const saved = localStorage.getItem(key);
            if (saved === null || saved === undefined || saved === 'undefined' || saved === 'null') {
              return defaultValue;
            }
            try {
              return JSON.parse(saved);
            } catch (parseError) {
              console.error(`JSON parse error for key ${key}:`, parseError);
              return defaultValue;
            }
          }
        } catch (error) {
          console.error(`localStorage load error for key ${key}:`, error);
        }
        return defaultValue;
      };

      // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã®ref
      const fileInputRef = useRef(null);

      // åŸºæœ¬è¨­å®š (Supabaseã‹ã‚‰èª­ã¿è¾¼ã‚€)
      const [weekdayAvgPrice, setWeekdayAvgPrice] = useState(400);
      const [weekendAvgPrice, setWeekendAvgPrice] = useState(400);
      const [weekdayDeliveriesPerHour, setWeekdayDeliveriesPerHour] = useState(4);
      const [weekendDeliveriesPerHour, setWeekendDeliveriesPerHour] = useState(4);
      const [useAutoCalculate, setUseAutoCalculate] = useState(false);
      const [settingsLoading, setSettingsLoading] = useState(true);
      
      // ã‚¯ã‚¨ã‚¹ãƒˆè¨­å®š (Supabaseã‹ã‚‰èª­ã¿è¾¼ã‚€)
      const [weekdayQuests, setWeekdayQuests] = useState([
        { count: 10, reward: 0 },
        { count: 10, reward: 0 },
        { count: 10, reward: 0 },
        { count: 10, reward: 0 },
        { count: 10, reward: 0 }
      ]);

      const [weekendQuests, setWeekendQuests] = useState([
        { count: 10, reward: 0 },
        { count: 10, reward: 0 },
        { count: 10, reward: 0 },
        { count: 10, reward: 0 },
        { count: 10, reward: 0 }
      ]);
      
      // å„æ›œæ—¥ã®ç¨¼åƒæ™‚é–“ãƒ»ä»¶æ•°ãƒ»é‡‘é¡ (Supabaseã‹ã‚‰èª­ã¿è¾¼ã‚€)
      const [hours, setHours] = useState({
        æœˆ: { hours: 0, deliveries: 0, earnings: 0 },
        ç«: { hours: 0, deliveries: 0, earnings: 0 },
        æ°´: { hours: 0, deliveries: 0, earnings: 0 },
        æœ¨: { hours: 0, deliveries: 0, earnings: 0 },
        é‡‘: { hours: 0, deliveries: 0, earnings: 0 },
        åœŸ: { hours: 0, deliveries: 0, earnings: 0 },
        æ—¥: { hours: 0, deliveries: 0, earnings: 0 }
      });
      
      // ç›®æ¨™é‡‘é¡ (Supabaseã‹ã‚‰èª­ã¿è¾¼ã‚€)
      const [targetAmount, setTargetAmount] = useState(0);

      // éå»ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ï¼ˆæ—¥ä»˜ã‚­ãƒ¼: YYYY-MM-DDå½¢å¼ï¼‰ - ã“ã‚Œã¯localStorageã®ã¾ã¾
      const [historicalData, setHistoricalData] = useState(() => loadFromStorage('historicalData', {}));

      // æ—¥å˜ä½ã®ãƒ‡ãƒ¼ã‚¿ (Supabaseã‹ã‚‰èª­ã¿è¾¼ã‚€)
      const [dailyData, setDailyData] = useState({});
      const [dailyDataLoading, setDailyDataLoading] = useState(true);

      // æœ€å¾Œã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸæ—¥ä»˜ - ã“ã‚Œã¯localStorageã®ã¾ã¾
      const [lastAccessDate, setLastAccessDate] = useState(() => loadFromStorage('lastAccessDate', null));

      // ç¾åœ¨ã®é€±ã®é–‹å§‹æ—¥ (Supabaseã‹ã‚‰èª­ã¿è¾¼ã‚€)
      const [currentWeekStart, setCurrentWeekStart] = useState(null);

      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é–¢é€£ã®state
      const [currentMonth, setCurrentMonth] = useState(() => new Date());
      const [selectedDate, setSelectedDate] = useState(null);
      const [originalSelectedDate, setOriginalSelectedDate] = useState(null); // æ—¥ä»˜å¤‰æ›´ç”¨
      const [showDayEdit, setShowDayEdit] = useState(false);
      const [isChangingDate, setIsChangingDate] = useState(false); // æ—¥ä»˜å¤‰æ›´ãƒ¢ãƒ¼ãƒ‰
      const [editingDayData, setEditingDayData] = useState({ hours: 0, deliveries: 0, earnings: 0, quest: 0, isRainy: false, isHoliday: false });

      // çµŒè²»ç®¡ç†é–¢é€£ã®state
      const [expenses, setExpenses] = useState({});
      const [expensesLoading, setExpensesLoading] = useState(true);
      const [showExpenses, setShowExpenses] = useState(false);
      const [showExpenseInput, setShowExpenseInput] = useState(false);
      const [showExpenseGuide, setShowExpenseGuide] = useState(false);
      const [editingExpense, setEditingExpense] = useState(null);
      const [editingExpenseId, setEditingExpenseId] = useState(null);
      const [expenseFilter, setExpenseFilter] = useState({});
      const [showExpenseFilter, setShowExpenseFilter] = useState(false);
      const [showImagePreview, setShowImagePreview] = useState(false);
      const [previewImage, setPreviewImage] = useState(null);
      const [swipedExpenseId, setSwipedExpenseId] = useState(null);
      const [isProcessingOCR, setIsProcessingOCR] = useState(false);
      const [showDescriptionSuggestions, setShowDescriptionSuggestions] = useState(false);
      const [descriptionSuggestions, setDescriptionSuggestions] = useState([]);
      const [showVendorSuggestions, setShowVendorSuggestions] = useState(false);
      const [vendorSuggestions, setVendorSuggestions] = useState([]);

      // è²¡å‹™è«¸è¡¨é–¢é€£ã®state
      const [showBalanceSheet, setShowBalanceSheet] = useState(false);
      const [showIncomeStatement, setShowIncomeStatement] = useState(false);
      const [incomeStatementPeriod, setIncomeStatementPeriod] = useState('thisYear');

      // ãƒ“ãƒƒãƒˆã‚³ã‚¤ãƒ³ç©ã¿ç«‹ã¦é–¢é€£ã®state
      const [showBTCModal, setShowBTCModal] = useState(false);

      const [visionApiKey, setVisionApiKey] = useState(() => {
        try {
          return localStorage.getItem('visionApiKey') || '';
        } catch {
          return '';
        }
      });

      // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰è¨­å®š
      const [isDarkMode, setIsDarkMode] = useState(() => {
        try {
          const saved = localStorage.getItem('darkMode');
          return saved === 'true';
        } catch (error) {
          console.error('Failed to load dark mode setting:', error);
          return false;
        }
      });

      // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆ
      const toggleDarkMode = () => {
        try {
          const newMode = !isDarkMode;
          setIsDarkMode(newMode);
          localStorage.setItem('darkMode', String(newMode));
        } catch (error) {
          console.error('Failed to save dark mode setting:', error);
          alert('ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      };

      // åº—èˆ—åå€™è£œã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ï¼ˆä½¿ç”¨å›æ•°é †ã«ã‚½ãƒ¼ãƒˆï¼‰
      const getVendorSuggestions = (inputValue) => {
        // expensesãŒæœªå®šç¾©ã¾ãŸã¯ç©ºã®å ´åˆã¯ç©ºé…åˆ—ã‚’è¿”ã™
        if (!expenses || expenses.length === 0) {
          return [];
        }

        if (!inputValue || inputValue.trim().length === 0) {
          // å…¥åŠ›ãŒãªã„å ´åˆã¯ã€å…¨åº—èˆ—åã‚’ä½¿ç”¨å›æ•°é †ã«è¡¨ç¤º
          const vendorCounts = {};
          expenses.forEach(expense => {
            if (expense.vendor && expense.vendor.trim()) {
              const vendor = expense.vendor.trim();
              vendorCounts[vendor] = (vendorCounts[vendor] || 0) + 1;
            }
          });

          // ä½¿ç”¨å›æ•°é †ã«ã‚½ãƒ¼ãƒˆ
          const sortedVendors = Object.entries(vendorCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10) // ä¸Šä½10ä»¶
            .map(([vendor, count]) => ({ vendor, count }));

          return sortedVendors;
        }

        // å…¥åŠ›å€¤ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        const inputLower = inputValue.toLowerCase();
        const vendorCounts = {};

        expenses.forEach(expense => {
          if (expense.vendor && expense.vendor.trim()) {
            const vendor = expense.vendor.trim();
            const vendorLower = vendor.toLowerCase();

            // éƒ¨åˆ†ä¸€è‡´ã§å€™è£œã‚’æŠ½å‡º
            if (vendorLower.includes(inputLower)) {
              vendorCounts[vendor] = (vendorCounts[vendor] || 0) + 1;
            }
          }
        });

        // ä½¿ç”¨å›æ•°é †ã«ã‚½ãƒ¼ãƒˆ
        const sortedVendors = Object.entries(vendorCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10) // ä¸Šä½10ä»¶
          .map(([vendor, count]) => ({ vendor, count }));

        return sortedVendors;
      };

      // åº—èˆ—åã‚’æ­£è¦åŒ–ã™ã‚‹é–¢æ•°ï¼ˆè¡¨è¨˜ã‚†ã‚Œã‚’çµ±ä¸€ï¼‰
      const normalizeVendorName = (vendorName) => {
        if (!vendorName) return '';

        // è¡¨è¨˜ã‚†ã‚Œã‚’çµ±ä¸€ã™ã‚‹ãƒãƒƒãƒ”ãƒ³ã‚°
        const normalizationMap = {
          // ã‚¬ã‚½ãƒªãƒ³ã‚¹ã‚¿ãƒ³ãƒ‰
          'ã‚¨ãƒã‚ªã‚¹': 'ENEOS',
          'ãˆã­ãŠã™': 'ENEOS',
          'å‡ºå…‰': 'å‡ºå…‰èˆˆç”£',
          'IDEMITSU': 'å‡ºå…‰èˆˆç”£',
          'æ˜­å’Œã‚·ã‚§ãƒ«': 'æ˜­å’Œã‚·ã‚§ãƒ«çŸ³æ²¹',
          'Shell': 'æ˜­å’Œã‚·ã‚§ãƒ«çŸ³æ²¹',
          'ã‚³ã‚¹ãƒ¢': 'ã‚³ã‚¹ãƒ¢çŸ³æ²¹',
          'COSMO': 'ã‚³ã‚¹ãƒ¢çŸ³æ²¹',
          'ã‚¨ãƒƒã‚½': 'ESSO',
          'ãƒ¢ãƒ¼ãƒ“ãƒ«': 'Mobil',
          'ã‚­ã‚°ãƒŠã‚¹': 'KYGNUS',

          // ã‚³ãƒ³ãƒ“ãƒ‹
          'ã‚»ãƒ–ãƒ³-ã‚¤ãƒ¬ãƒ–ãƒ³': 'ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³',
          '7-ELEVEN': 'ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³',
          '7-11': 'ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³',
          'ï¼—ï¼ï¼‘ï¼‘': 'ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³',
          'ãƒ•ã‚¡ãƒŸãƒ': 'ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒãƒ¼ãƒˆ',
          'FamilyMart': 'ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒãƒ¼ãƒˆ',
          'LAWSON': 'ãƒ­ãƒ¼ã‚½ãƒ³',
          'ï¾›ï½°ï½¿ï¾': 'ãƒ­ãƒ¼ã‚½ãƒ³',
          'MINISTOP': 'ãƒŸãƒ‹ã‚¹ãƒˆãƒƒãƒ—',
          'Daily': 'ãƒ‡ã‚¤ãƒªãƒ¼ãƒ¤ãƒã‚¶ã‚­',

          // ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ»ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢
          'AEON': 'ã‚¤ã‚ªãƒ³',
          'ï½²ï½µï¾': 'ã‚¤ã‚ªãƒ³',
          'SEIYU': 'è¥¿å‹',
          'ã›ã„ã‚†ã†': 'è¥¿å‹',
          'ãƒãƒ„ã‚­ãƒ¨': 'ãƒãƒ„ãƒ¢ãƒˆã‚­ãƒ¨ã‚·',
          'Welcia': 'ã‚¦ã‚¨ãƒ«ã‚·ã‚¢',
          'ã‚¦ã‚§ãƒ«ã‚·ã‚¢': 'ã‚¦ã‚¨ãƒ«ã‚·ã‚¢',

          // ãƒ•ã‚¡ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰
          'ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰': 'ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰',
          'McDonald': 'ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰',
          "McDonald's": 'ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰',
          'ãƒãƒƒã‚¯': 'ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰',

          // ãã®ä»–
          'ãƒ‰ãƒ³ã‚­': 'ãƒ‰ãƒ³ãƒ»ã‚­ãƒ›ãƒ¼ãƒ†',
          'ãƒ‰ãƒ³ã‚­ãƒ›ãƒ¼ãƒ†': 'ãƒ‰ãƒ³ãƒ»ã‚­ãƒ›ãƒ¼ãƒ†',
          'ã‚¢ãƒã‚¾ãƒ³': 'Amazon',
          'amazon': 'Amazon',
          'AMAZON': 'Amazon',
          'æ¥½å¤©': 'æ¥½å¤©å¸‚å ´',
          'Rakuten': 'æ¥½å¤©å¸‚å ´',

          // ã‚«ãƒ•ã‚§
          'ã‚¹ã‚¿ãƒ': 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹',
          'STARBUCKS': 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹',
          'Starbucks': 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹',
          'ãƒ‰ãƒˆãƒ¼ãƒ«': 'ãƒ‰ãƒˆãƒ¼ãƒ«ã‚³ãƒ¼ãƒ’ãƒ¼',
          'DOUTOR': 'ãƒ‰ãƒˆãƒ¼ãƒ«ã‚³ãƒ¼ãƒ’ãƒ¼',

          // å®¶é›»é‡è²©åº—
          'ãƒ¤ãƒãƒ€': 'ãƒ¤ãƒãƒ€é›»æ©Ÿ',
          'ãƒ“ãƒƒã‚¯': 'ãƒ“ãƒƒã‚¯ã‚«ãƒ¡ãƒ©',
          'BIC': 'ãƒ“ãƒƒã‚¯ã‚«ãƒ¡ãƒ©',
          'ãƒ¨ãƒ‰ãƒã‚·': 'ãƒ¨ãƒ‰ãƒã‚·ã‚«ãƒ¡ãƒ©',

          // ãƒ›ãƒ¼ãƒ ã‚»ãƒ³ã‚¿ãƒ¼
          'ã‚«ã‚¤ãƒ³ã‚º': 'ã‚«ã‚¤ãƒ³ã‚ºãƒ›ãƒ¼ãƒ ',
          'CAINZ': 'ã‚«ã‚¤ãƒ³ã‚ºãƒ›ãƒ¼ãƒ ',
          'ã‚³ãƒ¼ãƒŠãƒ³': 'ã‚³ãƒ¼ãƒŠãƒ³',
          'KOHNAN': 'ã‚³ãƒ¼ãƒŠãƒ³'
        };

        // å®Œå…¨ä¸€è‡´ã§æ­£è¦åŒ–
        for (const [pattern, normalized] of Object.entries(normalizationMap)) {
          if (vendorName === pattern || vendorName.toUpperCase() === pattern.toUpperCase()) {
            return normalized;
          }
        }

        // éƒ¨åˆ†ä¸€è‡´ã§æ­£è¦åŒ–ï¼ˆã‚ˆã‚Šç·©ã„æ¡ä»¶ï¼‰
        for (const [pattern, normalized] of Object.entries(normalizationMap)) {
          if (vendorName.includes(pattern) || vendorName.toUpperCase().includes(pattern.toUpperCase())) {
            return normalized;
          }
        }

        // æ­£è¦åŒ–å¯¾è±¡ã§ãªã„å ´åˆã¯å…ƒã®åå‰ã‚’è¿”ã™
        return vendorName;
      };

      // ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰åº—èˆ—åã‚’æŠ½å‡ºã™ã‚‹é–¢æ•°
      const extractVendorFromText = (text) => {
        let extractedVendor = '';

        // ã‚ˆãçŸ¥ã‚‰ã‚ŒãŸåº—èˆ—ãƒã‚§ãƒ¼ãƒ³ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆæ­£è¦åŒ–å¾Œã®åå‰ã¨å¯¾å¿œï¼‰
        const knownVendors = [
          // ã‚¬ã‚½ãƒªãƒ³ã‚¹ã‚¿ãƒ³ãƒ‰
          { pattern: /ENEOS|ã‚¨ãƒã‚ªã‚¹|ãˆã­ãŠã™/i, name: 'ENEOS' },
          { pattern: /å‡ºå…‰|IDEMITSU/i, name: 'å‡ºå…‰èˆˆç”£' },
          { pattern: /æ˜­å’Œã‚·ã‚§ãƒ«|Shell/i, name: 'æ˜­å’Œã‚·ã‚§ãƒ«çŸ³æ²¹' },
          { pattern: /ã‚³ã‚¹ãƒ¢çŸ³æ²¹|COSMO|ã‚³ã‚¹ãƒ¢/i, name: 'ã‚³ã‚¹ãƒ¢çŸ³æ²¹' },
          { pattern: /ã‚¨ãƒƒã‚½|ESSO/i, name: 'ESSO' },
          { pattern: /ãƒ¢ãƒ¼ãƒ“ãƒ«|Mobil/i, name: 'Mobil' },
          { pattern: /ã‚­ã‚°ãƒŠã‚¹|KYGNUS/i, name: 'KYGNUS' },

          // ã‚³ãƒ³ãƒ“ãƒ‹
          { pattern: /ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³|ã‚»ãƒ–ãƒ³-ã‚¤ãƒ¬ãƒ–ãƒ³|7-ELEVEN|7-11|ï¼—ï¼ï¼‘ï¼‘/i, name: 'ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³' },
          { pattern: /ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒãƒ¼ãƒˆ|FamilyMart|ãƒ•ã‚¡ãƒŸãƒ/i, name: 'ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒãƒ¼ãƒˆ' },
          { pattern: /ãƒ­ãƒ¼ã‚½ãƒ³|LAWSON|ï¾›ï½°ï½¿ï¾/i, name: 'ãƒ­ãƒ¼ã‚½ãƒ³' },
          { pattern: /ãƒŸãƒ‹ã‚¹ãƒˆãƒƒãƒ—|MINISTOP/i, name: 'ãƒŸãƒ‹ã‚¹ãƒˆãƒƒãƒ—' },
          { pattern: /ãƒ‡ã‚¤ãƒªãƒ¼ãƒ¤ãƒã‚¶ã‚­|Daily/i, name: 'ãƒ‡ã‚¤ãƒªãƒ¼ãƒ¤ãƒã‚¶ã‚­' },

          // ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ»ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢
          { pattern: /ã‚¤ã‚ªãƒ³|AEON|ï½²ï½µï¾/i, name: 'ã‚¤ã‚ªãƒ³' },
          { pattern: /è¥¿å‹|SEIYU|ã›ã„ã‚†ã†/i, name: 'è¥¿å‹' },
          { pattern: /ã‚¤ãƒˆãƒ¼ãƒ¨ãƒ¼ã‚«ãƒ‰ãƒ¼/i, name: 'ã‚¤ãƒˆãƒ¼ãƒ¨ãƒ¼ã‚«ãƒ‰ãƒ¼' },
          { pattern: /ãƒãƒ„ãƒ¢ãƒˆã‚­ãƒ¨ã‚·|ãƒãƒ„ã‚­ãƒ¨/i, name: 'ãƒãƒ„ãƒ¢ãƒˆã‚­ãƒ¨ã‚·' },
          { pattern: /ã‚¦ã‚¨ãƒ«ã‚·ã‚¢|ã‚¦ã‚§ãƒ«ã‚·ã‚¢|Welcia/i, name: 'ã‚¦ã‚¨ãƒ«ã‚·ã‚¢' },
          { pattern: /ã‚¹ã‚®è–¬å±€/i, name: 'ã‚¹ã‚®è–¬å±€' },

          // ãƒ•ã‚¡ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰
          { pattern: /ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰|McDonald|ãƒãƒƒã‚¯/i, name: 'ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰' },
          { pattern: /å‰é‡å®¶/i, name: 'å‰é‡å®¶' },
          { pattern: /ã™ãå®¶/i, name: 'ã™ãå®¶' },
          { pattern: /æ¾å±‹/i, name: 'æ¾å±‹' },

          // ã‚«ãƒ•ã‚§
          { pattern: /ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹|ã‚¹ã‚¿ãƒ|STARBUCKS|Starbucks/i, name: 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹' },
          { pattern: /ãƒ‰ãƒˆãƒ¼ãƒ«|DOUTOR/i, name: 'ãƒ‰ãƒˆãƒ¼ãƒ«ã‚³ãƒ¼ãƒ’ãƒ¼' },

          // ãã®ä»–
          { pattern: /ãƒ‰ãƒ³ãƒ»?ã‚­ãƒ›ãƒ¼ãƒ†|ãƒ‰ãƒ³ã‚­/i, name: 'ãƒ‰ãƒ³ãƒ»ã‚­ãƒ›ãƒ¼ãƒ†' },
          { pattern: /Amazon|ã‚¢ãƒã‚¾ãƒ³|amazon|AMAZON/i, name: 'Amazon' },
          { pattern: /æ¥½å¤©|Rakuten/i, name: 'æ¥½å¤©å¸‚å ´' }
        ];

        // æ—¢çŸ¥ã®åº—èˆ—åã‚’æ¤œç´¢ã—ã¦çµ±ä¸€ã•ã‚ŒãŸåå‰ã‚’è¿”ã™
        for (const vendor of knownVendors) {
          if (text.match(vendor.pattern)) {
            extractedVendor = vendor.name;
            break;
          }
        }

        // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€æœ€åˆã®è¡Œã‚„ã€Œæ ªå¼ä¼šç¤¾ã€ã€Œæœ‰é™ä¼šç¤¾ã€ã‚’å«ã‚€è¡Œã‚’æ¢ã™
        if (!extractedVendor) {
          const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);

          // æœ€åˆã®10è¡Œã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆç¯„å›²ã‚’æ‹¡å¤§ï¼‰
          for (let i = 0; i < Math.min(lines.length, 10); i++) {
            const line = lines[i];

            // é™¤å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆã“ã‚Œã‚‰ã‚’å«ã‚€è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
            const skipPatterns = [
              /^[0-9ï¼-ï¼™]+$/, // æ•°å­—ã®ã¿ã®è¡Œ
              /^\d{4}[-/å¹´]\d{1,2}[-/æœˆ]\d{1,2}/, // æ—¥ä»˜ã§å§‹ã¾ã‚‹è¡Œ
              /^(é ˜å|ãƒ¬ã‚·ãƒ¼ãƒˆ|æ˜ç´°|ç´å“|è«‹æ±‚|åˆè¨ˆ|å°è¨ˆ|ç¨è¾¼|ç¨æŠœ|ç¾é‡‘|ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ|ãŠé ã‚Š|ãŠé‡£ã‚Š|ãƒã‚¤ãƒ³ãƒˆ|å‰²å¼•|å€¤å¼•|TEL|FAX|é›»è©±|ä½æ‰€|ã€’)/,
              /[Â¥ï¿¥ï¼„$]\s*[0-9,ï¼-ï¼™ï¼Œ]+/, // é‡‘é¡ã‚’å«ã‚€
              /^\d+[:ï¼šæ™‚]\d+[:ï¼šåˆ†]/, // æ™‚åˆ»
              /^www\.|@|\.com|\.jp|\.co\.jp/, // URL/ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
            ];

            let shouldSkip = false;
            for (const pattern of skipPatterns) {
              if (line.match(pattern)) {
                shouldSkip = true;
                break;
              }
            }
            if (shouldSkip) continue;

            // ä¼šç¤¾åã®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆå„ªå…ˆåº¦é«˜ï¼‰
            if (line.match(/(æ ªå¼ä¼šç¤¾|æœ‰é™ä¼šç¤¾|åˆåŒä¼šç¤¾|\(æ ª\)|\(æœ‰\))/)) {
              extractedVendor = line
                .replace(/^\*+|\*+$/g, '')
                .replace(/^-+|-+$/g, '')
                .replace(/TEL[:ï¼š].*$/i, '')
                .replace(/ã€’\d{3}-\d{4}.*$/i, '')
                .trim();

              if (extractedVendor.length > 30) {
                extractedVendor = extractedVendor.substring(0, 30);
              }
              break;
            }

            // åº—èˆ—ã‚’ç¤ºã™ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆå„ªå…ˆåº¦ä¸­ï¼‰
            if (line.match(/(åº—|ã‚¹ãƒˆã‚¢|ãƒãƒ¼ãƒˆ|ã‚»ãƒ³ã‚¿ãƒ¼|ã‚·ãƒ§ãƒƒãƒ—|ã‚µãƒ¼ãƒ“ã‚¹)/) && line.length < 30) {
              extractedVendor = line
                .replace(/^\*+|\*+$/g, '')
                .replace(/^-+|-+$/g, '')
                .trim();
              break;
            }

            // 2æ–‡å­—ä»¥ä¸Š20æ–‡å­—ä»¥ä¸‹ã®è¡Œï¼ˆå„ªå…ˆåº¦ä½ï¼‰- æœ€åˆã®å€™è£œã¨ã—ã¦ä¿å­˜
            if (!extractedVendor && line.length >= 2 && line.length <= 20) {
              // ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã‚„æ—¥æœ¬èªãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
              if (line.match(/[a-zA-Zã-ã‚“ã‚¡-ãƒ¶ãƒ¼ä¸€-é¾ ]/)) {
                extractedVendor = line;
                // ã¾ã ç¶šã‘ã¦ã€ã‚ˆã‚Šè‰¯ã„å€™è£œã‚’æ¢ã™
              }
            }
          }

          // æŠ½å‡ºã—ãŸåº—èˆ—åã‚‚æ­£è¦åŒ–ã™ã‚‹
          if (extractedVendor) {
            extractedVendor = normalizeVendorName(extractedVendor);
          }
        }

        return extractedVendor;
      };

      // Google Cloud Vision APIã‚’ä½¿ã£ã¦ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒã‹ã‚‰OCRå‡¦ç†ã§æƒ…å ±ã‚’æŠ½å‡º
      const extractReceiptData = async (imageDataUrl) => {
        if (!visionApiKey) {
          alert('Google Cloud Vision APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nè¨­å®šç”»é¢ã‹ã‚‰è¨­å®šã—ã¦ãã ã•ã„ã€‚');
          return null;
        }

        try {
          setIsProcessingOCR(true);

          // Base64ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™ï¼ˆdata:image/...;base64,ã‚’é™¤ãï¼‰
          const base64Image = imageDataUrl.split(',')[1];

          // Vision API ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
          const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${visionApiKey}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              requests: [{
                image: {
                  content: base64Image
                },
                features: [{
                  type: 'DOCUMENT_TEXT_DETECTION',
                  maxResults: 1
                }]
              }]
            })
          });

          if (!response.ok) {
            throw new Error('Vision API ã‚¨ãƒ©ãƒ¼: ' + response.statusText);
          }

          const data = await response.json();

          if (data.error) {
            throw new Error(data.error.message);
          }

          const text = data.responses[0]?.fullTextAnnotation?.text || '';
          console.log('OCR Result:', text);

          if (!text) {
            alert('ç”»åƒã‹ã‚‰æ–‡å­—ã‚’èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
            return null;
          }

          // æ—¥ä»˜ã‚’æŠ½å‡ºï¼ˆæ§˜ã€…ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¯¾å¿œï¼‰
          const datePatterns = [
            // å®Œå…¨ãªæ—¥ä»˜ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆå¹´æœˆæ—¥ï¼‰
            /(\d{4})[\/å¹´\-\.](\d{1,2})[\/æœˆ\-\.](\d{1,2})[æ—¥]?/,
            /(\d{4})\s*[\/å¹´\-\.]\s*(\d{1,2})\s*[\/æœˆ\-\.]\s*(\d{1,2})[æ—¥]?/,  // ã‚¹ãƒšãƒ¼ã‚¹å«ã‚€
            /ä»¤å’Œ\s*(\d+)\s*å¹´\s*(\d{1,2})\s*æœˆ\s*(\d{1,2})\s*æ—¥/,
            /R\s*(\d+)\s*[\.\/\-]\s*(\d{1,2})\s*[\.\/\-]\s*(\d{1,2})/,  // R6.11.14 å½¢å¼ï¼ˆã‚¹ãƒšãƒ¼ã‚¹å«ã‚€ï¼‰
            /ä»¤\s*å’Œ\s*(\d+)\s*[\.\/\-]\s*(\d{1,2})\s*[\.\/\-]\s*(\d{1,2})/,  // ä»¤å’Œã®åˆ¥è¡¨è¨˜
            /H\s*(\d+)\s*[\.\/\-]\s*(\d{1,2})\s*[\.\/\-]\s*(\d{1,2})/,  // å¹³æˆ

            // 2æ¡å¹´ã®æ—¥ä»˜ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ'24å¹´ãªã©ï¼‰
            /'(\d{2})[\/å¹´\-\.](\d{1,2})[\/æœˆ\-\.](\d{1,2})[æ—¥]?/,
            /(\d{2})[\/å¹´](\d{1,2})[\/æœˆ](\d{1,2})[æ—¥]?/,

            // æœˆæ—¥ã®ã¿ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
            /(\d{1,2})[\/æœˆ\-\.](\d{1,2})[æ—¥]?(?!\d)/,  // å¾Œã‚ã«æ•°å­—ãŒç¶šã‹ãªã„
            /(\d{1,2})\s*[\/æœˆ\-\.]\s*(\d{1,2})[æ—¥]?(?!\d)/,  // ã‚¹ãƒšãƒ¼ã‚¹å«ã‚€

            // æ—¥ä»˜ã¨æ™‚åˆ»ãŒä¸€ç·’ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆæ—¥ä»˜éƒ¨åˆ†ã®ã¿æŠ½å‡ºï¼‰
            /(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})\s+\d{1,2}:\d{2}/,
            /(\d{1,2})[\/\-\.](\d{1,2})\s+\d{1,2}:\d{2}/,

            // ãã®ä»–ã®å½¢å¼
            /(\d{4})(\d{2})(\d{2})/,  // 20241114å½¢å¼ï¼ˆ8æ¡é€£ç¶šï¼‰
            /(\d{2})(\d{2})(\d{2})/  // 241114å½¢å¼ï¼ˆ6æ¡é€£ç¶šï¼‰
          ];

          let extractedDate = null;

          // å…¨ã¦ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è©¦ã™
          for (const pattern of datePatterns) {
            const matches = text.matchAll(new RegExp(pattern, 'g'));
            for (const match of matches) {
              let year, month, day;

              // ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¿œã˜ã¦å¹´æœˆæ—¥ã‚’æŠ½å‡º
              if (match[0].includes('ä»¤å’Œ') || match[0].includes('ä»¤') || match[0].toUpperCase().startsWith('R')) {
                // ä»¤å’Œã®å ´åˆã¯è¥¿æš¦ã«å¤‰æ›
                const reiwaYear = parseInt(match[1]);
                year = 2018 + reiwaYear;
                month = parseInt(match[2]);
                day = parseInt(match[3]);
              } else if (match[0].toUpperCase().startsWith('H')) {
                // å¹³æˆã®å ´åˆã¯è¥¿æš¦ã«å¤‰æ›
                const heiseiYear = parseInt(match[1]);
                year = 1988 + heiseiYear;
                month = parseInt(match[2]);
                day = parseInt(match[3]);
              } else if (match[1] && match[1].length === 4) {
                // 4æ¡ã®è¥¿æš¦
                year = parseInt(match[1]);
                month = parseInt(match[2]);
                day = parseInt(match[3]);
              } else if (match[1] && match[1].length === 2 && match[0].startsWith("'")) {
                // '24å½¢å¼ã®2æ¡å¹´
                year = 2000 + parseInt(match[1]);
                month = parseInt(match[2]);
                day = parseInt(match[3]);
              } else if (match[1] && match[1].length === 2 && !match[3]) {
                // æœˆæ—¥ã®ã¿ï¼ˆMM/DDï¼‰
                const currentDate = new Date();
                year = currentDate.getFullYear();
                month = parseInt(match[1]);
                day = parseInt(match[2]);

                // æœªæ¥ã®æ—¥ä»˜ã®å ´åˆã¯å‰å¹´ã¨ã™ã‚‹
                const checkDate = new Date(year, month - 1, day);
                if (checkDate > currentDate) {
                  year--;
                }
              } else if (match[1] && match[1].length === 2 && match[3]) {
                // YY/MM/DDå½¢å¼
                const yy = parseInt(match[1]);
                // 50ä»¥ä¸‹ã¯20XXå¹´ã€51ä»¥ä¸Šã¯19XXå¹´ã¨åˆ¤æ–­
                year = yy <= 50 ? 2000 + yy : 1900 + yy;
                month = parseInt(match[2]);
                day = parseInt(match[3]);
              } else if (match[1] && (match[1].length === 6 || match[1].length === 8)) {
                // é€£ç¶šæ•°å­—å½¢å¼
                if (match[1].length === 8) {
                  // YYYYMMDD
                  year = parseInt(match[1]);
                  month = parseInt(match[2]);
                  day = parseInt(match[3]);
                } else {
                  // YYMMDD
                  const yy = parseInt(match[1]);
                  year = yy <= 50 ? 2000 + yy : 1900 + yy;
                  month = parseInt(match[2]);
                  day = parseInt(match[3]);
                }
              } else {
                continue;
              }

              // å¦¥å½“ãªæ—¥ä»˜ã‹ãƒã‚§ãƒƒã‚¯
              if (month >= 1 && month <= 12 && day >= 1 && day <= 31 && year >= 2020 && year <= 2030) {
                extractedDate = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                break;
              }
            }

            if (extractedDate) break;
          }

          // é‡‘é¡ã‚’æŠ½å‡ºï¼ˆÂ¥è¨˜å·ã€å††ã€åˆè¨ˆãªã©ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¢ã™ï¼‰
          const amountPatterns = [
            /åˆè¨ˆ[\sã€€]*[Â¥ï¿¥]?([0-9,]+)/,
            /å°è¨ˆ[\sã€€]*[Â¥ï¿¥]?([0-9,]+)/,
            /ç¨è¾¼[\sã€€]*[Â¥ï¿¥]?([0-9,]+)/,
            /ãŠæ”¯æ‰•[\sã€€]*[Â¥ï¿¥]?([0-9,]+)/,
            /[Â¥ï¿¥]([0-9,]+)/,
            /([0-9,]+)å††/,
            /è¨ˆ[\sã€€]*([0-9,]+)/
          ];

          let extractedAmount = null;
          let maxAmount = 0;

          // å„ãƒ‘ã‚¿ãƒ¼ãƒ³ã§æœ€å¤§é‡‘é¡ã‚’æ¢ã™
          for (const pattern of amountPatterns) {
            const matches = text.matchAll(new RegExp(pattern, 'g'));
            for (const match of matches) {
              const amount = parseInt(match[1].replace(/,/g, ''));
              if (amount > maxAmount && amount < 1000000) { // 100ä¸‡å††æœªæº€ã‚’æœ‰åŠ¹ã¨ã™ã‚‹
                maxAmount = amount;
                extractedAmount = amount;
              }
            }
          }

          // ã‚¬ã‚½ãƒªãƒ³é–¢é€£ã®ãƒ¬ã‚·ãƒ¼ãƒˆã‹ãƒã‚§ãƒƒã‚¯ã—ã¦ã€ã‚¬ã‚½ãƒªãƒ³ã®å ´åˆã®ã¿å“åã‚’è‡ªå‹•å…¥åŠ›
          let itemDescription = '';
          let suggestedAccountingSubject = null;

          const isGasoline = text.match(/(ã‚¬ã‚½ãƒªãƒ³|çµ¦æ²¹|è»½æ²¹|ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼|ãƒã‚¤ã‚ªã‚¯|ENEOS|å‡ºå…‰|æ˜­å’Œã‚·ã‚§ãƒ«|ã‚³ã‚¹ãƒ¢çŸ³æ²¹|ã‚¨ãƒƒã‚½|ãƒ¢ãƒ¼ãƒ“ãƒ«)/i);

          if (isGasoline) {
            // ã‚¬ã‚½ãƒªãƒ³ã®å ´åˆã®ã¿ç‰¹åˆ¥å‡¦ç†
            let gasolineType = '';
            let liters = 0;

            // ã‚¬ã‚½ãƒªãƒ³ã®ç¨®é¡ã‚’åˆ¤å®š
            if (text.match(/ãƒã‚¤ã‚ªã‚¯|ãƒã‚¤ã‚ªã‚¯ã‚¿ãƒ³|HIGH|ãƒ—ãƒ¬ãƒŸã‚¢ãƒ /i)) {
              gasolineType = 'ãƒã‚¤ã‚ªã‚¯';
            } else if (text.match(/è»½æ²¹|ãƒ‡ã‚£ãƒ¼ã‚¼ãƒ«|DIESEL/i)) {
              gasolineType = 'è»½æ²¹';
            } else if (text.match(/ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼|REGULAR|ã‚¬ã‚½ãƒªãƒ³/i)) {
              gasolineType = 'ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼';
            }

            // ãƒªãƒƒã‚¿ãƒ¼æ•°ã‚’æ¢ã™ï¼ˆè¤‡æ•°ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¯¾å¿œï¼‰
            const literPatterns = [
              /(\d+\.?\d*)\s*[Lâ„“ãƒªãƒƒãƒˆãƒ«]/i,
              /æ•°é‡\s*[:ï¼š]\s*(\d+\.?\d*)/i,
              /çµ¦æ²¹é‡\s*[:ï¼š]?\s*(\d+\.?\d*)/i,
              /(\d+\.?\d*)\s*L/i,
              /(\d{2,3}\.?\d*)\s*@/i  // å˜ä¾¡ã®å‰ã®æ•°é‡
            ];

            for (const pattern of literPatterns) {
              const match = text.match(pattern);
              if (match) {
                liters = parseFloat(match[1]);
                if (liters > 0 && liters < 200) {  // å¦¥å½“ãªç¯„å›²ã®ãƒªãƒƒã‚¿ãƒ¼æ•°
                  break;
                }
              }
            }

            // ãƒªãƒƒã‚¿ãƒ¼æ•°ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€é‡‘é¡ã‹ã‚‰æ¨å®šã‚’è©¦ã¿ã‚‹
            if (liters === 0 && extractedAmount > 0) {
              // å˜ä¾¡ã‚’æ¢ã™ï¼ˆ150-200å††/Lç¨‹åº¦ã‚’æƒ³å®šï¼‰
              const priceMatch = text.match(/@\s*(\d+)/i);
              if (priceMatch) {
                const unitPrice = parseInt(priceMatch[1]);
                if (unitPrice > 100 && unitPrice < 300) {
                  liters = Math.round(extractedAmount / unitPrice * 10) / 10;
                }
              }
            }

            // ã‚¬ã‚½ãƒªãƒ³ã®å½¢å¼ã§å‡ºåŠ›
            if (gasolineType && liters > 0) {
              itemDescription = `${gasolineType}${liters}L`;
            } else if (gasolineType) {
              itemDescription = `${gasolineType}${liters}L`;
            }

            // ã‚¬ã‚½ãƒªãƒ³ã®å ´åˆã¯å€Ÿæ–¹ç§‘ç›®ã‚’æ—…è²»äº¤é€šè²»ã«è¨­å®š
            suggestedAccountingSubject = 'travel';
          }

          // ã‚¬ã‚½ãƒªãƒ³ä»¥å¤–ã¯å“åã‚’ç©ºã«ã™ã‚‹ï¼ˆæ—¥ä»˜ã¨é‡‘é¡ã®ã¿è‡ªå‹•å…¥åŠ›ï¼‰

          // åº—èˆ—åï¼ˆå–å¼•å…ˆï¼‰ã‚’æŠ½å‡º
          const extractedVendor = extractVendorFromText(text);

          // æ”¯æ‰•æ–¹æ³•ã‚’æ¤œå‡º
          let paymentMethod = null;

          // ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰æ±ºæ¸ˆã®æ¤œå‡º
          const isCreditCard = text.match(/(ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ|ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰|CREDIT|VISA|MasterCard|MASTER|JCB|AMEX|American Express|Diners|ãƒ€ã‚¤ãƒŠãƒ¼ã‚¹|\*{4}\s*\*{4}\s*\*{4}\s*\d{4})/i);

          // ç¾é‡‘æ±ºæ¸ˆã®æ¤œå‡º
          const isCash = text.match(/(ç¾é‡‘|CASH|ãŠé ã‹ã‚Š|ãŠé ã‚Š|ãŠé‡£ã‚Š|ãŠã¤ã‚Š|é‡£éŠ­|é‡£ã‚ŠéŠ­)/i);

          // é›»å­ãƒãƒãƒ¼ãƒ»ãã®ä»–ã®æ±ºæ¸ˆ
          const isElectronic = text.match(/(é›»å­ãƒãƒãƒ¼|äº¤é€šç³»IC|Suica|PASMO|ICOCA|QRã‚³ãƒ¼ãƒ‰|PayPay|LINE\s*Pay|æ¥½å¤©Pay|dæ‰•ã„|au\s*PAY|ãƒ¡ãƒ«ãƒšã‚¤|nanaco|WAON|Edy)/i);

          if (isCreditCard && !isCash) {
            paymentMethod = 'credit';  // ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ
          } else if (isCash && !isCreditCard) {
            paymentMethod = 'cash';  // ç¾é‡‘
          } else if (isElectronic) {
            paymentMethod = 'cash';  // é›»å­ãƒãƒãƒ¼ã‚‚ç¾é‡‘æ‰±ã„ï¼ˆäº‹å‰ãƒãƒ£ãƒ¼ã‚¸ã®ãŸã‚ï¼‰
          }
          // ã©ã¡ã‚‰ã‚‚æ¤œå‡ºã•ã‚Œãªã„ã€ã¾ãŸã¯ä¸¡æ–¹æ¤œå‡ºã•ã‚ŒãŸå ´åˆã¯nullï¼ˆæ‰‹å‹•é¸æŠï¼‰

          return {
            date: extractedDate || formatDateToLocal(new Date()),
            amount: extractedAmount || 0,
            itemName: itemDescription,
            accountingSubject: suggestedAccountingSubject,
            paymentMethod: paymentMethod,
            vendor: extractedVendor, // å–å¼•å…ˆã‚’è¿½åŠ 
            fullText: text
          };
        } catch (error) {
          console.error('OCRå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
          alert('OCRå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
          return null;
        } finally {
          setIsProcessingOCR(false);
        }
      };

      // Load expenses from Supabase
      const loadExpenses = async () => {
        if (!session?.user?.id) {
          setExpensesLoading(false);
          return;
        }

        try {
          const { data, error } = await supabaseClient
            .from('expenses')
            .select('*')
            .eq('user_id', session.user.id);

          if (error) throw error;

          // Convert Supabase format to local format
          const expensesMap = {};
          for (const expense of data || []) {
            expensesMap[expense.id] = {
              date: expense.date,
              amount: expense.amount,
              businessPercentage: expense.business_percentage,
              accountingSubject: expense.accounting_subject || '',
              creditAccount: expense.credit_account || '',
              photo: expense.photo_url || null,
              memo: expense.memo || expense.description || '',
              vendor: expense.vendor || '',
              uploadedAt: expense.uploaded_at,
              isLocked: expense.is_locked || false,
              lockedAt: expense.locked_at,
              originalHash: expense.original_hash
            };
          }
          setExpenses(expensesMap);
        } catch (error) {
          console.error('Error loading expenses:', error);
        } finally {
          setExpensesLoading(false);
        }
      };

      useEffect(() => {
        loadExpenses();
      }, [session?.user?.id]);

      // Load user settings from Supabase
      useEffect(() => {
        const loadSettings = async () => {
          if (!session?.user?.id) {
            setSettingsLoading(false);
            return;
          }

          try {
            const { data, error } = await supabaseClient
              .from('user_settings')
              .select('*')
              .eq('user_id', session.user.id)
              .single();

            if (error && error.code !== 'PGRST116') {
              // PGRST116 = no rows returned (åˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚)
              throw error;
            }

            if (data) {
              // Supabaseã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯èª­ã¿è¾¼ã¿
              setWeekdayAvgPrice(data.weekday_avg_price || 400);
              setWeekendAvgPrice(data.weekend_avg_price || 400);
              setWeekdayDeliveriesPerHour(data.weekday_deliveries_per_hour || 4);
              setWeekendDeliveriesPerHour(data.weekend_deliveries_per_hour || 4);
              setUseAutoCalculate(data.use_auto_calculate || false);

              // Vision APIã‚­ãƒ¼ã‚’Supabaseã‹ã‚‰èª­ã¿è¾¼ã¿
              if (data.vision_api_key) {
                setVisionApiKey(data.vision_api_key);
                localStorage.setItem('visionApiKey', data.vision_api_key); // localStorageã«ã‚‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥
              }
              setWeekdayQuests(data.weekday_quests || [
                { count: 10, reward: 0 },
                { count: 10, reward: 0 },
                { count: 10, reward: 0 },
                { count: 10, reward: 0 },
                { count: 10, reward: 0 }
              ]);
              setWeekendQuests(data.weekend_quests || [
                { count: 10, reward: 0 },
                { count: 10, reward: 0 },
                { count: 10, reward: 0 },
                { count: 10, reward: 0 },
                { count: 10, reward: 0 }
              ]);
              setTargetAmount(data.target_amount || 0);

              // ä»Šé€±ã®æœˆæ›œæ—¥ã‚’è‡ªå‹•è¨­å®š
              const today = new Date();
              const dayOfWeek = today.getDay(); // 0=æ—¥, 1=æœˆ, ..., 6=åœŸ
              const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // æœˆæ›œæ—¥ã¾ã§ã®å·®åˆ†
              const thisMonday = new Date(today);
              thisMonday.setDate(today.getDate() + diff);
              const thisMondayStr = formatDateToLocal(thisMonday);

              // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®é€±ã¨ä»Šé€±ãŒé•ã†å ´åˆã€ã¾ãŸã¯é€±ãŒæœªè¨­å®šã®å ´åˆ
              if (data.current_week_start !== thisMondayStr) {
                // æ–°ã—ã„é€±ãªã®ã§hoursã‚’ã‚¯ãƒªã‚¢
                setHours({
                  æœˆ: { hours: 0, deliveries: 0, earnings: 0 },
                  ç«: { hours: 0, deliveries: 0, earnings: 0 },
                  æ°´: { hours: 0, deliveries: 0, earnings: 0 },
                  æœ¨: { hours: 0, deliveries: 0, earnings: 0 },
                  é‡‘: { hours: 0, deliveries: 0, earnings: 0 },
                  åœŸ: { hours: 0, deliveries: 0, earnings: 0 },
                  æ—¥: { hours: 0, deliveries: 0, earnings: 0 }
                });
                setCurrentWeekStart(thisMondayStr);
              } else {
                // åŒã˜é€±ãªã‚‰hoursã‚’èª­ã¿è¾¼ã‚€
                setHours(data.hours || {
                  æœˆ: { hours: 0, deliveries: 0, earnings: 0 },
                  ç«: { hours: 0, deliveries: 0, earnings: 0 },
                  æ°´: { hours: 0, deliveries: 0, earnings: 0 },
                  æœ¨: { hours: 0, deliveries: 0, earnings: 0 },
                  é‡‘: { hours: 0, deliveries: 0, earnings: 0 },
                  åœŸ: { hours: 0, deliveries: 0, earnings: 0 },
                  æ—¥: { hours: 0, deliveries: 0, earnings: 0 }
                });
                setCurrentWeekStart(data.current_week_start);
              }
            } else {
              // Supabaseã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ã€localStorageã‹ã‚‰ç§»è¡Œ
              const migratedFromLocalStorage = localStorage.getItem('migrated_to_supabase');
              if (!migratedFromLocalStorage) {
                const localWeekdayAvgPrice = loadFromStorage('weekdayAvgPrice', null);
                const localWeekendAvgPrice = loadFromStorage('weekendAvgPrice', null);
                const localWeekdayDeliveries = loadFromStorage('weekdayDeliveriesPerHour', null);
                const localWeekendDeliveries = loadFromStorage('weekendDeliveriesPerHour', null);
                const localUseAuto = loadFromStorage('useAutoCalculate', null);
                const localWeekdayQuests = loadFromStorage('weekdayQuests', null);
                const localWeekendQuests = loadFromStorage('weekendQuests', null);
                const localTarget = loadFromStorage('targetAmount', null);
                const localWeekStart = loadFromStorage('currentWeekStart', null);
                const localHours = loadFromStorage('hours', null);

                if (localWeekdayAvgPrice !== null || localWeekdayQuests !== null) {
                  // localStorageã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ç§»è¡Œ

                  setWeekdayAvgPrice(localWeekdayAvgPrice || 400);
                  setWeekendAvgPrice(localWeekendAvgPrice || 400);
                  setWeekdayDeliveriesPerHour(localWeekdayDeliveries || 4);
                  setWeekendDeliveriesPerHour(localWeekendDeliveries || 4);
                  setUseAutoCalculate(localUseAuto || false);
                  setWeekdayQuests(localWeekdayQuests || [
                    { count: 10, reward: 0 },
                    { count: 10, reward: 0 },
                    { count: 10, reward: 0 },
                    { count: 10, reward: 0 },
                    { count: 10, reward: 0 }
                  ]);
                  setWeekendQuests(localWeekendQuests || [
                    { count: 10, reward: 0 },
                    { count: 10, reward: 0 },
                    { count: 10, reward: 0 },
                    { count: 10, reward: 0 },
                    { count: 10, reward: 0 }
                  ]);
                  setTargetAmount(localTarget || 0);

                  // ä»Šé€±ã®æœˆæ›œæ—¥ã‚’è‡ªå‹•è¨­å®š
                  const today = new Date();
                  const dayOfWeek = today.getDay();
                  const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                  const thisMonday = new Date(today);
                  thisMonday.setDate(today.getDate() + diff);
                  const thisMondayStr = formatDateToLocal(thisMonday);

                  if (localWeekStart !== thisMondayStr) {
                    // æ–°ã—ã„é€±ãªã®ã§hoursã‚’ã‚¯ãƒªã‚¢
                    setHours({
                      æœˆ: { hours: 0, deliveries: 0, earnings: 0 },
                      ç«: { hours: 0, deliveries: 0, earnings: 0 },
                      æ°´: { hours: 0, deliveries: 0, earnings: 0 },
                      æœ¨: { hours: 0, deliveries: 0, earnings: 0 },
                      é‡‘: { hours: 0, deliveries: 0, earnings: 0 },
                      åœŸ: { hours: 0, deliveries: 0, earnings: 0 },
                      æ—¥: { hours: 0, deliveries: 0, earnings: 0 }
                    });
                  } else if (localHours) {
                    // åŒã˜é€±ãªã‚‰localStorageã®hoursã‚’ç§»è¡Œ
                    setHours(localHours);
                  }
                  setCurrentWeekStart(thisMondayStr);

                  // Supabaseã«ä¿å­˜
                  await supabaseClient
                    .from('user_settings')
                    .upsert({
                      user_id: session.user.id,
                      weekday_avg_price: localWeekdayAvgPrice || 400,
                      weekend_avg_price: localWeekendAvgPrice || 400,
                      weekday_deliveries_per_hour: localWeekdayDeliveries || 4,
                      weekend_deliveries_per_hour: localWeekendDeliveries || 4,
                      use_auto_calculate: localUseAuto || false,
                      weekday_quests: localWeekdayQuests || [
                        { count: 10, reward: 0 },
                        { count: 10, reward: 0 },
                        { count: 10, reward: 0 },
                        { count: 10, reward: 0 },
                        { count: 10, reward: 0 }
                      ],
                      weekend_quests: localWeekendQuests || [
                        { count: 10, reward: 0 },
                        { count: 10, reward: 0 },
                        { count: 10, reward: 0 },
                        { count: 10, reward: 0 },
                        { count: 10, reward: 0 }
                      ],
                      target_amount: localTarget || 0,
                      current_week_start: thisMondayStr,
                      hours: (localWeekStart === thisMondayStr && localHours) ? localHours : {
                        æœˆ: { hours: 0, deliveries: 0, earnings: 0 },
                        ç«: { hours: 0, deliveries: 0, earnings: 0 },
                        æ°´: { hours: 0, deliveries: 0, earnings: 0 },
                        æœ¨: { hours: 0, deliveries: 0, earnings: 0 },
                        é‡‘: { hours: 0, deliveries: 0, earnings: 0 },
                        åœŸ: { hours: 0, deliveries: 0, earnings: 0 },
                        æ—¥: { hours: 0, deliveries: 0, earnings: 0 }
                      }
                    }, {
                      onConflict: 'user_id'
                    });

                  localStorage.setItem('migrated_to_supabase', 'true');
                  alert('localStorageã®ãƒ‡ãƒ¼ã‚¿ã‚’Supabaseã«ç§»è¡Œã—ã¾ã—ãŸï¼');
                } else {
                  // ãƒ‡ãƒ¼ã‚¿ãŒã¾ã£ãŸããªã„å ´åˆï¼ˆåˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ï¼‰
                  const today = new Date();
                  const dayOfWeek = today.getDay();
                  const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                  const thisMonday = new Date(today);
                  thisMonday.setDate(today.getDate() + diff);
                  const thisMondayStr = formatDateToLocal(thisMonday);
                  setCurrentWeekStart(thisMondayStr);
                }
              }
            }
          } catch (error) {
            console.error('Error loading settings:', error);
          } finally {
            setSettingsLoading(false);
          }
        };

        loadSettings();
      }, [session?.user?.id]);

      // Load daily data from Supabase
      useEffect(() => {
        const loadDailyData = async () => {
          if (!session?.user?.id) {
            setDailyDataLoading(false);
            return;
          }

          try {
            const { data, error } = await supabaseClient
              .from('daily_records')
              .select('*')
              .eq('user_id', session.user.id);

            if (error) throw error;

            // Convert Supabase format to local format
            const dailyDataMap = {};
            for (const record of data || []) {
              dailyDataMap[record.date] = {
                hours: record.hours,
                deliveries: record.deliveries,
                earnings: record.earnings,
                quest: record.quest,
                isRainy: record.is_rainy,
                isHoliday: record.is_holiday
              };
            }

            // localStorageã‹ã‚‰ã®ç§»è¡Œï¼ˆSupabaseã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆï¼‰
            const migratedDailyData = localStorage.getItem('migrated_daily_data_to_supabase');
            if (!migratedDailyData && data.length === 0) {
              const localDailyData = loadFromStorage('dailyData', null);
              if (localDailyData && Object.keys(localDailyData).length > 0) {
                console.log('Migrating daily data from localStorage to Supabase...');

                // localStorageã®ãƒ‡ãƒ¼ã‚¿ã‚’Supabaseã«ç§»è¡Œ
                const recordsToInsert = [];
                for (const [date, record] of Object.entries(localDailyData)) {
                  recordsToInsert.push({
                    user_id: session.user.id,
                    date,
                    hours: record.hours || 0,
                    deliveries: record.deliveries || 0,
                    earnings: record.earnings || 0,
                    quest: record.quest || 0,
                    is_rainy: record.isRainy || false,
                    is_holiday: record.isHoliday || false
                  });
                }

                if (recordsToInsert.length > 0) {
                  await supabaseClient
                    .from('daily_records')
                    .upsert(recordsToInsert, {
                      onConflict: 'user_id,date'
                    });

                  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒ†ãƒ¼ãƒˆã«è¨­å®š
                  setDailyData(localDailyData);

                  localStorage.setItem('migrated_daily_data_to_supabase', 'true');
                  console.log(`Migrated ${recordsToInsert.length} daily records to Supabase`);
                }
              }
            } else {
              setDailyData(dailyDataMap);
            }
          } catch (error) {
            console.error('Error loading daily data:', error);
          } finally {
            setDailyDataLoading(false);
          }
        };

        loadDailyData();
      }, [session?.user?.id]);

      // æ—¥ä»˜ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã§YYYY-MM-DDå½¢å¼ã«å¤‰æ›
      const formatDateToLocal = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };

      // å±¥æ­´ã‹ã‚‰å¹³å‡å€¤ã‚’è¨ˆç®—ï¼ˆæœˆï½æœ¨ã¨é‡‘ï½æ—¥ã§åˆ†ã‘ã‚‹ï¼‰
      // é›¨ã®æ—¥ã¨ç¥æ—¥ã¯é™¤å¤–ã—ã¦è¨ˆç®—ã—ã€åˆ¥é€”å¹³å‡æ™‚çµ¦ã‚’ç®—å‡º
      const calculateFromHistory = () => {
        const allEntries = Object.entries(dailyData);
        if (allEntries.length === 0) {
          return {
            weekdayAvgPrice: 400,
            weekendAvgPrice: 400,
            weekdayDeliveriesPerHour: 4,
            weekendDeliveriesPerHour: 4,
            weekdayQuestPerHour: 0,
            weekendQuestPerHour: 0,
            rainyAvgHourlyWage: 0,
            holidayAvgHourlyWage: 0
          };
        }

        let weekdayHours = 0;
        let weekdayDeliveries = 0;
        let weekdayEarnings = 0;
        let weekdayQuest = 0;

        let weekendHours = 0;
        let weekendDeliveries = 0;
        let weekendEarnings = 0;
        let weekendQuest = 0;

        // é›¨ã®æ—¥ã¨ç¥æ—¥ã®å¹³å‡æ™‚çµ¦è¨ˆç®—ç”¨
        let rainyHours = 0;
        let rainyTotalEarnings = 0;
        let holidayHours = 0;
        let holidayTotalEarnings = 0;

        allEntries.forEach(([dateStr, data]) => {
          if (data.hours > 0 && data.deliveries > 0 && data.earnings > 0) {
            const totalEarnings = data.earnings + (data.quest || 0);

            // é›¨ã®æ—¥ã®å¹³å‡æ™‚çµ¦ã‚’è¨ˆç®—
            if (data.isRainy) {
              rainyHours += data.hours;
              rainyTotalEarnings += totalEarnings;
              return; // é€šå¸¸ã®å¹³å‡è¨ˆç®—ã‹ã‚‰ã¯é™¤å¤–
            }

            // ç¥æ—¥ã®å¹³å‡æ™‚çµ¦ã‚’è¨ˆç®—
            if (data.isHoliday) {
              holidayHours += data.hours;
              holidayTotalEarnings += totalEarnings;
              return; // é€šå¸¸ã®å¹³å‡è¨ˆç®—ã‹ã‚‰ã¯é™¤å¤–
            }

            // é€šå¸¸æ—¥ã®è¨ˆç®—
            const date = new Date(dateStr + 'T00:00:00');
            const dayOfWeek = date.getDay(); // 0=æ—¥, 1=æœˆ, 2=ç«, ..., 6=åœŸ

            // æœˆ(1)ï½æœ¨(4) = weekday, é‡‘(5)ï½æ—¥(0,6) = weekend
            if (dayOfWeek >= 1 && dayOfWeek <= 4) {
              weekdayHours += data.hours;
              weekdayDeliveries += data.deliveries;
              weekdayEarnings += data.earnings;
              weekdayQuest += data.quest || 0;
            } else {
              weekendHours += data.hours;
              weekendDeliveries += data.deliveries;
              weekendEarnings += data.earnings;
              weekendQuest += data.quest || 0;
            }
          }
        });

        // é›¨ã®æ—¥ã¨ç¥æ—¥ã®å¹³å‡å˜ä¾¡ã¨å¹³å‡ä»¶æ•°ã‚’è¨ˆç®—
        let rainyDeliveries = 0;
        let rainyEarnings = 0;
        let holidayDeliveries = 0;
        let holidayEarnings = 0;

        allEntries.forEach(([dateStr, data]) => {
          if (data.hours > 0 && data.deliveries > 0 && data.earnings > 0) {
            if (data.isRainy) {
              rainyDeliveries += data.deliveries;
              rainyEarnings += data.earnings;
            } else if (data.isHoliday) {
              holidayDeliveries += data.deliveries;
              holidayEarnings += data.earnings;
            }
          }
        });

        const rainyCount = allEntries.filter(([, data]) => data.isRainy && data.hours > 0).length;
        const holidayCount = allEntries.filter(([, data]) => data.isHoliday && data.hours > 0).length;

        return {
          weekdayAvgPrice: weekdayDeliveries > 0 ? Math.round(weekdayEarnings / weekdayDeliveries) : 400,
          weekendAvgPrice: weekendDeliveries > 0 ? Math.round(weekendEarnings / weekendDeliveries) : 400,
          weekdayDeliveriesPerHour: weekdayHours > 0 ? parseFloat((weekdayDeliveries / weekdayHours).toFixed(1)) : 4,
          weekendDeliveriesPerHour: weekendHours > 0 ? parseFloat((weekendDeliveries / weekendHours).toFixed(1)) : 4,
          weekdayQuestPerHour: weekdayHours > 0 ? Math.round(weekdayQuest / weekdayHours) : 0,
          weekendQuestPerHour: weekendHours > 0 ? Math.round(weekendQuest / weekendHours) : 0,
          rainyAvgHourlyWage: rainyHours > 0 ? Math.round(rainyTotalEarnings / rainyHours) : 0,
          holidayAvgHourlyWage: holidayHours > 0 ? Math.round(holidayTotalEarnings / holidayHours) : 0,
          rainyAvgPrice: rainyDeliveries > 0 ? Math.round(rainyEarnings / rainyDeliveries) : 0,
          rainyAvgDeliveries: rainyHours > 0 ? parseFloat((rainyDeliveries / rainyHours).toFixed(1)) : 0,
          holidayAvgPrice: holidayDeliveries > 0 ? Math.round(holidayEarnings / holidayDeliveries) : 0,
          holidayAvgDeliveries: holidayHours > 0 ? parseFloat((holidayDeliveries / holidayHours).toFixed(1)) : 0
        };
      };

      // ä½¿ç”¨ã™ã‚‹å¹³å‡å€¤ã‚’å–å¾—ï¼ˆè‡ªå‹•ç®—å‡º or æ‰‹å‹•å…¥åŠ›ï¼‰
      const getEffectiveValues = () => {
        if (useAutoCalculate) {
          return calculateFromHistory();
        }
        return {
          weekdayAvgPrice,
          weekendAvgPrice,
          weekdayDeliveriesPerHour,
          weekendDeliveriesPerHour,
          weekdayQuestPerHour: 0,
          weekendQuestPerHour: 0
        };
      };

      // Save settings to Supabase
      const saveSettings = async () => {
        if (!session?.user?.id) return;

        try {
          const { error } = await supabaseClient
            .from('user_settings')
            .upsert({
              user_id: session.user.id,
              weekday_avg_price: weekdayAvgPrice,
              weekend_avg_price: weekendAvgPrice,
              weekday_deliveries_per_hour: weekdayDeliveriesPerHour,
              weekend_deliveries_per_hour: weekendDeliveriesPerHour,
              use_auto_calculate: useAutoCalculate,
              weekday_quests: weekdayQuests,
              weekend_quests: weekendQuests,
              target_amount: targetAmount,
              current_week_start: currentWeekStart,
              hours: hours,
              vision_api_key: visionApiKey || null,
              updated_at: new Date().toISOString()
            }, {
              onConflict: 'user_id'
            });

          if (error) throw error;
        } catch (error) {
          console.error('Error saving settings:', error);
        }
      };

      // Auto-save settings when they change (debounced)
      useEffect(() => {
        if (settingsLoading) return;
        const timer = setTimeout(() => {
          saveSettings();
        }, 500);
        return () => clearTimeout(timer);
      }, [weekdayAvgPrice, weekendAvgPrice, weekdayDeliveriesPerHour, weekendDeliveriesPerHour,
          useAutoCalculate, weekdayQuests, weekendQuests, targetAmount, currentWeekStart, hours, settingsLoading]);

      // Keep these in localStorage
      useEffect(() => {
        if (typeof window !== 'undefined') {
          localStorage.setItem('historicalData', JSON.stringify(historicalData));
        }
      }, [historicalData]);

      useEffect(() => {
        if (typeof window !== 'undefined') {
          localStorage.setItem('lastAccessDate', JSON.stringify(lastAccessDate));
        }
      }, [lastAccessDate]);

      // Daily data and expenses are now saved to Supabase instead of localStorage
      // (removed automatic localStorage sync)

      // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºä¸­ã¯èƒŒæ™¯ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ–ã—ã€èƒŒæ™¯ã‚’å›ºå®š
      useEffect(() => {
        try {
          const isModalOpen = showBasicSettings || showQuestSettings || showCalendar || showTotalStats || showDayEdit || showExpenses || showExpenseInput || showExpenseFilter || showImagePreview || showBalanceSheet || showIncomeStatement;
          if (typeof document !== 'undefined' && document.body) {
            if (isModalOpen) {
              // bodyã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¨ä½ç½®ã‚’å›ºå®š
              document.body.style.overflow = 'hidden';
              document.body.style.position = 'fixed';
              document.body.style.width = '100%';
              document.body.style.top = '0';
            } else {
              // bodyã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹åŒ–
              document.body.style.overflow = '';
              document.body.style.position = '';
              document.body.style.width = '';
              document.body.style.top = '';
            }
          }
        } catch (error) {
          console.error('ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¶å¾¡ã‚¨ãƒ©ãƒ¼:', error);
        }
        return () => {
          try {
            if (typeof document !== 'undefined' && document.body) {
              document.body.style.overflow = '';
              document.body.style.position = '';
              document.body.style.width = '';
              document.body.style.top = '';
            }
          } catch (error) {
            console.error('ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è§£é™¤ã‚¨ãƒ©ãƒ¼:', error);
          }
        };
      }, [showBasicSettings, showQuestSettings, showCalendar, showTotalStats, showDayEdit, showExpenses, showExpenseInput, showExpenseFilter, showImagePreview, showBalanceSheet, showIncomeStatement]);

      // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã«bodyã®èƒŒæ™¯è‰²ã‚’è¨­å®š
      useEffect(() => {
        if (typeof document !== 'undefined' && document.body) {
          if (isDarkMode) {
            document.body.style.backgroundColor = '#1f2937'; // gray-800
          } else {
            document.body.style.backgroundColor = '';
          }
        }
        return () => {
          if (typeof document !== 'undefined' && document.body) {
            document.body.style.backgroundColor = '';
          }
        };
      }, [isDarkMode]);

      // é€±ã®ç¨¼åƒæ™‚é–“ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ã€ã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬ã‚’è¨ˆç®—ã—ã¦dailyDataï¼ˆè¡¨ç¤ºç”¨ï¼‰ã‚’æ›´æ–°
      useEffect(() => {
        if (!currentWeekStart || settingsLoading || dailyDataLoading) return;

        // ä½¿ç”¨ã™ã‚‹å¹³å‡å€¤ã‚’å–å¾—
        const effectiveValues = getEffectiveValues();

        setDailyData(prev => {
          const updatedData = { ...prev };

          // ã¾ãšã€ä»Šé€±ã®0,0,0ã®æ—¥ã‚’dailyDataã‹ã‚‰å‰Šé™¤
          [...weekdays, ...weekends].forEach(day => {
            const dayData = hours[day];
            const dateStr = getDayDate(day);
            if (dateStr) {
              const hasAllFields = dayData.hours > 0 &&
                                 dayData.deliveries > 0 &&
                                 dayData.earnings > 0;
              if (!hasAllFields && updatedData[dateStr]) {
                // hoursãŒç©ºï¼ˆ0,0,0ï¼‰ãªã®ã«dailyDataã«ã‚ã‚‹å ´åˆã¯å‰Šé™¤
                delete updatedData[dateStr];
              }
            }
          });

          // é€±ã®ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ™‚çš„ã«ä¿å­˜ï¼ˆã‚¯ã‚¨ã‚¹ãƒˆè¨ˆç®—ã®ãŸã‚ï¼‰
          const tempData = {};
          [...weekdays, ...weekends].forEach(day => {
            const dayData = hours[day];
            const hasAllFields = dayData.hours > 0 &&
                               dayData.deliveries > 0 &&
                               dayData.earnings > 0;

            const dateStr = getDayDate(day);
            if (dateStr && hasAllFields) {
              tempData[dateStr] = {
                day: day,
                hours: dayData.hours,
                deliveries: dayData.deliveries,
                earnings: dayData.earnings  // å…¥åŠ›å€¤ï¼ˆã‚¯ã‚¨ã‚¹ãƒˆè¾¼ã¿ï¼‰
              };
            }
          });

          // æœˆï½æœ¨ã®ã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬ã‚’é”æˆã—ãŸæ—¥ã«é…åˆ†
          let cumulativeWeekday = 0;
          let nextQuestIndex = 0;
          let cumulativeQuestCount = 0;

          weekdays.forEach(day => {
            const dateStr = getDayDate(day);
            if (!dateStr || !tempData[dateStr]) return;

            const dayData = hours[day];
            const dayDeliveries = dayData.deliveries > 0 ? dayData.deliveries : dayData.hours * effectiveValues.weekdayDeliveriesPerHour;
            cumulativeWeekday += dayDeliveries;

            // ã“ã®æ—¥ã«é”æˆã—ãŸã‚¯ã‚¨ã‚¹ãƒˆã‚’ç¢ºèª
            let dayQuestReward = 0;
            while (nextQuestIndex < weekdayQuests.length) {
              const nextThreshold = cumulativeQuestCount + weekdayQuests[nextQuestIndex].count;
              if (cumulativeWeekday >= nextThreshold) {
                dayQuestReward += weekdayQuests[nextQuestIndex].reward;
                cumulativeQuestCount = nextThreshold;
                nextQuestIndex++;
              } else {
                break;
              }
            }

            // å…¥åŠ›å€¤ï¼ˆã‚¯ã‚¨ã‚¹ãƒˆè¾¼ã¿ï¼‰ã‹ã‚‰ã‚¯ã‚¨ã‚¹ãƒˆã‚’å¼•ã„ã¦åŸºæœ¬å£²ä¸Šã‚’ä¿å­˜
            updatedData[dateStr] = {
              hours: tempData[dateStr].hours,
              deliveries: tempData[dateStr].deliveries,
              earnings: tempData[dateStr].earnings - dayQuestReward,
              quest: dayQuestReward
            };
          });

          // é‡‘ï½æ—¥ã®ã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬ã‚’é”æˆã—ãŸæ—¥ã«é…åˆ†
          let cumulativeWeekend = 0;
          let nextWeekendQuestIndex = 0;
          let cumulativeWeekendQuestCount = 0;

          weekends.forEach(day => {
            const dateStr = getDayDate(day);
            if (!dateStr || !tempData[dateStr]) return;

            const dayData = hours[day];
            const dayDeliveries = dayData.deliveries > 0 ? dayData.deliveries : dayData.hours * effectiveValues.weekendDeliveriesPerHour;
            cumulativeWeekend += dayDeliveries;

            // ã“ã®æ—¥ã«é”æˆã—ãŸã‚¯ã‚¨ã‚¹ãƒˆã‚’ç¢ºèª
            let dayQuestReward = 0;
            while (nextWeekendQuestIndex < weekendQuests.length) {
              const quest = weekendQuests[nextWeekendQuestIndex];
              const nextThreshold = cumulativeWeekendQuestCount + quest.count;
              if (cumulativeWeekend >= nextThreshold) {
                dayQuestReward += quest.reward;
                cumulativeWeekendQuestCount = nextThreshold;
                nextWeekendQuestIndex++;
              } else {
                break;
              }
            }

            // å…¥åŠ›å€¤ï¼ˆã‚¯ã‚¨ã‚¹ãƒˆè¾¼ã¿ï¼‰ã‹ã‚‰ã‚¯ã‚¨ã‚¹ãƒˆã‚’å¼•ã„ã¦åŸºæœ¬å£²ä¸Šã‚’ä¿å­˜
            updatedData[dateStr] = {
              hours: tempData[dateStr].hours,
              deliveries: tempData[dateStr].deliveries,
              earnings: tempData[dateStr].earnings - dayQuestReward,
              quest: dayQuestReward
            };
          });

          return updatedData;
        });
      }, [hours, weekdayQuests, weekendQuests, weekdayDeliveriesPerHour, weekendDeliveriesPerHour, useAutoCalculate, weekdayAvgPrice, weekendAvgPrice, settingsLoading, dailyDataLoading]);

      // hoursãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ã€Supabaseã«ä¿å­˜ï¼ˆdaily_recordsã«ï¼‰
      useEffect(() => {
        if (!currentWeekStart || !session?.user?.id || settingsLoading || dailyDataLoading) return;

        // ãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼šå…¥åŠ›ãŒè½ã¡ç€ã„ã¦ã‹ã‚‰ä¿å­˜
        const timer = setTimeout(async () => {
          try {
            // ä½¿ç”¨ã™ã‚‹å¹³å‡å€¤ã‚’å–å¾—
            const effectiveValues = getEffectiveValues();

            // é€±ã®ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã—ã¦è¨ˆç®—ï¼ˆ1ç•ªç›®ã®useEffectã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
            const datesToSave = [];
            const tempData = {};

            [...weekdays, ...weekends].forEach(day => {
              const dayData = hours[day];
              const hasAllFields = dayData.hours > 0 &&
                                 dayData.deliveries > 0 &&
                                 dayData.earnings > 0;

              const dateStr = getDayDate(day);
              if (!dateStr) return;

              if (hasAllFields) {
                tempData[dateStr] = {
                  day: day,
                  hours: dayData.hours,
                  deliveries: dayData.deliveries,
                  earnings: dayData.earnings
                };
              }
            });

            // æœˆï½æœ¨ã®ã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬ã‚’é”æˆã—ãŸæ—¥ã«é…åˆ†
            let cumulativeWeekday = 0;
            let nextQuestIndex = 0;
            let cumulativeQuestCount = 0;

            weekdays.forEach(day => {
              const dateStr = getDayDate(day);
              if (!dateStr || !tempData[dateStr]) return;

              const dayData = hours[day];
              const dayDeliveries = dayData.deliveries > 0 ? dayData.deliveries : dayData.hours * effectiveValues.weekdayDeliveriesPerHour;
              cumulativeWeekday += dayDeliveries;

              let dayQuestReward = 0;
              while (nextQuestIndex < weekdayQuests.length) {
                const nextThreshold = cumulativeQuestCount + weekdayQuests[nextQuestIndex].count;
                if (cumulativeWeekday >= nextThreshold) {
                  dayQuestReward += weekdayQuests[nextQuestIndex].reward;
                  cumulativeQuestCount = nextThreshold;
                  nextQuestIndex++;
                } else {
                  break;
                }
              }

              datesToSave.push({
                user_id: session.user.id,
                date: dateStr,
                hours: tempData[dateStr].hours,
                deliveries: tempData[dateStr].deliveries,
                earnings: tempData[dateStr].earnings - dayQuestReward,
                quest: dayQuestReward,
                is_rainy: false,
                is_holiday: false,
                updated_at: new Date().toISOString()
              });
            });

            // é‡‘ï½æ—¥ã®ã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬ã‚’é”æˆã—ãŸæ—¥ã«é…åˆ†
            let cumulativeWeekend = 0;
            let nextWeekendQuestIndex = 0;
            let cumulativeWeekendQuestCount = 0;

            weekends.forEach(day => {
              const dateStr = getDayDate(day);
              if (!dateStr || !tempData[dateStr]) return;

              const dayData = hours[day];
              const dayDeliveries = dayData.deliveries > 0 ? dayData.deliveries : dayData.hours * effectiveValues.weekendDeliveriesPerHour;
              cumulativeWeekend += dayDeliveries;

              let dayQuestReward = 0;
              while (nextWeekendQuestIndex < weekendQuests.length) {
                const nextThreshold = cumulativeWeekendQuestCount + weekendQuests[nextWeekendQuestIndex].count;
                if (cumulativeWeekend >= nextThreshold) {
                  dayQuestReward += weekendQuests[nextWeekendQuestIndex].reward;
                  cumulativeWeekendQuestCount = nextThreshold;
                  nextWeekendQuestIndex++;
                } else {
                  break;
                }
              }

              datesToSave.push({
                user_id: session.user.id,
                date: dateStr,
                hours: tempData[dateStr].hours,
                deliveries: tempData[dateStr].deliveries,
                earnings: tempData[dateStr].earnings - dayQuestReward,
                quest: dayQuestReward,
                is_rainy: false,
                is_holiday: false,
                updated_at: new Date().toISOString()
              });
            });

            // ä»Šé€±ã§hoursãŒ0,0,0ã®æ—¥ã‚’daily_recordsã‹ã‚‰å‰Šé™¤
            const datesToDelete = [];
            [...weekdays, ...weekends].forEach(day => {
              const dayData = hours[day];
              const dateStr = getDayDate(day);
              if (dateStr) {
                const hasAllFields = dayData.hours > 0 &&
                                   dayData.deliveries > 0 &&
                                   dayData.earnings > 0;
                if (!hasAllFields) {
                  datesToDelete.push(dateStr);
                }
              }
            });

            // å‰Šé™¤
            if (datesToDelete.length > 0) {
              await supabaseClient
                .from('daily_records')
                .delete()
                .eq('user_id', session.user.id)
                .in('date', datesToDelete);
            }

            // ä¿å­˜
            if (datesToSave.length > 0) {
              await supabaseClient
                .from('daily_records')
                .upsert(datesToSave, {
                  onConflict: 'user_id,date'
                });
            }
          } catch (error) {
            console.error('Error saving daily data from hours:', error);
          }
        }, 500); // 500ms ãƒ‡ãƒã‚¦ãƒ³ã‚¹

        return () => clearTimeout(timer);
      }, [hours, session?.user?.id, settingsLoading, dailyDataLoading]);

      // é€±ã®åˆ‡ã‚Šæ›¿ã‚ã‚Šæ¤œçŸ¥ï¼ˆæ—¥æ›œæ—¥â†’æœˆæ›œæ—¥ï¼‰
      useEffect(() => {
        const checkWeekTransition = () => {
          const today = new Date();
          const todayStr = formatDateToLocal(today);
          const dayOfWeek = today.getDay(); // 0=æ—¥æ›œ, 1=æœˆæ›œ, ...

          // ä»Šæ—¥ã®æœˆæ›œæ—¥ã®æ—¥ä»˜ã‚’è¨ˆç®—
          const getMondayOfWeek = (date) => {
            const d = new Date(date);
            const day = d.getDay();
            const diff = day === 0 ? -6 : 1 - day; // æ—¥æ›œã®å ´åˆã¯å‰æ—¥ã®æœˆæ›œã€ãã‚Œä»¥å¤–ã¯ä»Šé€±ã®æœˆæ›œ
            d.setDate(d.getDate() + diff);
            return formatDateToLocal(d);
          };

          const mondayStr = getMondayOfWeek(today);

          // åˆå›ã‚¢ã‚¯ã‚»ã‚¹ã®å ´åˆ
          if (!lastAccessDate) {
            setLastAccessDate(todayStr);
            setCurrentWeekStart(mondayStr);
            return;
          }

          const lastAccess = new Date(lastAccessDate);
          const lastDayOfWeek = lastAccess.getDay();

          // æ—¥æ›œæ—¥ã‹ã‚‰æœˆæ›œæ—¥ã«å¤‰ã‚ã£ãŸå ´åˆï¼ˆæ–°ã—ã„é€±ã®é–‹å§‹ï¼‰
          if (lastDayOfWeek === 0 && dayOfWeek === 1) {
            // é€±ã®å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢ï¼ˆãƒ‡ãƒ¼ã‚¿ã¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è‡ªå‹•ä¿å­˜æ¸ˆã¿ï¼‰
            setHours({
              æœˆ: { hours: 0, deliveries: 0, earnings: 0 },
              ç«: { hours: 0, deliveries: 0, earnings: 0 },
              æ°´: { hours: 0, deliveries: 0, earnings: 0 },
              æœ¨: { hours: 0, deliveries: 0, earnings: 0 },
              é‡‘: { hours: 0, deliveries: 0, earnings: 0 },
              åœŸ: { hours: 0, deliveries: 0, earnings: 0 },
              æ—¥: { hours: 0, deliveries: 0, earnings: 0 }
            });
          }

          // é€±ãŒå¤‰ã‚ã£ãŸå ´åˆï¼ˆæœˆæ›œæ—¥ã§ãªãã¦ã‚‚é€±ã®é–‹å§‹æ—¥ã‚’æ›´æ–°ï¼‰
          if (currentWeekStart !== mondayStr) {
            setCurrentWeekStart(mondayStr);
          }

          // æœ€çµ‚ã‚¢ã‚¯ã‚»ã‚¹æ—¥ã‚’æ›´æ–°
          setLastAccessDate(todayStr);
        };

        checkWeekTransition();
      }, []); // èµ·å‹•æ™‚ã«1å›ã ã‘å®Ÿè¡Œ

      // ã‚¯ã‚¨ã‚¹ãƒˆæ›´æ–° - æœˆï½æœ¨
      const updateWeekdayQuest = (index, field, value) => {
        const newQuests = [...weekdayQuests];
        newQuests[index][field] = parseFloat(value) || 0;
        setWeekdayQuests(newQuests);
      };

      // ã‚¯ã‚¨ã‚¹ãƒˆæ›´æ–° - é‡‘ï½æ—¥
      const updateWeekendQuest = (index, field, value) => {
        const newQuests = [...weekendQuests];
        newQuests[index][field] = parseFloat(value) || 0;
        setWeekendQuests(newQuests);
      };
      
      // æ›œæ—¥ã‹ã‚‰æ—¥ä»˜ã‚’è¨ˆç®—
      const getDayDate = (dayName) => {
        if (!currentWeekStart) return null;

        const dayIndex = days.indexOf(dayName); // 0=æœˆ, 1=ç«, ..., 6=æ—¥
        const weekStartDate = new Date(currentWeekStart + 'T00:00:00');
        const targetDate = new Date(weekStartDate);
        targetDate.setDate(targetDate.getDate() + dayIndex);

        return formatDateToLocal(targetDate);
      };

      // ç¨¼åƒæ™‚é–“æ›´æ–°ï¼ˆé€±ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°ã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¸ã®åæ˜ ã¯useEffectã§è‡ªå‹•å®Ÿè¡Œï¼‰
      const updateHours = (day, field, value) => {
        const newValue = parseFloat(value) || 0;

        // é€±ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
        setHours({
          ...hours,
          [day]: {
            ...hours[day],
            [field]: newValue
          }
        });
      };

      // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
      const exportData = () => {
        const data = {
          version: 3,
          exportDate: new Date().toISOString(),
          weekdayAvgPrice,
          weekendAvgPrice,
          weekdayDeliveriesPerHour,
          weekendDeliveriesPerHour,
          useAutoCalculate,
          weekdayQuests,
          weekendQuests,
          hours,
          targetAmount,
          dailyData,
          currentWeekStart,
          lastAccessDate,
          expenses
        };

        const jsonStr = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ubereats-backup-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      // ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
      const importData = (event) => {
        try {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = async (e) => {
            try {
              const data = JSON.parse(e.target.result);

              if (!session?.user?.id) {
                alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
                if (event.target) event.target.value = '';
                return;
              }

              // Supabaseã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
              try {
                // 1. å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’daily_recordsã«ä¿å­˜
                if (data.dailyData && Object.keys(data.dailyData).length > 0) {
                  const recordsToInsert = [];
                  for (const [date, record] of Object.entries(data.dailyData)) {
                    recordsToInsert.push({
                      user_id: session.user.id,
                      date,
                      hours: record.hours || 0,
                      deliveries: record.deliveries || 0,
                      earnings: record.earnings || 0,
                      quest: record.quest || 0,
                      is_rainy: record.isRainy || false,
                      is_holiday: record.isHoliday || false
                    });
                  }

                  if (recordsToInsert.length > 0) {
                    const { error: dailyError } = await supabaseClient
                      .from('daily_records')
                      .upsert(recordsToInsert, {
                        onConflict: 'user_id,date'
                      });

                    if (dailyError) throw dailyError;
                  }
                }

                // 2. çµŒè²»ãƒ‡ãƒ¼ã‚¿ã‚’expensesã«ä¿å­˜
                if (data.expenses && data.expenses.length > 0) {
                  const expensesToInsert = data.expenses.map(exp => ({
                    ...exp,
                    user_id: session.user.id
                  }));

                  const { error: expensesError } = await supabaseClient
                    .from('expenses')
                    .upsert(expensesToInsert, {
                      onConflict: 'id'
                    });

                  if (expensesError) throw expensesError;
                }

                // 3. è¨­å®šã‚’user_settingsã«ä¿å­˜
                const { error: settingsError } = await supabaseClient
                  .from('user_settings')
                  .upsert({
                    user_id: session.user.id,
                    weekday_avg_price: data.weekdayAvgPrice,
                    weekend_avg_price: data.weekendAvgPrice,
                    weekday_deliveries_per_hour: data.weekdayDeliveriesPerHour,
                    weekend_deliveries_per_hour: data.weekendDeliveriesPerHour,
                    use_auto_calculate: data.useAutoCalculate,
                    weekday_quests: data.weekdayQuests,
                    weekend_quests: data.weekendQuests,
                    target_amount: data.targetAmount,
                    current_week_start: data.currentWeekStart,
                    hours: data.hours,
                    updated_at: new Date().toISOString()
                  }, {
                    onConflict: 'user_id'
                  });

                if (settingsError) throw settingsError;

              } catch (supabaseError) {
                console.error('Supabaseä¿å­˜ã‚¨ãƒ©ãƒ¼:', supabaseError);
                alert('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + supabaseError.message);
                if (event.target) event.target.value = '';
                return;
              }

              // stateã‚’ç›´æ¥æ›´æ–°
              if (data.weekdayAvgPrice !== undefined) setWeekdayAvgPrice(data.weekdayAvgPrice);
              if (data.weekendAvgPrice !== undefined) setWeekendAvgPrice(data.weekendAvgPrice);
              if (data.weekdayDeliveriesPerHour !== undefined) setWeekdayDeliveriesPerHour(data.weekdayDeliveriesPerHour);
              if (data.weekendDeliveriesPerHour !== undefined) setWeekendDeliveriesPerHour(data.weekendDeliveriesPerHour);
              if (data.useAutoCalculate !== undefined) setUseAutoCalculate(data.useAutoCalculate);
              if (data.weekdayQuests) setWeekdayQuests(data.weekdayQuests);
              if (data.weekendQuests) setWeekendQuests(data.weekendQuests);
              if (data.hours) setHours(data.hours);
              if (data.targetAmount !== undefined) setTargetAmount(data.targetAmount);
              if (data.dailyData) setDailyData(data.dailyData);
              if (data.currentWeekStart) setCurrentWeekStart(data.currentWeekStart);
              if (data.lastAccessDate) setLastAccessDate(data.lastAccessDate);
              if (data.expenses) setExpenses(data.expenses);

              // inputè¦ç´ ã‚’ãƒªã‚»ãƒƒãƒˆ
              if (event.target) event.target.value = '';

              alert('ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸï¼ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');

              // è‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰
              setTimeout(() => {
                window.location.reload();
              }, 1000);
            } catch (error) {
              console.error('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
              alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
              if (event.target) event.target.value = '';
            }
          };
          reader.onerror = () => {
            alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            if (event.target) event.target.value = '';
          };
          reader.readAsText(file);
        } catch (error) {
          console.error('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
          alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
        }
      };

      // æ—¥ä»˜ã‚’ã‚¿ãƒƒãƒ—ã—ãŸã¨ãã®å‡¦ç†
      const handleDateClick = (date) => {
        const dateStr = formatDateToLocal(date);

        // æ—¥ä»˜å¤‰æ›´ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
        if (isChangingDate) {
          // é¸æŠã—ãŸæ—¥ä»˜ã«æ—¢ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if (dailyData[dateStr] && dailyData[dateStr].hours > 0) {
            if (!confirm('ã“ã®æ—¥ä»˜ã«ã¯æ—¢ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚å…ƒã®ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã•ã‚Œã€ç·¨é›†ä¸­ã®ãƒ‡ãƒ¼ã‚¿ãŒç§»å‹•ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
              return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸå ´åˆã¯ä½•ã‚‚ã—ãªã„
            }
          }

          setSelectedDate(dateStr);
          setIsChangingDate(false);
          return;
        }

        // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰
        setSelectedDate(dateStr);
        setOriginalSelectedDate(dateStr); // å…ƒã®æ—¥ä»˜ã‚’ä¿å­˜

        // ãã®æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const dayData = dailyData[dateStr] || { hours: 0, deliveries: 0, earnings: 0, quest: 0, isRainy: false, isHoliday: false };
        setEditingDayData(dayData);
        setShowDayEdit(true);
      };

      // æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
      const saveDayData = async () => {
        if (!selectedDate || !session?.user?.id) return;

        try {
          // æ—¥ä»˜ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã€å…ƒã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
          if (originalSelectedDate && originalSelectedDate !== selectedDate) {
            await supabaseClient
              .from('daily_records')
              .delete()
              .eq('user_id', session.user.id)
              .eq('date', originalSelectedDate);
          }

          // Supabaseã«ä¿å­˜
          const { error } = await supabaseClient
            .from('daily_records')
            .upsert({
              user_id: session.user.id,
              date: selectedDate,
              hours: editingDayData.hours,
              deliveries: editingDayData.deliveries,
              earnings: editingDayData.earnings,
              quest: editingDayData.quest,
              is_rainy: editingDayData.isRainy,
              is_holiday: editingDayData.isHoliday,
              updated_at: new Date().toISOString()
            }, {
              onConflict: 'user_id,date'
            });

          if (error) throw error;

          // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒ†ãƒ¼ãƒˆã‚’æ›´æ–°
          setDailyData(prev => {
            const newData = { ...prev };

            if (originalSelectedDate && originalSelectedDate !== selectedDate) {
              delete newData[originalSelectedDate];
            }

            newData[selectedDate] = { ...editingDayData };
            return newData;
          });

          setShowDayEdit(false);
          setSelectedDate(null);
          setOriginalSelectedDate(null);
        } catch (error) {
          console.error('Error saving day data:', error);
          alert('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
        }
      };

      // æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤
      const deleteDayData = async () => {
        if (!selectedDate || !session?.user?.id) return;

        try {
          const { error } = await supabaseClient
            .from('daily_records')
            .delete()
            .eq('user_id', session.user.id)
            .eq('date', selectedDate);

          if (error) throw error;

          // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒ†ãƒ¼ãƒˆã‚’æ›´æ–°
          const newData = { ...dailyData };
          delete newData[selectedDate];
          setDailyData(newData);

          // ä»Šé€±ã®æ—¥ä»˜ãªã‚‰ã€Œä»Šé€±ã®ç¨¼åƒã€ã‚‚ã‚¯ãƒªã‚¢
          if (currentWeekStart) {
            const weekStartDate = new Date(currentWeekStart + 'T00:00:00');
            const deleteDate = new Date(selectedDate + 'T00:00:00');
            const daysDiff = Math.floor((deleteDate - weekStartDate) / (1000 * 60 * 60 * 24));

            // 0-6æ—¥ä»¥å†…ãªã‚‰ä»Šé€±
            if (daysDiff >= 0 && daysDiff <= 6) {
              const dayName = days[daysDiff]; // 0=æœˆ, 1=ç«, ..., 6=æ—¥
              setHours(prev => ({
                ...prev,
                [dayName]: { hours: 0, deliveries: 0, earnings: 0 }
              }));
            }
          }

          setShowDayEdit(false);
          setSelectedDate(null);
          setOriginalSelectedDate(null);
        } catch (error) {
          console.error('Error deleting day data:', error);
          alert('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
        }
      };

      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æœˆã‚’å¤‰æ›´
      const changeMonth = (offset) => {
        const newMonth = new Date(currentMonth);
        newMonth.setMonth(newMonth.getMonth() + offset);
        setCurrentMonth(newMonth);
      };

      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜é…åˆ—ã‚’ç”Ÿæˆ
      const generateCalendarDays = () => {
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();

        // æœˆã®æœ€åˆã®æ—¥
        const firstDay = new Date(year, month, 1);
        // æœˆã®æœ€å¾Œã®æ—¥
        const lastDay = new Date(year, month + 1, 0);

        // æœ€åˆã®æ—¥ã®æ›œæ—¥ï¼ˆ0=æ—¥æ›œ, 1=æœˆæ›œ, ...ï¼‰
        let firstDayOfWeek = firstDay.getDay();
        // æœˆæ›œå§‹ã¾ã‚Šã«èª¿æ•´ï¼ˆæ—¥æ›œ=6, æœˆæ›œ=0ï¼‰
        firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;

        const days = [];

        // å‰æœˆã®æ—¥ä»˜ã§åŸ‹ã‚ã‚‹
        const prevMonthLastDay = new Date(year, month, 0).getDate();
        for (let i = firstDayOfWeek - 1; i >= 0; i--) {
          const date = new Date(year, month - 1, prevMonthLastDay - i);
          days.push({ date, isCurrentMonth: false });
        }

        // å½“æœˆã®æ—¥ä»˜
        for (let i = 1; i <= lastDay.getDate(); i++) {
          const date = new Date(year, month, i);
          days.push({ date, isCurrentMonth: true });
        }

        // æ¬¡æœˆã®æ—¥ä»˜ã§åŸ‹ã‚ã‚‹ï¼ˆ6é€±åˆ†=42æ—¥ã¾ã§ï¼‰
        const remainingDays = 42 - days.length;
        for (let i = 1; i <= remainingDays; i++) {
          const date = new Date(year, month + 1, i);
          days.push({ date, isCurrentMonth: false });
        }

        return days;
      };

      // Enterã‚­ãƒ¼ã§æ¬¡ã®é …ç›®ã«ç§»å‹•
      const handleKeyDown = (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          const form = e.target.form || e.target.closest('.space-y-2, .space-y-3, .space-y-4, .p-6');
          if (form) {
            const inputs = Array.from(form.querySelectorAll('input'));
            const index = inputs.indexOf(e.target);
            if (index >= 0 && index < inputs.length - 1) {
              inputs[index + 1].focus();
              inputs[index + 1].select();
            } else if (index === inputs.length - 1) {
              // æœ€å¾Œã®é …ç›®ã§ã¯ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’é–‰ã˜ã‚‹
              e.target.blur();
            }
          }
        }
      };

      // è¨ˆç®—
      const calculate = () => {
        // ä½¿ç”¨ã™ã‚‹å¹³å‡å€¤ã‚’å–å¾—
        const effectiveValues = getEffectiveValues();
        // æœˆï½æœ¨ã®åˆè¨ˆ
        let weekdayHours = 0;
        let weekdayDeliveries = 0;
        let weekdayBasicEarnings = 0;
        let weekdayQuestEarnings = 0;

        // ã¾ãšé…é”ä»¶æ•°ã‚’è¨ˆç®—ï¼ˆã‚¯ã‚¨ã‚¹ãƒˆè¨ˆç®—ã«å¿…è¦ï¼‰
        const weekdayDailyData = [];
        weekdays.forEach(day => {
          const dayData = hours[day];
          weekdayHours += dayData.hours;
          const dayDeliveries = dayData.deliveries > 0 ? dayData.deliveries : dayData.hours * effectiveValues.weekdayDeliveriesPerHour;
          weekdayDeliveries += dayDeliveries;
          weekdayDailyData.push({ day, dayData, dayDeliveries });
        });

        // å„æ—¥ã®ã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬ã‚’è¨ˆç®—
        let cumulativeWeekday = 0;
        weekdayDailyData.forEach(({ day, dayData, dayDeliveries }) => {
          const previousCumulative = cumulativeWeekday;
          cumulativeWeekday += dayDeliveries;

          // ã“ã®æ—¥ã«é”æˆã—ãŸã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬ã‚’è¨ˆç®—
          let dayQuestReward = 0;
          let questIndex = 0;
          let cumulativeThreshold = 0;

          // å‰æ—¥ã¾ã§ã«é”æˆã—ã¦ã„ãŸã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—
          while (questIndex < weekdayQuests.length) {
            const nextThreshold = cumulativeThreshold + weekdayQuests[questIndex].count;
            if (previousCumulative >= nextThreshold) {
              cumulativeThreshold = nextThreshold;
              questIndex++;
            } else {
              break;
            }
          }

          // ã“ã®æ—¥ã«æ–°ãŸã«é”æˆã—ãŸã‚¯ã‚¨ã‚¹ãƒˆã‚’åŠ ç®—
          while (questIndex < weekdayQuests.length) {
            const nextThreshold = cumulativeThreshold + weekdayQuests[questIndex].count;
            if (cumulativeWeekday >= nextThreshold) {
              dayQuestReward += weekdayQuests[questIndex].reward;
              cumulativeThreshold = nextThreshold;
              questIndex++;
            } else {
              break;
            }
          }

          weekdayQuestEarnings += dayQuestReward;

          // é‡‘é¡è¨ˆç®—ï¼šå…¥åŠ›ãŒã‚ã‚‹å ´åˆã¯ã‚¯ã‚¨ã‚¹ãƒˆã‚’å¼•ã„ãŸé¡ã‚’åŸºæœ¬å£²ä¸Šã¨ã™ã‚‹
          if (dayData.earnings > 0) {
            weekdayBasicEarnings += dayData.earnings - dayQuestReward;
          } else {
            weekdayBasicEarnings += dayData.hours * effectiveValues.weekdayDeliveriesPerHour * effectiveValues.weekdayAvgPrice;
          }
        });

        // é‡‘ï½æ—¥ã®åˆè¨ˆ
        let weekendHours = 0;
        let weekendDeliveries = 0;
        let weekendBasicEarnings = 0;
        let weekendQuestEarnings = 0;

        // ã¾ãšé…é”ä»¶æ•°ã‚’è¨ˆç®—ï¼ˆã‚¯ã‚¨ã‚¹ãƒˆè¨ˆç®—ã«å¿…è¦ï¼‰
        const weekendDailyData = [];
        weekends.forEach(day => {
          const dayData = hours[day];
          weekendHours += dayData.hours;
          const dayDeliveries = dayData.deliveries > 0 ? dayData.deliveries : dayData.hours * effectiveValues.weekendDeliveriesPerHour;
          weekendDeliveries += dayDeliveries;
          weekendDailyData.push({ day, dayData, dayDeliveries });
        });

        // å„æ—¥ã®ã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬ã‚’è¨ˆç®—
        let cumulativeWeekend = 0;
        weekendDailyData.forEach(({ day, dayData, dayDeliveries }) => {
          const previousCumulative = cumulativeWeekend;
          cumulativeWeekend += dayDeliveries;

          // ã“ã®æ—¥ã«é”æˆã—ãŸã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬ã‚’è¨ˆç®—
          let dayQuestReward = 0;
          let questIndex = 0;
          let cumulativeThreshold = 0;

          // å‰æ—¥ã¾ã§ã«é”æˆã—ã¦ã„ãŸã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—
          while (questIndex < weekendQuests.length) {
            const nextThreshold = cumulativeThreshold + weekendQuests[questIndex].count;
            if (previousCumulative >= nextThreshold) {
              cumulativeThreshold = nextThreshold;
              questIndex++;
            } else {
              break;
            }
          }

          // ã“ã®æ—¥ã«æ–°ãŸã«é”æˆã—ãŸã‚¯ã‚¨ã‚¹ãƒˆã‚’åŠ ç®—
          while (questIndex < weekendQuests.length) {
            const nextThreshold = cumulativeThreshold + weekendQuests[questIndex].count;
            if (cumulativeWeekend >= nextThreshold) {
              dayQuestReward += weekendQuests[questIndex].reward;
              cumulativeThreshold = nextThreshold;
              questIndex++;
            } else {
              break;
            }
          }

          weekendQuestEarnings += dayQuestReward;

          // é‡‘é¡è¨ˆç®—ï¼šå…¥åŠ›ãŒã‚ã‚‹å ´åˆã¯ã‚¯ã‚¨ã‚¹ãƒˆã‚’å¼•ã„ãŸé¡ã‚’åŸºæœ¬å£²ä¸Šã¨ã™ã‚‹
          if (dayData.earnings > 0) {
            weekendBasicEarnings += dayData.earnings - dayQuestReward;
          } else {
            weekendBasicEarnings += dayData.hours * effectiveValues.weekendDeliveriesPerHour * effectiveValues.weekendAvgPrice;
          }
        });
        
        // é€±ã®åˆè¨ˆ
        const totalHours = weekdayHours + weekendHours;
        const totalDeliveries = weekdayDeliveries + weekendDeliveries;
        const basicEarnings = weekdayBasicEarnings + weekendBasicEarnings;
        const questEarnings = weekdayQuestEarnings + weekendQuestEarnings;
        const totalEarnings = basicEarnings + questEarnings;
        
        // 1æ—¥ã‚ãŸã‚Šã®å¹³å‡
        const daysWorked = Object.values(hours).filter(h => h.hours > 0).length;
        const avgPerDay = daysWorked > 0 ? totalEarnings / daysWorked : 0;
        
        // å¹³å‡æ™‚çµ¦
        const avgHourlyWage = totalHours > 0 ? totalEarnings / totalHours : 0;
        
        // ç›®æ¨™é”æˆã«å¿…è¦ãªæ™‚é–“
        let hoursNeeded = 0;
        if (targetAmount > 0 && totalEarnings < targetAmount && avgHourlyWage > 0) {
          const remaining = targetAmount - totalEarnings;
          hoursNeeded = remaining / avgHourlyWage;
        }
        
        return {
          totalHours: totalHours.toFixed(1),
          weekdayHours: weekdayHours.toFixed(1),
          weekendHours: weekendHours.toFixed(1),
          totalDeliveries: Math.floor(totalDeliveries),
          weekdayDeliveries: Math.floor(weekdayDeliveries),
          weekendDeliveries: Math.floor(weekendDeliveries),
          basicEarnings: Math.floor(basicEarnings),
          questEarnings: Math.floor(questEarnings),
          totalEarnings: Math.floor(totalEarnings),
          avgPerDay: Math.floor(avgPerDay),
          avgHourlyWage: Math.floor(avgHourlyWage),
          hoursNeeded: hoursNeeded.toFixed(1),
          daysWorked
        };
      };
      
      const results = calculate();
      
      return (
        <div className={`min-h-screen p-4 pb-8 ${isDarkMode ? 'dark bg-gradient-to-br from-gray-900 to-gray-800' : 'bg-gradient-to-br from-green-50 to-blue-50'}`}>
          <div className="max-w-2xl mx-auto">
            {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
            <div className={`rounded-2xl shadow-lg p-6 mb-4 ${isDarkMode ? 'bg-gray-800' : 'bg-white'}`}>
              <div className="flex items-center justify-between mb-2">
                <div className="flex items-center gap-3">
                  <button
                    onClick={() => setShowTotalStats(true)}
                    className="hover:opacity-80 transition-opacity"
                  >
                    <img src="ã‚¢ã‚¤ã‚³ãƒ³.jpg?v=5" alt="Uberè¨˜éŒ²" className="w-12 h-12 rounded-xl" />
                  </button>
                  <div>
                    <h1 className={`text-2xl font-bold ${isDarkMode ? 'text-white' : 'text-gray-800'}`}>Uberè¨˜éŒ²</h1>
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  <button
                    onClick={() => setShowBTCModal(true)}
                    className="hover:opacity-80 transition-opacity"
                  >
                    <img src="BTC.png" alt="ãƒ“ãƒƒãƒˆã‚³ã‚¤ãƒ³ç©ã¿ç«‹ã¦" className="w-10 h-10 rounded-lg" />
                  </button>
                  <button
                    onClick={() => setShowBasicSettings(true)}
                    className="bg-blue-500 text-white px-3 py-2 rounded-lg font-medium hover:bg-blue-600 transition-colors text-xs"
                  >
                    âš™ï¸ è¨­å®š
                  </button>
                </div>
              </div>

              {/* Quest, Calendar, Expense buttons */}
              <div className="space-y-2 mt-4">
                <div className="grid grid-cols-2 gap-2">
                  <button
                    onClick={() => setShowQuestSettings(true)}
                    className="bg-yellow-500 text-white px-3 py-3 rounded-xl font-medium hover:bg-yellow-600 transition-colors text-sm"
                  >
                    ğŸ† ã‚¯ã‚¨ã‚¹ãƒˆ
                  </button>
                  <button
                    onClick={() => setShowCalendar(true)}
                    className="bg-purple-500 text-white px-3 py-3 rounded-xl font-medium hover:bg-purple-600 transition-colors text-sm"
                  >
                    ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
                  </button>
                </div>
                <button
                  onClick={() => setShowExpenses(true)}
                  className="w-full bg-red-500 text-white px-3 py-3 rounded-xl font-medium hover:bg-red-600 transition-colors text-sm"
                >
                  ğŸ’¸ çµŒè²»
                </button>

                {/* è²¡å‹™è«¸è¡¨ãƒœã‚¿ãƒ³ */}
                <div className="grid grid-cols-2 gap-2 mt-2">
                  <button
                    onClick={() => setShowBalanceSheet(true)}
                    className="bg-indigo-500 text-white px-3 py-3 rounded-xl font-medium hover:bg-indigo-600 transition-colors text-sm"
                  >
                    ğŸ“Š è²¸å€Ÿå¯¾ç…§è¡¨
                  </button>
                  <button
                    onClick={() => setShowIncomeStatement(true)}
                    className="bg-teal-500 text-white px-3 py-3 rounded-xl font-medium hover:bg-teal-600 transition-colors text-sm"
                  >
                    ğŸ“ˆ æç›Šè¨ˆç®—æ›¸
                  </button>
                </div>
              </div>
            </div>
            
            {/* ç›®æ¨™é‡‘é¡è¨­å®š */}
            <div className={`rounded-2xl shadow-lg p-6 mb-4 ${isDarkMode ? 'bg-gray-800' : 'bg-white'}`}>
              <h2 className={`text-lg font-bold mb-4 flex items-center gap-2 ${isDarkMode ? 'text-white' : 'text-gray-800'}`}>
                <DollarSign />
                ç›®æ¨™é‡‘é¡
              </h2>

              <div className="flex items-center gap-3">
                <input
                  type="number"
                  step="1000"
                  value={targetAmount || ''}
                  onChange={(e) => setTargetAmount(parseFloat(e.target.value) || 0)}
                  onKeyDown={handleKeyDown}
                  className={`flex-1 px-4 py-3 border-2 rounded-xl focus:outline-none text-lg ${isDarkMode ? 'bg-gray-700 border-gray-600 text-white focus:border-green-400' : 'border-gray-200 focus:border-green-500'}`}
                  placeholder="ç›®æ¨™é‡‘é¡ã‚’å…¥åŠ›"
                />
                <span className={`font-medium ${isDarkMode ? 'text-gray-300' : 'text-gray-600'}`}>å††</span>
              </div>
            </div>
            
            {/* ç¨¼åƒæ™‚é–“å…¥åŠ› */}
            <div className={`rounded-2xl shadow-lg p-6 mb-4 ${isDarkMode ? 'bg-gray-800' : 'bg-white'}`}>
              <h2 className={`text-lg font-bold mb-4 flex items-center gap-2 ${isDarkMode ? 'text-white' : 'text-gray-800'}`}>
                <Package />
                ä»Šé€±ã®ç¨¼åƒ
              </h2>
              
              <div className="space-y-2">
                <div className="flex items-center gap-2">
                  <div className="w-8"></div>
                  <div className={`grid grid-cols-3 gap-2 flex-1 text-xs font-medium ${isDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                    <div className="text-center">æ™‚é–“</div>
                    <div className="text-center">ä»¶æ•°</div>
                    <div className="text-center">é‡‘é¡</div>
                  </div>
                </div>
                {days.map((day, index) => {
                  // ã“ã®æ—¥ã¾ã§ã®ç´¯ç©é…é”ä»¶æ•°ã¨ã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬ã‚’è¨ˆç®—
                  const effectiveValues = getEffectiveValues();
                  const isWeekday = weekdays.includes(day);

                  // ã“ã®æ—¥ã«æ–°ãŸã«é”æˆã—ãŸã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬ã®ã¿ã‚’è¨ˆç®—
                  let dayQuestReward = 0;

                  if (hours[day].hours > 0) {
                    // å¹³æ—¥ï¼ˆæœˆï½æœ¨ï¼‰ã®ã‚¯ã‚¨ã‚¹ãƒˆè¨ˆç®—
                    if (isWeekday) {
                      let cumulativeBefore = 0; // å‰æ—¥ã¾ã§ã®ç´¯ç©
                      let cumulativeAfter = 0;  // ã“ã®æ—¥ã¾ã§ã®ç´¯ç©
                      let questIndex = 0;
                      let cumulativeThreshold = 0;

                      for (let i = 0; i < days.length; i++) {
                        const d = days[i];
                        if (!weekdays.includes(d)) continue; // å¹³æ—¥ã®ã¿

                        const dayData = hours[d];
                        const dayDeliveries = dayData.deliveries > 0 ? dayData.deliveries : dayData.hours * effectiveValues.weekdayDeliveriesPerHour;

                        if (d === day) {
                          // ã“ã®æ—¥ã®å‰ã¾ã§ã®ç´¯ç©ã‚’ä¿å­˜
                          cumulativeBefore = cumulativeAfter;
                          cumulativeAfter += dayDeliveries;

                          // å‰æ—¥ã¾ã§ã«é”æˆã—ã¦ã„ãŸã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—
                          while (questIndex < weekdayQuests.length) {
                            const nextThreshold = cumulativeThreshold + weekdayQuests[questIndex].count;
                            if (cumulativeBefore >= nextThreshold) {
                              cumulativeThreshold = nextThreshold;
                              questIndex++;
                            } else {
                              break;
                            }
                          }

                          // ã“ã®æ—¥ã«æ–°ãŸã«é”æˆã—ãŸã‚¯ã‚¨ã‚¹ãƒˆã®ã¿ã‚’åŠ ç®—
                          while (questIndex < weekdayQuests.length) {
                            const nextThreshold = cumulativeThreshold + weekdayQuests[questIndex].count;
                            if (cumulativeAfter >= nextThreshold) {
                              dayQuestReward += weekdayQuests[questIndex].reward;
                              cumulativeThreshold = nextThreshold;
                              questIndex++;
                            } else {
                              break;
                            }
                          }
                          break;
                        }

                        cumulativeAfter += dayDeliveries;
                      }
                    } else {
                      // ä¼‘æ—¥ï¼ˆé‡‘ï½æ—¥ï¼‰ã®ã‚¯ã‚¨ã‚¹ãƒˆè¨ˆç®—
                      let cumulativeBefore = 0; // å‰æ—¥ã¾ã§ã®ç´¯ç©
                      let cumulativeAfter = 0;  // ã“ã®æ—¥ã¾ã§ã®ç´¯ç©
                      let questIndex = 0;
                      let cumulativeThreshold = 0;

                      for (let i = 0; i < days.length; i++) {
                        const d = days[i];
                        if (weekdays.includes(d)) continue; // ä¼‘æ—¥ã®ã¿

                        const dayData = hours[d];
                        const dayDeliveries = dayData.deliveries > 0 ? dayData.deliveries : dayData.hours * effectiveValues.weekendDeliveriesPerHour;

                        if (d === day) {
                          // ã“ã®æ—¥ã®å‰ã¾ã§ã®ç´¯ç©ã‚’ä¿å­˜
                          cumulativeBefore = cumulativeAfter;
                          cumulativeAfter += dayDeliveries;

                          // å‰æ—¥ã¾ã§ã«é”æˆã—ã¦ã„ãŸã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—
                          while (questIndex < weekendQuests.length) {
                            const nextThreshold = cumulativeThreshold + weekendQuests[questIndex].count;
                            if (cumulativeBefore >= nextThreshold) {
                              cumulativeThreshold = nextThreshold;
                              questIndex++;
                            } else {
                              break;
                            }
                          }

                          // ã“ã®æ—¥ã«æ–°ãŸã«é”æˆã—ãŸã‚¯ã‚¨ã‚¹ãƒˆã®ã¿ã‚’åŠ ç®—
                          while (questIndex < weekendQuests.length) {
                            const nextThreshold = cumulativeThreshold + weekendQuests[questIndex].count;
                            if (cumulativeAfter >= nextThreshold) {
                              dayQuestReward += weekendQuests[questIndex].reward;
                              cumulativeThreshold = nextThreshold;
                              questIndex++;
                            } else {
                              break;
                            }
                          }
                          break;
                        }

                        cumulativeAfter += dayDeliveries;
                      }
                    }
                  }

                  return (
                    <div key={day} className="flex items-center gap-2">
                      <div className={`font-medium w-8 text-center rounded-lg py-1 ${dayQuestReward > 0 ? 'bg-yellow-400 text-gray-900' : isDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>{day}</div>
                      <div className="grid grid-cols-3 gap-2 flex-1">
                        <input
                          type="number"
                          step="0.2"
                          value={hours[day].hours || ''}
                          onChange={(e) => updateHours(day, 'hours', e.target.value)}
                          onKeyDown={handleKeyDown}
                          className={`w-full px-2 py-2 border-2 rounded-lg focus:outline-none text-sm text-center ${isDarkMode ? 'bg-gray-700 border-gray-600 text-white focus:border-blue-400' : 'border-gray-200 focus:border-blue-500'}`}
                          placeholder="0"
                        />
                        <input
                          type="number"
                          value={hours[day].deliveries || ''}
                          onChange={(e) => updateHours(day, 'deliveries', e.target.value)}
                          onKeyDown={handleKeyDown}
                          className={`w-full px-2 py-2 border-2 rounded-lg focus:outline-none text-sm text-center ${isDarkMode ? 'bg-gray-700 border-gray-600 text-white focus:border-blue-400' : 'border-gray-200 focus:border-blue-500'}`}
                          placeholder={hours[day].hours > 0 ? (() => {
                            const deliveries = isWeekday ? effectiveValues.weekdayDeliveriesPerHour : effectiveValues.weekendDeliveriesPerHour;
                            return Math.floor(hours[day].hours * deliveries).toString();
                          })() : "0"}
                        />
                        <input
                          type="number"
                          step="10"
                          value={hours[day].earnings || ''}
                          onChange={(e) => updateHours(day, 'earnings', e.target.value)}
                          onKeyDown={handleKeyDown}
                          className={`w-full px-2 py-2 border-2 rounded-lg focus:outline-none text-sm text-center ${isDarkMode ? 'bg-gray-700 border-gray-600 text-white focus:border-blue-400' : 'border-gray-200 focus:border-blue-500'}`}
                          placeholder={hours[day].hours > 0 ? (() => {
                            const price = isWeekday ? effectiveValues.weekdayAvgPrice : effectiveValues.weekendAvgPrice;
                            const deliveries = isWeekday ? effectiveValues.weekdayDeliveriesPerHour : effectiveValues.weekendDeliveriesPerHour;
                            const basicEarnings = Math.floor(hours[day].hours * deliveries * price);
                            return (basicEarnings + dayQuestReward).toString();
                          })() : "0"}
                        />
                      </div>
                    </div>
                  );
                })}
              </div>
              
              <div className={`mt-4 p-3 rounded-lg ${isDarkMode ? 'bg-gray-700' : 'bg-blue-50'}`}>
                <p className={`text-xs ${isDarkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                  ğŸ’¡ æ™‚é–“ã®ã¿å…¥åŠ›ã§äºˆæƒ³é‡‘é¡ã‚’è¨ˆç®—<br/>
                  ã™ã¹ã¦å…¥åŠ›ã§å®Ÿç¸¾å€¤ã‚’åæ˜ 
                </p>
              </div>
            </div>
            
            {/* çµæœè¡¨ç¤º */}
            <div className="bg-gradient-to-br from-green-500 to-blue-500 rounded-2xl shadow-xl p-6 text-white">
              <button
                onClick={() => setShowWeeklySalesList(true)}
                className="w-full mb-6 bg-white/20 hover:bg-white/30 px-4 py-3 rounded-xl transition-colors"
              >
                <h2 className="text-xl font-bold">é€±é–“å£²ä¸Š</h2>
                <div className="text-xs opacity-80 mt-1">
                  {(() => {
                    const start = new Date(currentWeekStart);
                    const end = new Date(start);
                    end.setDate(end.getDate() + 6);
                    return `ä»Šé€±: ${start.getMonth() + 1}/${start.getDate()} - ${end.getMonth() + 1}/${end.getDate()} (ã‚¿ãƒƒãƒ—ã§ä¸€è¦§è¡¨ç¤º)`;
                  })()}
                </div>
              </button>
              
              <div className="space-y-4">
                {/* åˆè¨ˆç¨¼åƒæ™‚é–“ã¨åˆè¨ˆé…é”ä»¶æ•° */}
                <div className="grid grid-cols-2 gap-3">
                  <div className="bg-white/20 backdrop-blur-sm rounded-xl p-4">
                    <div className="text-sm opacity-90 mb-1">åˆè¨ˆç¨¼åƒæ™‚é–“</div>
                    <div className="text-2xl font-bold">{results.totalHours} æ™‚é–“</div>
                    <div className="text-xs opacity-80 mt-2">
                      <div>æœˆï½æœ¨: {results.weekdayHours}æ™‚é–“</div>
                      <div>é‡‘ï½æ—¥: {results.weekendHours}æ™‚é–“</div>
                    </div>
                  </div>

                  <div className="bg-white/20 backdrop-blur-sm rounded-xl p-4">
                    <div className="text-sm opacity-90 mb-1">åˆè¨ˆé…é”ä»¶æ•°</div>
                    <div className="text-2xl font-bold">{results.totalDeliveries} ä»¶</div>
                    <div className="text-xs opacity-80 mt-2">
                      <div>æœˆï½æœ¨: {results.weekdayDeliveries}ä»¶</div>
                      <div>é‡‘ï½æ—¥: {results.weekendDeliveries}ä»¶</div>
                    </div>
                  </div>
                </div>

                {/* åŸºæœ¬å£²ä¸Šã¨ã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬ */}
                <div className="grid grid-cols-2 gap-3">
                  <div className="bg-white/20 backdrop-blur-sm rounded-xl p-4">
                    <div className="text-sm opacity-90 mb-1">åŸºæœ¬å£²ä¸Š</div>
                    <div className="text-2xl font-bold">Â¥{results.basicEarnings.toLocaleString()}</div>
                  </div>

                  <div className="bg-white/20 backdrop-blur-sm rounded-xl p-4">
                    <div className="text-sm opacity-90 mb-1">ã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬</div>
                    <div className="text-2xl font-bold">Â¥{results.questEarnings.toLocaleString()}</div>
                  </div>
                </div>
                
                <div className="bg-white/30 backdrop-blur-sm rounded-xl p-5 border-2 border-white/50">
                  <div className="text-sm opacity-90 mb-1">é€±é–“åˆè¨ˆå£²ä¸Š</div>
                  <div className="text-4xl font-bold">Â¥{results.totalEarnings.toLocaleString()}</div>
                </div>
                
                {/* 1æ—¥å¹³å‡ã¨å¹³å‡æ™‚çµ¦ */}
                {(results.daysWorked > 0 || parseFloat(results.totalHours) > 0) && (
                  <div className="grid grid-cols-2 gap-3">
                    {results.daysWorked > 0 && (
                      <div className="bg-white/20 backdrop-blur-sm rounded-xl p-4">
                        <div className="text-sm opacity-90 mb-1">1æ—¥å¹³å‡({results.daysWorked}æ—¥ç¨¼åƒ)</div>
                        <div className="text-2xl font-bold">Â¥{results.avgPerDay.toLocaleString()}</div>
                      </div>
                    )}

                    {parseFloat(results.totalHours) > 0 && (
                      <div className="bg-white/20 backdrop-blur-sm rounded-xl p-4">
                        <div className="text-sm opacity-90 mb-1">å¹³å‡æ™‚çµ¦</div>
                        <div className="text-2xl font-bold">Â¥{results.avgHourlyWage.toLocaleString()}</div>
                      </div>
                    )}
                  </div>
                )}
                
                {targetAmount > 0 && results.totalEarnings < targetAmount && parseFloat(results.hoursNeeded) > 0 && (
                  <div className="bg-red-500/30 backdrop-blur-sm rounded-xl p-4 border-2 border-red-400">
                    <div className="text-sm opacity-90 mb-1">ç›®æ¨™é”æˆã¾ã§</div>
                    <div className="text-2xl font-bold">ã‚ã¨ {results.hoursNeeded} æ™‚é–“</div>
                    <div className="text-xs opacity-80 mt-1">æ®‹ã‚Š Â¥{(targetAmount - results.totalEarnings).toLocaleString()}</div>
                  </div>
                )}
                
                {targetAmount > 0 && results.totalEarnings >= targetAmount && (
                  <div className="bg-yellow-500/30 backdrop-blur-sm rounded-xl p-4 border-2 border-yellow-400">
                    <div className="text-2xl font-bold">ğŸ‰ ç›®æ¨™é”æˆï¼</div>
                    <div className="text-sm opacity-90 mt-1">ç›®æ¨™ Â¥{targetAmount.toLocaleString()} é”æˆ</div>
                  </div>
                )}
              </div>
            </div>

            {/* å…¨æœŸé–“é›†è¨ˆãƒ¢ãƒ¼ãƒ€ãƒ« */}
            {showTotalStats && (
              <div
                className={`fixed inset-0 z-50 ${isDarkMode ? 'bg-gray-900' : 'bg-white'}`}
                style={{
                  display: 'flex',
                  flexDirection: 'column',
                  overflow: 'hidden'
                }}
              >
                <div
                  className={`border-b p-4 flex items-center justify-between ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}
                  style={{flexShrink: 0, touchAction: 'none'}}
                >
                  <h2 className={`text-xl font-bold flex items-center gap-2 ${isDarkMode ? 'text-white' : 'text-gray-800'}`}>
                    <img src="ã‚¢ã‚¤ã‚³ãƒ³.jpg?v=5" alt="å…¨æœŸé–“é›†è¨ˆ" className="w-8 h-8 rounded-lg" />
                    <span>å…¨æœŸé–“é›†è¨ˆã€{Object.keys(dailyData || {}).length}æ—¥ã€‘</span>
                  </h2>
                  <button
                    onClick={() => setShowTotalStats(false)}
                    className={`text-2xl ${isDarkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}`}
                    style={{touchAction: 'auto'}}
                  >
                    Ã—
                  </button>
                </div>

                {/* ã‚¿ãƒ– */}
                <div className={`flex border-b ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`} style={{flexShrink: 0}}>
                    <button
                      onClick={() => setTotalStatsTab('summary')}
                      className={`flex-1 py-3 text-sm font-medium transition-colors ${
                        totalStatsTab === 'summary'
                          ? isDarkMode
                            ? 'text-green-400 border-b-2 border-green-400 bg-gray-700'
                            : 'text-green-600 border-b-2 border-green-600 bg-green-50'
                          : isDarkMode
                            ? 'text-gray-400 hover:text-gray-200 hover:bg-gray-700'
                            : 'text-gray-600 hover:text-gray-800 hover:bg-gray-50'
                      }`}
                    >
                      ç·åˆè¨ˆ
                    </button>
                    <button
                      onClick={() => setTotalStatsTab('daily')}
                      className={`flex-1 py-3 text-sm font-medium transition-colors ${
                        totalStatsTab === 'daily'
                          ? isDarkMode
                            ? 'text-green-400 border-b-2 border-green-400 bg-gray-700'
                            : 'text-green-600 border-b-2 border-green-600 bg-green-50'
                          : isDarkMode
                            ? 'text-gray-400 hover:text-gray-200 hover:bg-gray-700'
                            : 'text-gray-600 hover:text-gray-800 hover:bg-gray-50'
                      }`}
                    >
                      æ›œæ—¥åˆ¥å¹³å‡
                    </button>
                </div>

                <div
                  style={{
                    flex: 1,
                    overflowY: 'auto',
                    WebkitOverflowScrolling: 'touch',
                    minHeight: 0
                  }}
                >
                  <div className="p-6">
                    {(() => {
                      try {
                        const allEntries = Object.entries(dailyData || {});
                        if (allEntries.length === 0) {
                          return (
                            <div className="text-center text-gray-500 py-8">
                              ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
                            </div>
                          );
                        }

                        // ç·åˆè¨ˆã‚¿ãƒ–
                        if (totalStatsTab === 'summary') {
                          let totalHours = 0;
                          let totalDeliveries = 0;
                          let totalEarnings = 0;
                          let totalQuest = 0;

                          allEntries.forEach(([, data]) => {
                            if (data) {
                              totalHours += data.hours || 0;
                              totalDeliveries += data.deliveries || 0;
                              totalEarnings += data.earnings || 0;
                              totalQuest += data.quest || 0;
                            }
                          });

                          const totalSales = totalEarnings + totalQuest;
                          const avgPricePerDelivery = totalDeliveries > 0 ? totalEarnings / totalDeliveries : 0;
                          const deliveriesPerHour = totalHours > 0 ? totalDeliveries / totalHours : 0;
                          const earningsPerHour = totalHours > 0 ? totalSales / totalHours : 0;

                          // å…¨æœŸé–“ã®çµŒè²»ã‚’è¨ˆç®—
                          const totalExpenses = Object.entries(expenses || {}).reduce((sum, [id, expense]) => {
                            const percentage = expense.businessPercentage ?? 100;
                            return sum + Math.floor(expense.amount * percentage / 100);
                          }, 0);

                          const netProfit = totalSales - totalExpenses;

                          return (
                        <div className="space-y-4">
                          {/* åˆè¨ˆå£²ä¸Š */}
                          <div className="bg-green-50 rounded-xl p-4 border-2 border-green-200">
                            <div className="text-sm text-gray-600 mb-1">åˆè¨ˆå£²ä¸Š</div>
                            <div className="text-2xl font-bold text-green-600">
                              Â¥{Math.floor(totalSales).toLocaleString()}
                            </div>
                            <div className="text-xs text-gray-500 mt-1">
                              åŸºæœ¬: Â¥{Math.floor(totalEarnings).toLocaleString()} + ã‚¯ã‚¨ã‚¹ãƒˆ: Â¥{Math.floor(totalQuest).toLocaleString()}
                            </div>
                          </div>

                          {/* åˆè¨ˆçµŒè²» */}
                          <div className="bg-red-50 rounded-xl p-4 border-2 border-red-200">
                            <div className="text-sm text-gray-600 mb-1">åˆè¨ˆçµŒè²»</div>
                            <div className="text-2xl font-bold text-red-600">
                              Â¥{totalExpenses.toLocaleString()}
                            </div>
                          </div>

                          {/* ç´”åˆ©ç›Š (å£²ä¸Š - çµŒè²») */}
                          <div className="bg-blue-50 rounded-xl p-4 border-2 border-blue-200">
                            <div className="text-sm text-gray-600 mb-1">ç´”åˆ©ç›Š (å£²ä¸Š - çµŒè²»)</div>
                            <div className="text-2xl font-bold text-blue-600">
                              Â¥{netProfit.toLocaleString()}
                            </div>
                          </div>

                          {/* ç·ç¨¼åƒæ™‚é–“ã¨ç·é…é”ä»¶æ•° */}
                          <div className="grid grid-cols-2 gap-3">
                            <div className="bg-blue-50 rounded-xl p-4">
                              <div className="text-sm text-gray-600 mb-1">ç·ç¨¼åƒæ™‚é–“</div>
                              <div className="text-xl font-bold text-blue-600">
                                {totalHours.toFixed(1)}æ™‚é–“
                              </div>
                            </div>

                            <div className="bg-purple-50 rounded-xl p-4">
                              <div className="text-sm text-gray-600 mb-1">ç·é…é”ä»¶æ•°</div>
                              <div className="text-xl font-bold text-purple-600">
                                {totalDeliveries}ä»¶
                              </div>
                            </div>
                          </div>

                          {/* å¹³å‡å€¤ */}
                          <div className="bg-gray-50 rounded-xl p-4 space-y-2">
                            <div className="text-sm font-medium text-gray-700 mb-2">ğŸ“Š å¹³å‡å€¤</div>
                            <div className="grid grid-cols-2 gap-3 text-sm">
                              <div>
                                <div className="text-gray-600">å¹³å‡å˜ä¾¡</div>
                                <div className="font-bold text-gray-800">Â¥{Math.floor(avgPricePerDelivery).toLocaleString()}/ä»¶</div>
                              </div>
                              <div>
                                <div className="text-gray-600">æ™‚çµ¦æ›ç®—</div>
                                <div className="font-bold text-gray-800">Â¥{Math.floor(earningsPerHour).toLocaleString()}/h</div>
                              </div>
                              <div>
                                <div className="text-gray-600">é…é”ä»¶æ•°</div>
                                <div className="font-bold text-gray-800">{deliveriesPerHour.toFixed(1)}ä»¶/h</div>
                              </div>
                              <div>
                                <div className="text-gray-600">æ—¥å¹³å‡å£²ä¸Š</div>
                                <div className="font-bold text-gray-800">Â¥{Math.floor(totalSales / allEntries.length).toLocaleString()}/æ—¥</div>
                              </div>
                            </div>
                          </div>
                        </div>
                          );
                        }

                        // æ›œæ—¥åˆ¥å¹³å‡ã‚¿ãƒ–
                        if (totalStatsTab === 'daily') {
                          // æ›œæ—¥ã”ã¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
                          const dayOfWeekData = [0, 1, 2, 3, 4, 5, 6].map(dow => ({
                            dow,
                            hours: 0,
                            deliveries: 0,
                            earnings: 0,
                            quest: 0,
                            count: 0
                          }));

                          // é›¨ã®æ—¥ã¨ç¥æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ¥é€”é›†è¨ˆ
                          const rainyData = { hours: 0, deliveries: 0, earnings: 0, quest: 0, count: 0 };
                          const holidayData = { hours: 0, deliveries: 0, earnings: 0, quest: 0, count: 0 };

                          allEntries.forEach(([dateStr, data]) => {
                            if (data) {
                              // æ™‚é–“ã€ä»¶æ•°ã€é‡‘é¡ã®å…¨ã¦ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹æ—¥ã®ã¿ã‚’é›†è¨ˆ
                              const hasCompleteData = (data.hours > 0) && (data.deliveries > 0) && (data.earnings > 0);
                              if (hasCompleteData) {
                                // é›¨ã®æ—¥ã¯åˆ¥é€”é›†è¨ˆ
                                if (data.isRainy) {
                                  rainyData.hours += data.hours || 0;
                                  rainyData.deliveries += data.deliveries || 0;
                                  rainyData.earnings += data.earnings || 0;
                                  rainyData.quest += data.quest || 0;
                                  rainyData.count += 1;
                                  return;
                                }

                                // ç¥æ—¥ã¯åˆ¥é€”é›†è¨ˆ
                                if (data.isHoliday) {
                                  holidayData.hours += data.hours || 0;
                                  holidayData.deliveries += data.deliveries || 0;
                                  holidayData.earnings += data.earnings || 0;
                                  holidayData.quest += data.quest || 0;
                                  holidayData.count += 1;
                                  return;
                                }

                                // é€šå¸¸æ—¥ã‚’æ›œæ—¥åˆ¥ã«é›†è¨ˆ
                                const date = new Date(dateStr + 'T00:00:00');
                                const dow = date.getDay(); // 0=æ—¥, 1=æœˆ, ..., 6=åœŸ
                                dayOfWeekData[dow].hours += data.hours || 0;
                                dayOfWeekData[dow].deliveries += data.deliveries || 0;
                                dayOfWeekData[dow].earnings += data.earnings || 0;
                                dayOfWeekData[dow].quest += data.quest || 0;
                                dayOfWeekData[dow].count += 1;
                              }
                            }
                          });

                          const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

                          // æœˆæ›œæ—¥å§‹ã¾ã‚Šã«ä¸¦ã³æ›¿ãˆ: [æœˆ1, ç«2, æ°´3, æœ¨4, é‡‘5, åœŸ6, æ—¥0]
                          const sortedDayData = [1, 2, 3, 4, 5, 6, 0].map(dow => dayOfWeekData[dow]);

                          // é›¨ã®æ—¥ã¨ç¥æ—¥ã®å¹³å‡æ™‚çµ¦ã‚’è¨ˆç®—ï¼ˆã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬ã‚’å«ã‚ãªã„ï¼‰
                          const rainyAvgHourlyWage = rainyData.hours > 0 ? rainyData.earnings / rainyData.hours : 0;
                          const holidayAvgHourlyWage = holidayData.hours > 0 ? holidayData.earnings / holidayData.hours : 0;

                          // ã‚°ãƒ©ãƒ•ç”¨ã®æœ€å¤§å€¤ã‚’è¨ˆç®—ï¼ˆé›¨ã®æ—¥ã¨ç¥æ—¥ã‚‚å«ã‚ã‚‹ï¼‰
                          const allWages = [
                            ...sortedDayData.map(d => {
                              if (d.count === 0) return 0;
                              return d.hours > 0 ? d.earnings / d.hours : 0;  // ã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬ã‚’å«ã‚ãªã„
                            }),
                            rainyAvgHourlyWage,
                            holidayAvgHourlyWage
                          ];
                          const maxHourlyWage = Math.max(...allWages);

                          return (
                            <div className="space-y-4">
                              {/* å¹³å‡æ™‚çµ¦ã‚°ãƒ©ãƒ• */}
                              <div className="bg-gradient-to-br from-green-50 to-blue-50 rounded-xl p-4 border border-green-200">
                                <div className="text-sm font-medium text-gray-700 mb-3">ğŸ“Š å¹³å‡æ™‚çµ¦ã‚°ãƒ©ãƒ•</div>
                                <div className="space-y-2">
                                  {sortedDayData.map((dayData, idx) => {
                                    if (dayData.count === 0) return null;
                                    const avgHourlyWage = dayData.hours > 0 ? dayData.earnings / dayData.hours : 0;  // ã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬ã‚’å«ã‚ãªã„
                                    const widthPercent = maxHourlyWage > 0 ? (avgHourlyWage / maxHourlyWage) * 100 : 0;

                                    return (
                                      <div key={dayData.dow} className="flex items-center gap-2">
                                        <div className="text-xs font-medium text-gray-700 w-6">{dayNames[dayData.dow]}</div>
                                        <div className="flex-1 bg-white rounded-full h-6 overflow-hidden">
                                          <div
                                            className="bg-gradient-to-r from-green-500 to-blue-500 h-full rounded-full flex items-center justify-end pr-2 transition-all duration-300"
                                            style={{ width: `${widthPercent}%` }}
                                          >
                                            {widthPercent > 20 && (
                                              <span className="text-xs font-bold text-white">Â¥{Math.floor(avgHourlyWage).toLocaleString()}</span>
                                            )}
                                          </div>
                                        </div>
                                        {widthPercent <= 20 && (
                                          <span className="text-xs font-bold text-gray-700 w-16">Â¥{Math.floor(avgHourlyWage).toLocaleString()}</span>
                                        )}
                                      </div>
                                    );
                                  })}

                                  {/* é›¨ã®æ—¥ */}
                                  {rainyData.count > 0 && (() => {
                                    const widthPercent = maxHourlyWage > 0 ? (rainyAvgHourlyWage / maxHourlyWage) * 100 : 0;
                                    return (
                                      <div className="flex items-center gap-2">
                                        <div className="text-xs font-medium text-cyan-700 w-6">ğŸŒ§ï¸</div>
                                        <div className="flex-1 bg-white rounded-full h-6 overflow-hidden">
                                          <div
                                            className="bg-gradient-to-r from-cyan-500 to-blue-500 h-full rounded-full flex items-center justify-end pr-2 transition-all duration-300"
                                            style={{ width: `${widthPercent}%` }}
                                          >
                                            {widthPercent > 20 && (
                                              <span className="text-xs font-bold text-white">Â¥{Math.floor(rainyAvgHourlyWage).toLocaleString()}</span>
                                            )}
                                          </div>
                                        </div>
                                        {widthPercent <= 20 && (
                                          <span className="text-xs font-bold text-cyan-700 w-16">Â¥{Math.floor(rainyAvgHourlyWage).toLocaleString()}</span>
                                        )}
                                      </div>
                                    );
                                  })()}

                                  {/* ç¥æ—¥ */}
                                  {holidayData.count > 0 && (() => {
                                    const widthPercent = maxHourlyWage > 0 ? (holidayAvgHourlyWage / maxHourlyWage) * 100 : 0;
                                    return (
                                      <div className="flex items-center gap-2">
                                        <div className="text-xs font-medium text-orange-700 w-6">ğŸŒ</div>
                                        <div className="flex-1 bg-white rounded-full h-6 overflow-hidden">
                                          <div
                                            className="bg-gradient-to-r from-orange-500 to-red-500 h-full rounded-full flex items-center justify-end pr-2 transition-all duration-300"
                                            style={{ width: `${widthPercent}%` }}
                                          >
                                            {widthPercent > 20 && (
                                              <span className="text-xs font-bold text-white">Â¥{Math.floor(holidayAvgHourlyWage).toLocaleString()}</span>
                                            )}
                                          </div>
                                        </div>
                                        {widthPercent <= 20 && (
                                          <span className="text-xs font-bold text-orange-700 w-16">Â¥{Math.floor(holidayAvgHourlyWage).toLocaleString()}</span>
                                        )}
                                      </div>
                                    );
                                  })()}
                                </div>
                              </div>

                              {/* æ›œæ—¥åˆ¥è©³ç´° */}
                              {sortedDayData.map(dayData => {
                                if (dayData.count === 0) return null;

                                const avgHours = dayData.hours / dayData.count;
                                const avgDeliveries = dayData.deliveries / dayData.count;
                                const avgEarnings = dayData.earnings / dayData.count;
                                const avgQuest = dayData.quest / dayData.count;
                                const avgTotal = avgEarnings;  // ã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬ã‚’å«ã‚ãªã„
                                const avgPrice = dayData.deliveries > 0 ? dayData.earnings / dayData.deliveries : 0;
                                const avgDeliveriesPerHour = dayData.hours > 0 ? dayData.deliveries / dayData.hours : 0;
                                const avgHourlyWage = dayData.hours > 0 ? dayData.earnings / dayData.hours : 0;  // ã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬ã‚’å«ã‚ãªã„

                                return (
                                  <div key={dayData.dow} className="bg-gray-50 rounded-xl p-4">
                                    <div className="font-bold text-gray-800 mb-3 flex items-center justify-between">
                                      <span>{dayNames[dayData.dow]}æ›œæ—¥</span>
                                      <span className="text-xs text-gray-500">{dayData.count}æ—¥åˆ†</span>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3 text-sm">
                                      <div>
                                        <div className="text-gray-600">å¹³å‡å˜ä¾¡</div>
                                        <div className="font-bold text-gray-800">Â¥{Math.floor(avgPrice).toLocaleString()}/ä»¶</div>
                                      </div>
                                      <div>
                                        <div className="text-gray-600">å¹³å‡æ™‚çµ¦</div>
                                        <div className="font-bold text-green-600">Â¥{Math.floor(avgHourlyWage).toLocaleString()}/h</div>
                                      </div>
                                      <div>
                                        <div className="text-gray-600">æ™‚é–“é…é”ä»¶æ•°</div>
                                        <div className="font-bold text-gray-800">{avgDeliveriesPerHour.toFixed(1)}ä»¶/h</div>
                                      </div>
                                      <div>
                                        <div className="text-gray-600">å¹³å‡å£²ä¸Š</div>
                                        <div className="font-bold text-gray-800">Â¥{Math.floor(avgTotal).toLocaleString()}</div>
                                      </div>
                                    </div>
                                  </div>
                                );
                              })}

                              {/* é›¨ã®æ—¥ã®å¹³å‡ */}
                              {rainyData.count > 0 && (() => {
                                const avgHours = rainyData.hours / rainyData.count;
                                const avgDeliveries = rainyData.deliveries / rainyData.count;
                                const avgEarnings = rainyData.earnings / rainyData.count;
                                const avgQuest = rainyData.quest / rainyData.count;
                                const avgTotal = avgEarnings;  // ã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬ã‚’å«ã‚ãªã„
                                const avgPrice = rainyData.deliveries > 0 ? rainyData.earnings / rainyData.deliveries : 0;
                                const avgDeliveriesPerHour = rainyData.hours > 0 ? rainyData.deliveries / rainyData.hours : 0;
                                const avgHourlyWage = rainyData.hours > 0 ? rainyData.earnings / rainyData.hours : 0;  // ã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬ã‚’å«ã‚ãªã„

                                return (
                                  <div className="bg-gradient-to-br from-cyan-50 to-blue-50 rounded-xl p-4 border-2 border-cyan-200">
                                    <div className="font-bold text-cyan-800 mb-3 flex items-center justify-between">
                                      <span>ğŸŒ§ï¸ é›¨ã®æ—¥</span>
                                      <span className="text-xs text-cyan-600">{rainyData.count}æ—¥åˆ†</span>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3 text-sm">
                                      <div>
                                        <div className="text-gray-600">å¹³å‡å˜ä¾¡</div>
                                        <div className="font-bold text-gray-800">Â¥{Math.floor(avgPrice).toLocaleString()}/ä»¶</div>
                                      </div>
                                      <div>
                                        <div className="text-gray-600">å¹³å‡æ™‚çµ¦</div>
                                        <div className="font-bold text-cyan-600">Â¥{Math.floor(avgHourlyWage).toLocaleString()}/h</div>
                                      </div>
                                      <div>
                                        <div className="text-gray-600">æ™‚é–“é…é”ä»¶æ•°</div>
                                        <div className="font-bold text-gray-800">{avgDeliveriesPerHour.toFixed(1)}ä»¶/h</div>
                                      </div>
                                      <div>
                                        <div className="text-gray-600">å¹³å‡å£²ä¸Š</div>
                                        <div className="font-bold text-gray-800">Â¥{Math.floor(avgTotal).toLocaleString()}</div>
                                      </div>
                                    </div>
                                  </div>
                                );
                              })()}

                              {/* ç¥æ—¥ã®å¹³å‡ */}
                              {holidayData.count > 0 && (() => {
                                const avgHours = holidayData.hours / holidayData.count;
                                const avgDeliveries = holidayData.deliveries / holidayData.count;
                                const avgEarnings = holidayData.earnings / holidayData.count;
                                const avgQuest = holidayData.quest / holidayData.count;
                                const avgTotal = avgEarnings;  // ã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬ã‚’å«ã‚ãªã„
                                const avgPrice = holidayData.deliveries > 0 ? holidayData.earnings / holidayData.deliveries : 0;
                                const avgDeliveriesPerHour = holidayData.hours > 0 ? holidayData.deliveries / holidayData.hours : 0;
                                const avgHourlyWage = holidayData.hours > 0 ? holidayData.earnings / holidayData.hours : 0;  // ã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬ã‚’å«ã‚ãªã„

                                return (
                                  <div className="bg-gradient-to-br from-orange-50 to-red-50 rounded-xl p-4 border-2 border-orange-200">
                                    <div className="font-bold text-orange-800 mb-3 flex items-center justify-between">
                                      <span>ğŸŒ ç¥æ—¥</span>
                                      <span className="text-xs text-orange-600">{holidayData.count}æ—¥åˆ†</span>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3 text-sm">
                                      <div>
                                        <div className="text-gray-600">å¹³å‡å˜ä¾¡</div>
                                        <div className="font-bold text-gray-800">Â¥{Math.floor(avgPrice).toLocaleString()}/ä»¶</div>
                                      </div>
                                      <div>
                                        <div className="text-gray-600">å¹³å‡æ™‚çµ¦</div>
                                        <div className="font-bold text-orange-600">Â¥{Math.floor(avgHourlyWage).toLocaleString()}/h</div>
                                      </div>
                                      <div>
                                        <div className="text-gray-600">æ™‚é–“é…é”ä»¶æ•°</div>
                                        <div className="font-bold text-gray-800">{avgDeliveriesPerHour.toFixed(1)}ä»¶/h</div>
                                      </div>
                                      <div>
                                        <div className="text-gray-600">å¹³å‡å£²ä¸Š</div>
                                        <div className="font-bold text-gray-800">Â¥{Math.floor(avgTotal).toLocaleString()}</div>
                                      </div>
                                    </div>
                                  </div>
                                );
                              })()}
                            </div>
                          );
                        }

                        return null;
                      } catch (error) {
                        console.error('å…¨æœŸé–“é›†è¨ˆã‚¨ãƒ©ãƒ¼:', error);
                        return (
                          <div className="text-center text-red-500 py-8">
                            <div className="font-bold mb-2">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>
                            <div className="text-sm">{error.message}</div>
                          </div>
                        );
                      }
                    })()}
                  </div>
                </div>

                <div
                  className={`p-4 border-t ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}
                  style={{flexShrink: 0, touchAction: 'none'}}
                >
                  <button
                    onClick={() => setShowTotalStats(false)}
                    className="w-full bg-gray-500 text-white py-3 rounded-xl font-medium hover:bg-gray-600 transition-colors"
                    style={{touchAction: 'auto'}}
                  >
                    é–‰ã˜ã‚‹
                  </button>
                </div>
              </div>
            )}

            {/* åŸºæœ¬è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */}
            {showBasicSettings && (
              <div
                className={`fixed inset-0 z-50 ${isDarkMode ? 'bg-gray-900' : 'bg-white'}`}
                style={{
                  display: 'flex',
                  flexDirection: 'column',
                  overflow: 'hidden'
                }}
              >
                <div
                  className={`border-b p-4 flex items-center justify-between ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}
                  style={{flexShrink: 0, touchAction: 'none'}}
                >
                    <h2 className={`text-xl font-bold flex items-center gap-2 ${isDarkMode ? 'text-white' : 'text-gray-800'}`}>
                      <span className="text-2xl">âš™ï¸</span>
                      è¨­å®š
                    </h2>
                    <div className="flex items-center gap-2">
                      <button
                        onClick={exportData}
                        className="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 transition-colors"
                        title="ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ"
                        style={{touchAction: 'auto'}}
                      >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                      </button>
                      <input
                        ref={fileInputRef}
                        type="file"
                        accept=".json"
                        onChange={importData}
                        className="hidden"
                      />
                      <button
                        onClick={() => fileInputRef.current?.click()}
                        className="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition-colors"
                        title="ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ"
                        style={{touchAction: 'auto'}}
                      >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                      </button>
                      <button
                        onClick={() => setShowBasicSettings(false)}
                        className={`text-2xl ml-3 ${isDarkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}`}
                        style={{touchAction: 'auto'}}
                      >
                        Ã—
                      </button>
                    </div>
                </div>

                <div
                  style={{
                    flex: 1,
                    overflowY: 'auto',
                    WebkitOverflowScrolling: 'touch',
                    minHeight: 0
                  }}
                >
                  <div className="p-6 space-y-4">
                    {/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ */}
                    <div className="bg-gray-50 rounded-xl p-4 border-2 border-gray-200">
                      <label className="flex items-center justify-between cursor-pointer">
                        <div>
                          <div className="text-sm font-medium text-gray-700">ãƒ†ãƒ¼ãƒ</div>
                          <div className="text-xs text-gray-500 mt-1">
                            {isDarkMode ? 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰' : 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰'}
                          </div>
                        </div>
                        <div className="relative">
                          <input
                            type="checkbox"
                            checked={isDarkMode}
                            onChange={toggleDarkMode}
                            className="sr-only peer"
                          />
                          <div className="w-14 h-7 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-gray-700"></div>
                        </div>
                      </label>
                    </div>

                    {/* ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒ */}
                    <div className="bg-gray-50 rounded-xl p-4 border-2 border-gray-200">
                      <label className="flex items-center justify-between cursor-pointer">
                        <div>
                          <div className="text-sm font-medium text-gray-700">ç®—å‡ºæ–¹æ³•</div>
                          <div className="text-xs text-gray-500 mt-1">
                            {useAutoCalculate ? 'å±¥æ­´ã‹ã‚‰è‡ªå‹•ç®—å‡º' : 'æ‰‹å‹•å…¥åŠ›'}
                          </div>
                        </div>
                        <div className="relative">
                          <input
                            type="checkbox"
                            checked={useAutoCalculate}
                            onChange={(e) => setUseAutoCalculate(e.target.checked)}
                            className="sr-only peer"
                          />
                          <div className="w-14 h-7 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-green-500"></div>
                        </div>
                      </label>
                    </div>

                    {/* å±¥æ­´ã‹ã‚‰ç®—å‡ºã—ãŸå€¤ã‚’è¡¨ç¤º */}
                    {useAutoCalculate && (() => {
                      const calcValues = calculateFromHistory();
                      return (
                        <>
                          <div className="grid grid-cols-2 gap-3">
                            <div className="bg-blue-50 rounded-xl p-4 border-2 border-blue-200">
                              <div className="text-base font-medium text-blue-800 mb-3">ğŸ“Š æœˆï½æœ¨</div>
                              <div className="space-y-2">
                                <div className="text-sm text-gray-700 whitespace-nowrap">
                                  å¹³å‡å˜ä¾¡: <span className="text-lg font-bold text-blue-600">Â¥{calcValues.weekdayAvgPrice}/ä»¶</span>
                                </div>
                                <div className="text-sm text-gray-700 whitespace-nowrap">
                                  å¹³å‡ä»¶æ•°: <span className="text-lg font-bold text-blue-600">{calcValues.weekdayDeliveriesPerHour}ä»¶/h</span>
                                </div>
                              </div>
                            </div>
                            <div className="bg-purple-50 rounded-xl p-4 border-2 border-purple-200">
                              <div className="text-base font-medium text-purple-800 mb-3">ğŸ“Š é‡‘ï½æ—¥</div>
                              <div className="space-y-2">
                                <div className="text-sm text-gray-700 whitespace-nowrap">
                                  å¹³å‡å˜ä¾¡: <span className="text-lg font-bold text-purple-600">Â¥{calcValues.weekendAvgPrice}/ä»¶</span>
                                </div>
                                <div className="text-sm text-gray-700 whitespace-nowrap">
                                  å¹³å‡ä»¶æ•°: <span className="text-lg font-bold text-purple-600">{calcValues.weekendDeliveriesPerHour}ä»¶/h</span>
                                </div>
                              </div>
                            </div>
                          </div>

                          <div className="grid grid-cols-2 gap-3">
                            <div className="bg-cyan-50 rounded-xl p-4 border-2 border-cyan-200">
                              <div className="text-base font-medium text-cyan-800 mb-3">ğŸŒ§ï¸ é›¨ã®æ—¥</div>
                              <div className="space-y-2">
                                <div className="text-sm text-gray-700 whitespace-nowrap">
                                  å¹³å‡å˜ä¾¡: <span className="text-lg font-bold text-cyan-600">Â¥{calcValues.rainyAvgPrice}/ä»¶</span>
                                </div>
                                <div className="text-sm text-gray-700 whitespace-nowrap">
                                  å¹³å‡ä»¶æ•°: <span className="text-lg font-bold text-cyan-600">{calcValues.rainyAvgDeliveries}ä»¶/h</span>
                                </div>
                              </div>
                            </div>
                            <div className="bg-orange-50 rounded-xl p-4 border-2 border-orange-200">
                              <div className="text-base font-medium text-orange-800 mb-3">ğŸŒ ç¥æ—¥</div>
                              <div className="space-y-2">
                                <div className="text-sm text-gray-700 whitespace-nowrap">
                                  å¹³å‡å˜ä¾¡: <span className="text-lg font-bold text-orange-600">Â¥{calcValues.holidayAvgPrice}/ä»¶</span>
                                </div>
                                <div className="text-sm text-gray-700 whitespace-nowrap">
                                  å¹³å‡ä»¶æ•°: <span className="text-lg font-bold text-orange-600">{calcValues.holidayAvgDeliveries}ä»¶/h</span>
                                </div>
                              </div>
                            </div>
                          </div>
                        </>
                      );
                    })()}

                    {/* æ‰‹å‹•å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */}
                    {!useAutoCalculate && (
                      <>
                        <div className="bg-blue-50 rounded-xl p-4 border-2 border-blue-200">
                          <div className="text-sm font-medium text-blue-800 mb-3">ğŸ“ æœˆï½æœ¨</div>
                          <div className="space-y-3">
                            <div>
                              <label className="block text-xs font-medium text-gray-700 mb-1">
                                å¹³å‡å˜ä¾¡(å††/ä»¶)
                              </label>
                              <input
                                type="number"
                                step="10"
                                value={weekdayAvgPrice || ''}
                                onChange={(e) => setWeekdayAvgPrice(parseFloat(e.target.value) || 0)}
                                onKeyDown={handleKeyDown}
                                className="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none text-base"
                              />
                            </div>
                            <div>
                              <label className="block text-xs font-medium text-gray-700 mb-1">
                                1æ™‚é–“å½“ãŸã‚Šã®å¹³å‡é…é”ä»¶æ•°
                              </label>
                              <input
                                type="number"
                                step="0.1"
                                value={weekdayDeliveriesPerHour || ''}
                                onChange={(e) => setWeekdayDeliveriesPerHour(parseFloat(e.target.value) || 0)}
                                onKeyDown={handleKeyDown}
                                className="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none text-base"
                              />
                            </div>
                          </div>
                        </div>

                        <div className="bg-purple-50 rounded-xl p-4 border-2 border-purple-200">
                          <div className="text-sm font-medium text-purple-800 mb-3">ğŸ“ é‡‘ï½æ—¥</div>
                          <div className="space-y-3">
                            <div>
                              <label className="block text-xs font-medium text-gray-700 mb-1">
                                å¹³å‡å˜ä¾¡(å††/ä»¶)
                              </label>
                              <input
                                type="number"
                                step="10"
                                value={weekendAvgPrice || ''}
                                onChange={(e) => setWeekendAvgPrice(parseFloat(e.target.value) || 0)}
                                onKeyDown={handleKeyDown}
                                className="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none text-base"
                              />
                            </div>
                            <div>
                              <label className="block text-xs font-medium text-gray-700 mb-1">
                                1æ™‚é–“å½“ãŸã‚Šã®å¹³å‡é…é”ä»¶æ•°
                              </label>
                              <input
                                type="number"
                                step="0.1"
                                value={weekendDeliveriesPerHour || ''}
                                onChange={(e) => setWeekendDeliveriesPerHour(parseFloat(e.target.value) || 0)}
                                onKeyDown={handleKeyDown}
                                className="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none text-base"
                              />
                            </div>
                          </div>
                        </div>
                      </>
                    )}

                    {/* Vision APIã‚­ãƒ¼è¨­å®š */}
                    <div className="bg-gray-50 rounded-xl p-4 border-2 border-gray-200 mt-4">
                      <h3 className="font-bold text-gray-800 mb-3">ğŸ“· ãƒ¬ã‚·ãƒ¼ãƒˆè‡ªå‹•èªè­˜è¨­å®š</h3>
                      <div className="space-y-3">
                        <div className="text-xs text-gray-600 mb-2">
                          Google Cloud Vision APIã‚’ä½¿ç”¨ã—ã¦ãƒ¬ã‚·ãƒ¼ãƒˆã‹ã‚‰è‡ªå‹•çš„ã«æƒ…å ±ã‚’æŠ½å‡ºã§ãã¾ã™ã€‚
                          æœˆ1000æšã¾ã§ç„¡æ–™ã§ä½¿ç”¨ã§ãã¾ã™ã€‚
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            Vision APIã‚­ãƒ¼
                          </label>
                          <input
                            type="password"
                            value={visionApiKey || ''}
                            onChange={(e) => {
                              const key = e.target.value;
                              setVisionApiKey(key);
                              // localStorageã«ä¿å­˜
                              try {
                                if (key) {
                                  localStorage.setItem('visionApiKey', key);
                                } else {
                                  localStorage.removeItem('visionApiKey');
                                }
                              } catch (err) {
                                console.error('Failed to save API key:', err);
                              }
                              // Supabaseã«ã‚‚ä¿å­˜ï¼ˆè¨­å®šä¿å­˜æ™‚ã«ä¸€æ‹¬ä¿å­˜ã•ã‚Œã‚‹ï¼‰
                            }}
                            placeholder="AIza..."
                            className="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none text-base"
                          />
                          <div className="text-xs text-gray-500 mt-1">
                            â€» è¨­å®šã‚’ä¿å­˜ã™ã‚‹ã¨ã‚¯ãƒ©ã‚¦ãƒ‰ã«æš—å·åŒ–ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™
                          </div>
                          <div className="text-xs text-gray-500 mt-1">
                            <a
                              href="https://console.cloud.google.com/apis/credentials"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="text-blue-500 hover:underline"
                            >
                              APIã‚­ãƒ¼ã®å–å¾—ã¯ã“ã¡ã‚‰
                            </a>
                            ï¼ˆCloud Vision APIã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„ï¼‰
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* CSVå‡ºåŠ› */}
                    <div className="bg-purple-50 rounded-xl p-4 border-2 border-purple-200 mt-4">
                      <h3 className="font-bold text-gray-800 mb-3">ğŸ“Š ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›</h3>
                      <div className="text-xs text-gray-600 mb-3">
                        å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚„çµŒè²»ãƒ‡ãƒ¼ã‚¿ã‚’CSVå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™
                      </div>
                      <div className="space-y-2">
                        <button
                          onClick={() => {
                            const csvContent = generateSalesCSV();
                            if (csvContent) {
                              const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                              const url = URL.createObjectURL(blob);
                              const a = document.createElement('a');
                              a.href = url;
                              a.download = `å£²ä¸Šãƒ‡ãƒ¼ã‚¿_${formatDateToLocal(new Date())}.csv`;
                              document.body.appendChild(a);
                              a.click();
                              document.body.removeChild(a);
                              URL.revokeObjectURL(url);
                            }
                          }}
                          className="w-full bg-green-500 text-white py-2 px-4 rounded-lg font-medium hover:bg-green-600 transition-colors"
                        >
                          ğŸ“… å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’CSVå‡ºåŠ›
                        </button>
                        <button
                          onClick={() => {
                            const csvContent = generateExpenseCSV();
                            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `expenses_${formatDateToLocal(new Date())}.csv`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                          }}
                          className="w-full bg-green-500 text-white py-2 px-4 rounded-lg font-medium hover:bg-green-600 transition-colors"
                        >
                          ğŸ’° çµŒè²»ãƒ‡ãƒ¼ã‚¿ã‚’CSVå‡ºåŠ›
                        </button>
                      </div>
                    </div>

                    {/* ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ */}
                    <div className="mt-4">
                      <button
                        onClick={async () => {
                          if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                            await supabaseClient.auth.signOut();
                          }
                        }}
                        className="w-full bg-red-500 text-white py-3 rounded-xl font-medium hover:bg-red-600 transition-colors"
                      >
                        ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                      </button>
                    </div>

                    {/* é›»å­å¸³ç°¿ä¿å­˜æ³•æº–æ‹ è¡¨ç¤º */}
                    <div className="bg-green-50 rounded-lg p-3 mt-4 border border-green-200">
                      <div className="flex items-center gap-2">
                        <span className="text-green-600 text-sm">âœ…</span>
                        <span className="text-xs text-green-700">
                          é›»å­å¸³ç°¿ä¿å­˜æ³•æº–æ‹ ã‚·ã‚¹ãƒ†ãƒ ï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾Œ3å–¶æ¥­æ—¥ã§è‡ªå‹•ç¢ºå®šï¼‰
                        </span>
                      </div>
                    </div>

                  </div>
                </div>

                <div
                  className={`p-4 border-t ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}
                  style={{flexShrink: 0, touchAction: 'none'}}
                >
                  <button
                    onClick={() => setShowBasicSettings(false)}
                    className="w-full bg-gray-500 text-white py-3 rounded-xl font-medium hover:bg-gray-600 transition-colors"
                    style={{touchAction: 'auto'}}
                  >
                    é–‰ã˜ã‚‹
                  </button>
                </div>
              </div>
            )}
            
            {/* å±¥æ­´ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« */}
            {showCalendar && (
              <div
                className={`fixed inset-0 z-50 ${isDarkMode ? 'bg-gray-900' : 'bg-white'}`}
                style={{
                  display: 'flex',
                  flexDirection: 'column',
                  overflow: 'hidden'
                }}
              >
                <div
                  className={`border-b p-4 flex items-center justify-between ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}
                  style={{flexShrink: 0, touchAction: 'none'}}
                >
                    <h2 className={`text-xl font-bold flex items-center gap-2 ${isDarkMode ? 'text-white' : 'text-gray-800'}`}>
                      <span className="text-2xl">ğŸ“…</span>
                      ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
                    </h2>
                    <button
                      onClick={() => setShowCalendar(false)}
                      className={`text-2xl ${isDarkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}`}
                      style={{touchAction: 'auto'}}
                    >
                      âœ•
                    </button>
                </div>

                <div
                  style={{
                    flex: 1,
                    overflowY: 'auto',
                    WebkitOverflowScrolling: 'touch',
                    minHeight: 0
                  }}
                >
                  <div className="p-6">
                    {/* æœˆåˆ‡ã‚Šæ›¿ãˆ */}
                    <div className="flex items-center justify-between mb-4">
                      <button
                        onClick={() => changeMonth(-1)}
                        className={`p-2 rounded-lg transition-colors ${isDarkMode ? 'text-gray-300 hover:bg-gray-700' : 'text-gray-800 hover:bg-gray-100'}`}
                      >
                        â† å‰æœˆ
                      </button>
                      <h3 className={`text-lg font-bold ${isDarkMode ? 'text-white' : 'text-gray-800'}`}>
                        {currentMonth.getFullYear()}å¹´ {currentMonth.getMonth() + 1}æœˆ
                      </h3>
                      <button
                        onClick={() => changeMonth(1)}
                        className={`p-2 rounded-lg transition-colors ${isDarkMode ? 'text-gray-300 hover:bg-gray-700' : 'text-gray-800 hover:bg-gray-100'}`}
                      >
                        æ¬¡æœˆ â†’
                      </button>
                    </div>

                    {/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ */}
                    <div className="mb-4">
                      {/* æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæœˆæ›œå§‹ã¾ã‚Šï¼‰ */}
                      <div className="grid grid-cols-7 gap-1 mb-2">
                        {['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'].map(day => (
                          <div key={day} className={`text-center text-xs font-medium py-2 ${isDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                            {day}
                          </div>
                        ))}
                      </div>

                      {/* æ—¥ä»˜ã‚°ãƒªãƒƒãƒ‰ */}
                      <div className="grid grid-cols-7 gap-1">
                        {generateCalendarDays().map((dayInfo, index) => {
                          // å½“æœˆä»¥å¤–ã¯ç©ºã‚»ãƒ«ã‚’è¡¨ç¤º
                          if (!dayInfo.isCurrentMonth) {
                            return <div key={index} className="aspect-square"></div>;
                          }

                          const dateStr = formatDateToLocal(dayInfo.date);
                          const dayData = dailyData[dateStr];
                          const hasData = dayData && (dayData.hours > 0 || dayData.deliveries > 0 || dayData.earnings > 0 || dayData.quest > 0);
                          const isToday = dateStr === formatDateToLocal(new Date());
                          const isRainy = dayData && dayData.isRainy;
                          const isHoliday = dayData && dayData.isHoliday;

                          // åˆè¨ˆå£²ä¸Šã‚’è¨ˆç®—ï¼ˆåŸºæœ¬å£²ä¸Š + ã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬ï¼‰
                          const totalDailyEarnings = hasData
                            ? (dayData.earnings || 0) + (dayData.quest || 0)
                            : 0;

                          // èƒŒæ™¯è‰²ã¨ãƒ†ã‚­ã‚¹ãƒˆè‰²ã‚’æ±ºå®š
                          let bgClass = isDarkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100';
                          let textClass = isDarkMode ? 'text-purple-400' : 'text-purple-600';
                          if (hasData) {
                            if (isRainy) {
                              bgClass = isDarkMode ? 'bg-blue-900 hover:bg-blue-800' : 'bg-blue-100 hover:bg-blue-200';
                              textClass = isDarkMode ? 'text-blue-300' : 'text-blue-600';
                            } else if (isHoliday) {
                              bgClass = isDarkMode ? 'bg-red-900 hover:bg-red-800' : 'bg-red-100 hover:bg-red-200';
                              textClass = isDarkMode ? 'text-red-300' : 'text-red-600';
                            } else {
                              bgClass = isDarkMode ? 'bg-purple-900 hover:bg-purple-800' : 'bg-purple-100 hover:bg-purple-200';
                              textClass = isDarkMode ? 'text-purple-300' : 'text-purple-600';
                            }
                          }

                          return (
                            <button
                              key={index}
                              onClick={() => handleDateClick(dayInfo.date)}
                              className={`
                                aspect-square p-1 rounded-lg text-sm relative flex flex-col items-center justify-center ${isDarkMode ? 'text-gray-200' : 'text-gray-800'}
                                ${isToday ? 'ring-2 ring-blue-500' : ''}
                                ${bgClass}
                                transition-colors
                              `}
                            >
                              <div className="font-medium flex items-center gap-0.5">
                                {isRainy && <span className="text-[10px]">ğŸŒ§ï¸</span>}
                                {isHoliday && <span className="text-[10px]">ğŸŒ</span>}
                                {dayInfo.date.getDate()}
                              </div>
                              {hasData && (
                                <div className={`text-[9px] font-bold leading-tight ${textClass}`}>
                                  Â¥{Math.floor(totalDailyEarnings).toLocaleString()}
                                </div>
                              )}
                            </button>
                          );
                        })}
                      </div>
                    </div>

                    {/* æœˆé–“é›†è¨ˆ */}
                    {(() => {
                      const monthData = Object.entries(dailyData).filter(([dateStr]) => {
                        const date = new Date(dateStr + 'T00:00:00');
                        return date.getFullYear() === currentMonth.getFullYear() &&
                               date.getMonth() === currentMonth.getMonth();
                      });

                      if (monthData.length === 0) return null;

                      const totalHours = monthData.reduce((sum, [, data]) => sum + (data.hours || 0), 0);
                      const totalDeliveries = monthData.reduce((sum, [dateStr, data]) => {
                        // é…é”ä»¶æ•°ãŒå…¥åŠ›ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ç¨¼åƒæ™‚é–“ã‹ã‚‰è‡ªå‹•è¨ˆç®—
                        const effectiveValues = getEffectiveValues();
                        const date = new Date(dateStr + 'T00:00:00');
                        const dayOfWeek = date.getDay();
                        const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 4;
                        const deliveries = isWeekday ? effectiveValues.weekdayDeliveriesPerHour : effectiveValues.weekendDeliveriesPerHour;
                        return sum + (data.deliveries || (data.hours * deliveries));
                      }, 0);
                      const totalEarnings = monthData.reduce((sum, [dateStr, data]) => {
                        // åŸºæœ¬å£²ä¸ŠãŒå…¥åŠ›ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ç¨¼åƒæ™‚é–“ã‹ã‚‰è‡ªå‹•è¨ˆç®—
                        const effectiveValues = getEffectiveValues();
                        const date = new Date(dateStr + 'T00:00:00');
                        const dayOfWeek = date.getDay();
                        const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 4;
                        const price = isWeekday ? effectiveValues.weekdayAvgPrice : effectiveValues.weekendAvgPrice;
                        const deliveries = isWeekday ? effectiveValues.weekdayDeliveriesPerHour : effectiveValues.weekendDeliveriesPerHour;
                        return sum + (data.earnings || (data.hours * deliveries * price));
                      }, 0);
                      const totalQuest = monthData.reduce((sum, [, data]) => sum + (data.quest || 0), 0);

                      // å¹³å‡å€¤ã®è¨ˆç®—
                      const avgPricePerDelivery = totalDeliveries > 0 ? totalEarnings / totalDeliveries : 0;
                      const avgDeliveriesPerHour = totalHours > 0 ? totalDeliveries / totalHours : 0;

                      return (
                        <div className="bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl p-4 border border-purple-200">
                          <h4 className="font-bold text-gray-800 mb-3">æœˆé–“é›†è¨ˆ</h4>
                          <div className="grid grid-cols-2 gap-3 text-sm">
                            <div className="bg-white/60 rounded-lg p-2">
                              <div className="text-gray-600 text-xs">ç¨¼åƒæ™‚é–“</div>
                              <div className="font-bold">{totalHours.toFixed(1)}æ™‚é–“</div>
                            </div>
                            <div className="bg-white/60 rounded-lg p-2">
                              <div className="text-gray-600 text-xs">é…é”ä»¶æ•°</div>
                              <div className="font-bold">{Math.floor(totalDeliveries)}ä»¶</div>
                            </div>
                            <div className="bg-white/60 rounded-lg p-2">
                              <div className="text-gray-600 text-xs">åŸºæœ¬å£²ä¸Š</div>
                              <div className="font-bold">Â¥{Math.floor(totalEarnings).toLocaleString()}</div>
                            </div>
                            <div className="bg-white/60 rounded-lg p-2">
                              <div className="text-gray-600 text-xs">ã‚¯ã‚¨ã‚¹ãƒˆ</div>
                              <div className="font-bold">Â¥{Math.floor(totalQuest).toLocaleString()}</div>
                            </div>
                            <div className="bg-white/60 rounded-lg p-2">
                              <div className="text-gray-600 text-xs">å¹³å‡å˜ä¾¡</div>
                              <div className="font-bold">Â¥{Math.floor(avgPricePerDelivery)}</div>
                            </div>
                            <div className="bg-white/60 rounded-lg p-2">
                              <div className="text-gray-600 text-xs">å¹³å‡ä»¶æ•°/æ™‚é–“</div>
                              <div className="font-bold">{avgDeliveriesPerHour.toFixed(1)}ä»¶</div>
                            </div>
                          </div>
                          <div className="mt-3 bg-white/80 rounded-lg p-3 border border-purple-300">
                            <div className="text-gray-600 text-sm">åˆè¨ˆå£²ä¸Š</div>
                            <div className="text-2xl font-bold text-purple-600">
                              Â¥{Math.floor(totalEarnings + totalQuest).toLocaleString()}
                            </div>
                          </div>
                        </div>
                      );
                    })()}
                  </div>
                </div>

                <div
                  className={`p-4 border-t ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}
                  style={{flexShrink: 0, touchAction: 'none'}}
                >
                  <button
                    onClick={() => setShowCalendar(false)}
                    className="w-full bg-gray-500 text-white py-3 rounded-xl font-medium hover:bg-gray-600 transition-colors"
                    style={{touchAction: 'auto'}}
                  >
                    é–‰ã˜ã‚‹
                  </button>
                </div>
              </div>
            )}

            {/* ã‚¯ã‚¨ã‚¹ãƒˆè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */}
            {showQuestSettings && (
              <div
                className={`fixed inset-0 z-50 ${isDarkMode ? 'bg-gray-900' : 'bg-white'}`}
                style={{
                  display: 'flex',
                  flexDirection: 'column',
                  overflow: 'hidden'
                }}
              >
                <div
                  className={`border-b p-4 flex items-center justify-between ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}
                  style={{flexShrink: 0, touchAction: 'none'}}
                >
                  <h2 className={`text-xl font-bold flex items-center gap-2 ${isDarkMode ? 'text-white' : 'text-gray-800'}`}>
                    <span className="text-2xl">ğŸ†</span>
                    ã‚¯ã‚¨ã‚¹ãƒˆ
                  </h2>
                  <button
                    onClick={() => setShowQuestSettings(false)}
                    className={`text-2xl ${isDarkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}`}
                    style={{touchAction: 'auto'}}
                  >
                    Ã—
                  </button>
                </div>

                <div
                  ref={questModalContentRef}
                  style={{
                    flex: 1,
                    overflowY: 'auto',
                    WebkitOverflowScrolling: 'touch',
                    minHeight: 0
                  }}
                >
                  <div className="p-6 space-y-6">
                    {/* æœˆï½æœ¨ã®ã‚¯ã‚¨ã‚¹ãƒˆ */}
                    <div>
                      <h3 className={`font-bold mb-1 ${isDarkMode ? 'text-white' : 'text-gray-800'}`}>æœˆï½æœ¨ã‚¯ã‚¨ã‚¹ãƒˆ</h3>
                      <p className={`text-xs mb-3 ${isDarkMode ? 'text-gray-400' : 'text-gray-500'}`}>â€»å„ã‚¯ã‚¨ã‚¹ãƒˆã¯é †ç•ªã«é”æˆã•ã‚Œã¾ã™</p>
                      <div className="space-y-2">
                        {weekdayQuests.map((quest, index) => (
                          <div key={index} className={`flex items-center gap-1.5 p-2 rounded-lg ${isDarkMode ? 'bg-gray-700' : 'bg-blue-50'}`}>
                            <div className="w-7 h-7 min-w-7 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold text-xs flex-shrink-0">
                              {index + 1}
                            </div>
                            <input
                              type="number"
                              value={quest.count || ''}
                              onChange={(e) => updateWeekdayQuest(index, 'count', e.target.value)}
                              onKeyDown={handleKeyDown}
                              className={`w-14 px-2 py-1.5 border-2 rounded-lg focus:outline-none text-sm text-center flex-shrink-0 ${isDarkMode ? 'bg-gray-800 border-gray-600 text-white focus:border-blue-400' : 'border-gray-200 focus:border-blue-500'}`}
                            />
                            <span className={`text-xs flex-shrink-0 ${isDarkMode ? 'text-gray-300' : 'text-gray-600'}`}>å›</span>
                            <input
                              type="number"
                              step="50"
                              value={quest.reward || ''}
                              onChange={(e) => updateWeekdayQuest(index, 'reward', e.target.value)}
                              onKeyDown={handleKeyDown}
                              className={`flex-1 min-w-0 px-2 py-1.5 border-2 rounded-lg focus:outline-none text-sm text-center ${isDarkMode ? 'bg-gray-800 border-gray-600 text-white focus:border-blue-400' : 'border-gray-200 focus:border-blue-500'}`}
                            />
                            <span className={`text-xs flex-shrink-0 ${isDarkMode ? 'text-gray-300' : 'text-gray-600'}`}>å††</span>
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* é‡‘ï½æ—¥ã®ã‚¯ã‚¨ã‚¹ãƒˆ */}
                    <div>
                      <h3 className={`font-bold mb-1 ${isDarkMode ? 'text-white' : 'text-gray-800'}`}>é‡‘ï½æ—¥ã‚¯ã‚¨ã‚¹ãƒˆ</h3>
                      <p className={`text-xs mb-3 ${isDarkMode ? 'text-gray-400' : 'text-gray-500'}`}>â€»å„ã‚¯ã‚¨ã‚¹ãƒˆã¯é †ç•ªã«é”æˆã•ã‚Œã¾ã™</p>
                      <div className="space-y-2">
                        {weekendQuests.map((quest, index) => (
                          <div key={index} className={`flex items-center gap-1.5 p-2 rounded-lg ${isDarkMode ? 'bg-gray-700' : 'bg-yellow-50'}`}>
                            <div className="w-7 h-7 min-w-7 bg-yellow-500 text-white rounded-full flex items-center justify-center font-bold text-xs flex-shrink-0">
                              {index + 1}
                            </div>
                            <input
                              type="number"
                              value={quest.count || ''}
                              onChange={(e) => updateWeekendQuest(index, 'count', e.target.value)}
                              onKeyDown={handleKeyDown}
                              className={`w-14 px-2 py-1.5 border-2 rounded-lg focus:outline-none text-sm text-center flex-shrink-0 ${isDarkMode ? 'bg-gray-800 border-gray-600 text-white focus:border-yellow-400' : 'border-gray-200 focus:border-yellow-500'}`}
                            />
                            <span className={`text-xs flex-shrink-0 ${isDarkMode ? 'text-gray-300' : 'text-gray-600'}`}>å›</span>
                            <input
                              type="number"
                              step="50"
                              value={quest.reward || ''}
                              onChange={(e) => updateWeekendQuest(index, 'reward', e.target.value)}
                              onKeyDown={handleKeyDown}
                              className={`flex-1 min-w-0 px-2 py-1.5 border-2 rounded-lg focus:outline-none text-sm text-center ${isDarkMode ? 'bg-gray-800 border-gray-600 text-white focus:border-yellow-400' : 'border-gray-200 focus:border-yellow-500'}`}
                            />
                            <span className={`text-xs flex-shrink-0 ${isDarkMode ? 'text-gray-300' : 'text-gray-600'}`}>å††</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                </div>

                <div
                  className={`p-4 border-t ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}
                  style={{flexShrink: 0, touchAction: 'none'}}
                >
                  <button
                    onClick={() => setShowQuestSettings(false)}
                    className="w-full bg-gray-500 text-white py-3 rounded-xl font-medium hover:bg-gray-600 transition-colors"
                    style={{touchAction: 'auto'}}
                  >
                    é–‰ã˜ã‚‹
                  </button>
                </div>
              </div>
            )}

            {/* æ—¥ä»˜ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« */}
            {showDayEdit && selectedDate && (
              <div
                className={`fixed inset-0 z-[60] ${isDarkMode ? 'bg-gray-900' : 'bg-white'}`}
                style={{
                  display: 'flex',
                  flexDirection: 'column',
                  overflow: 'hidden'
                }}
              >
                <div
                  className={`border-b p-4 flex items-center justify-between ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}
                  style={{flexShrink: 0, touchAction: 'none'}}
                >
                  <button
                    onClick={() => setIsChangingDate(true)}
                    className={`text-xl font-bold hover:opacity-80 transition-opacity text-left flex items-center gap-2 ${isDarkMode ? 'text-white' : 'text-gray-800'}`}
                    style={{touchAction: 'auto'}}
                  >
                    <span className="text-2xl">ğŸ“…</span>
                    {new Date(selectedDate + 'T00:00:00').toLocaleDateString('ja-JP', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric',
                      weekday: 'short'
                    })}
                  </button>
                  <button
                    onClick={() => setShowDayEdit(false)}
                    className={`text-2xl ${isDarkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}`}
                    style={{touchAction: 'auto'}}
                  >
                    Ã—
                  </button>
                </div>

                <div
                  style={{
                    flex: 1,
                    overflowY: 'auto',
                    WebkitOverflowScrolling: 'touch',
                    minHeight: 0
                  }}
                >
                  <div className="p-6 space-y-4">

                    <div>
                      <label className={`block text-sm font-medium mb-2 ${isDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        ç¨¼åƒæ™‚é–“
                      </label>
                      <div className="flex items-center gap-2">
                        <input
                          type="number"
                          step="0.5"
                          value={editingDayData.hours || ''}
                          onChange={(e) => setEditingDayData({...editingDayData, hours: parseFloat(e.target.value) || 0})}
                          onKeyDown={handleKeyDown}
                          className={`flex-1 px-4 py-3 border-2 rounded-xl focus:outline-none text-lg ${isDarkMode ? 'bg-gray-700 border-gray-600 text-white focus:border-purple-400' : 'border-gray-200 focus:border-purple-500'}`}
                          placeholder="0"
                        />
                        <span className={`font-medium ${isDarkMode ? 'text-gray-300' : 'text-gray-600'}`}>æ™‚é–“</span>
                      </div>
                    </div>

                    <div>
                      <label className={`block text-sm font-medium mb-2 ${isDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        é…é”ä»¶æ•°
                      </label>
                      <div className="flex items-center gap-2">
                        <input
                          type="number"
                          value={editingDayData.deliveries || ''}
                          onChange={(e) => setEditingDayData({...editingDayData, deliveries: parseInt(e.target.value) || 0})}
                          onKeyDown={handleKeyDown}
                          className={`flex-1 px-4 py-3 border-2 rounded-xl focus:outline-none text-lg ${isDarkMode ? 'bg-gray-700 border-gray-600 text-white focus:border-purple-400' : 'border-gray-200 focus:border-purple-500'}`}
                          placeholder={editingDayData.hours > 0 ? (() => {
                            const effectiveValues = getEffectiveValues();
                            const date = new Date(selectedDate + 'T00:00:00');
                            const dayOfWeek = date.getDay();
                            const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 4;
                            const deliveries = isWeekday ? effectiveValues.weekdayDeliveriesPerHour : effectiveValues.weekendDeliveriesPerHour;
                            return Math.floor(editingDayData.hours * deliveries).toString();
                          })() : "0"}
                        />
                        <span className={`font-medium ${isDarkMode ? 'text-gray-300' : 'text-gray-600'}`}>ä»¶</span>
                      </div>
                    </div>

                    <div>
                      <label className={`block text-sm font-medium mb-2 ${isDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        åŸºæœ¬å£²ä¸Š
                      </label>
                      <div className="flex items-center gap-2">
                        <input
                          type="number"
                          step="100"
                          value={editingDayData.earnings || ''}
                          onChange={(e) => setEditingDayData({...editingDayData, earnings: parseInt(e.target.value) || 0})}
                          onKeyDown={handleKeyDown}
                          className={`flex-1 px-4 py-3 border-2 rounded-xl focus:outline-none text-lg ${isDarkMode ? 'bg-gray-700 border-gray-600 text-white focus:border-purple-400' : 'border-gray-200 focus:border-purple-500'}`}
                          placeholder={editingDayData.hours > 0 ? (() => {
                            const effectiveValues = getEffectiveValues();
                            const date = new Date(selectedDate + 'T00:00:00');
                            const dayOfWeek = date.getDay();
                            const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 4;
                            const price = isWeekday ? effectiveValues.weekdayAvgPrice : effectiveValues.weekendAvgPrice;
                            const deliveries = isWeekday ? effectiveValues.weekdayDeliveriesPerHour : effectiveValues.weekendDeliveriesPerHour;
                            return Math.floor(editingDayData.hours * deliveries * price).toString();
                          })() : "0"}
                        />
                        <span className={`font-medium ${isDarkMode ? 'text-gray-300' : 'text-gray-600'}`}>å††</span>
                      </div>
                    </div>

                    <div>
                      <label className={`block text-sm font-medium mb-2 ${isDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        ã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬
                      </label>
                      <div className="flex items-center gap-2">
                        <input
                          type="number"
                          step="100"
                          value={editingDayData.quest || ''}
                          onChange={(e) => setEditingDayData({...editingDayData, quest: parseInt(e.target.value) || 0})}
                          onKeyDown={handleKeyDown}
                          className={`flex-1 px-4 py-3 border-2 rounded-xl focus:outline-none text-lg ${isDarkMode ? 'bg-gray-700 border-gray-600 text-white focus:border-purple-400' : 'border-gray-200 focus:border-purple-500'}`}
                          placeholder="0"
                        />
                        <span className={`font-medium ${isDarkMode ? 'text-gray-300' : 'text-gray-600'}`}>å††</span>
                      </div>
                    </div>

                    {/* é›¨ã®æ—¥ãƒ»ç¥æ—¥ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */}
                    <div className="grid grid-cols-2 gap-2">
                      <div className={`rounded-xl p-3 border-2 ${isDarkMode ? 'bg-blue-900 border-blue-700' : 'bg-blue-50 border-blue-200'}`}>
                        <label className="flex items-center gap-2 cursor-pointer">
                          <input
                            type="checkbox"
                            checked={editingDayData.isRainy || false}
                            onChange={(e) => setEditingDayData({...editingDayData, isRainy: e.target.checked})}
                            className="w-5 h-5 text-blue-500 rounded focus:ring-2 focus:ring-blue-500"
                          />
                          <div>
                            <div className={`text-sm font-medium ${isDarkMode ? 'text-blue-300' : 'text-gray-800'}`}>ğŸŒ§ï¸ é›¨ã®æ—¥</div>
                            <div className={`text-xs mt-0.5 ${isDarkMode ? 'text-blue-400' : 'text-gray-600'}`}>å¹³å‡è¨ˆç®—ã‹ã‚‰é™¤å¤–</div>
                          </div>
                        </label>
                      </div>
                      <div className={`rounded-xl p-3 border-2 ${isDarkMode ? 'bg-red-900 border-red-700' : 'bg-red-50 border-red-200'}`}>
                        <label className="flex items-center gap-2 cursor-pointer">
                          <input
                            type="checkbox"
                            checked={editingDayData.isHoliday || false}
                            onChange={(e) => setEditingDayData({...editingDayData, isHoliday: e.target.checked})}
                            className="w-5 h-5 text-red-500 rounded focus:ring-2 focus:ring-red-500"
                          />
                          <div>
                            <div className={`text-sm font-medium ${isDarkMode ? 'text-red-300' : 'text-gray-800'}`}>ğŸŒ ç¥æ—¥</div>
                            <div className={`text-xs mt-0.5 ${isDarkMode ? 'text-red-400' : 'text-gray-600'}`}>å¹³å‡è¨ˆç®—ã‹ã‚‰é™¤å¤–</div>
                          </div>
                        </label>
                      </div>
                    </div>

                    {/* åˆè¨ˆè¡¨ç¤º */}
                    <div className="bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl p-4 border border-purple-200">
                      <div className="text-sm text-gray-600 mb-1">ã“ã®æ—¥ã®åˆè¨ˆ</div>
                      <div className="text-2xl font-bold text-purple-600">
                        Â¥{(() => {
                          const effectiveValues = getEffectiveValues();
                          const date = new Date(selectedDate + 'T00:00:00');
                          const dayOfWeek = date.getDay();
                          const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 4;
                          const price = isWeekday ? effectiveValues.weekdayAvgPrice : effectiveValues.weekendAvgPrice;
                          const deliveries = isWeekday ? effectiveValues.weekdayDeliveriesPerHour : effectiveValues.weekendDeliveriesPerHour;
                          return (
                            (editingDayData.earnings || (editingDayData.hours * deliveries * price)) +
                            (editingDayData.quest || 0)
                          ).toLocaleString();
                        })()}
                      </div>
                    </div>
                  </div>
                </div>

                <div
                  className={`p-4 border-t ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}
                  style={{flexShrink: 0, touchAction: 'none'}}
                >
                  <div className="flex gap-2">
                    <button
                      onClick={saveDayData}
                      className="flex-1 bg-purple-500 text-white py-3 rounded-xl font-medium hover:bg-purple-600 transition-colors"
                      style={{touchAction: 'auto'}}
                    >
                      ä¿å­˜
                    </button>
                    {dailyData[selectedDate] && (
                      <button
                        onClick={deleteDayData}
                        className="px-6 bg-red-500 text-white py-3 rounded-xl font-medium hover:bg-red-600 transition-colors"
                        style={{touchAction: 'auto'}}
                      >
                        å‰Šé™¤
                      </button>
                    )}
                  </div>
                </div>

                {/* æ—¥ä»˜å¤‰æ›´ç”¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */}
                {isChangingDate && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-[70]">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[80vh] flex flex-col">
                      <div
                        className="bg-white border-b border-gray-200 p-4 flex items-center justify-between flex-shrink-0 rounded-t-2xl"
                        onTouchMove={(e) => e.stopPropagation()}
                      >
                        <h3 className="text-lg font-bold text-gray-800">æ—¥ä»˜ã‚’é¸æŠ</h3>
                        <button
                          onClick={() => setIsChangingDate(false)}
                          className="text-gray-500 hover:text-gray-700 text-2xl"
                        >
                          Ã—
                        </button>
                      </div>

                      <div className="p-4 overflow-y-auto flex-1">
                        {/* æœˆåˆ‡ã‚Šæ›¿ãˆ */}
                        <div className="flex items-center justify-between mb-4">
                          <button
                            onClick={() => changeMonth(-1)}
                            className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
                          >
                            â† å‰æœˆ
                          </button>
                          <h4 className="text-base font-bold">
                            {currentMonth.getFullYear()}å¹´ {currentMonth.getMonth() + 1}æœˆ
                          </h4>
                          <button
                            onClick={() => changeMonth(1)}
                            className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
                          >
                            æ¬¡æœˆ â†’
                          </button>
                        </div>

                        {/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ */}
                        <div>
                          {/* æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæœˆæ›œå§‹ã¾ã‚Šï¼‰ */}
                          <div className="grid grid-cols-7 gap-1 mb-2">
                            {['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'].map(day => (
                              <div key={day} className={`text-center text-xs font-medium py-2 ${isDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                {day}
                              </div>
                            ))}
                          </div>

                          {/* æ—¥ä»˜ã‚°ãƒªãƒƒãƒ‰ */}
                          <div className="grid grid-cols-7 gap-1">
                            {(() => {
                              const year = currentMonth.getFullYear();
                              const month = currentMonth.getMonth();
                              const firstDay = new Date(year, month, 1);
                              const lastDay = new Date(year, month + 1, 0);
                              const daysInMonth = lastDay.getDate();

                              let firstDayOfWeek = firstDay.getDay();
                              firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;

                              const calendarDays = [];

                              for (let i = 0; i < firstDayOfWeek; i++) {
                                calendarDays.push({ date: null, isCurrentMonth: false });
                              }

                              for (let day = 1; day <= daysInMonth; day++) {
                                const date = new Date(year, month, day);
                                calendarDays.push({ date, isCurrentMonth: true });
                              }

                              return calendarDays.map((dayInfo, index) => {
                                if (!dayInfo.isCurrentMonth) {
                                  return <div key={`empty-${index}`} className="aspect-square"></div>;
                                }

                                const dateStr = formatDateToLocal(dayInfo.date);
                                const dayData = dailyData[dateStr];
                                const hasData = dayData && (dayData.hours > 0 || dayData.deliveries > 0 || dayData.earnings > 0 || dayData.quest > 0);
                                const isToday = dateStr === formatDateToLocal(new Date());

                                return (
                                  <button
                                    key={index}
                                    onClick={() => handleDateClick(dayInfo.date)}
                                    className={`
                                      aspect-square p-1 rounded-lg text-sm relative flex flex-col items-center justify-center text-gray-800
                                      ${isToday ? 'ring-2 ring-blue-500' : ''}
                                      ${hasData ? 'bg-purple-100 hover:bg-purple-200' : 'hover:bg-gray-100'}
                                      transition-colors
                                    `}
                                  >
                                    <div className="font-medium">{dayInfo.date.getDate()}</div>
                                  </button>
                                );
                              });
                            })()}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* çµŒè²»ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« */}
            {showExpenses && (
              <div
                className={`fixed inset-0 z-50 ${isDarkMode ? 'bg-gray-900' : 'bg-white'}`}
                style={{
                  display: 'flex',
                  flexDirection: 'column',
                  overflow: 'hidden'
                }}
              >
                <div
                  className={`border-b p-4 flex items-center justify-between ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}
                  style={{flexShrink: 0, touchAction: 'none'}}
                >
                  <div className="flex items-center gap-3">
                    <h2 className={`text-xl font-bold flex items-center gap-2 ${isDarkMode ? 'text-white' : 'text-gray-800'}`}>
                      <span className="text-2xl">ğŸ’¸</span>
                      çµŒè²»ç®¡ç†
                      <button
                        onClick={() => setShowExpenseGuide(true)}
                        className="text-blue-500 hover:text-blue-700 text-lg"
                        style={{touchAction: 'auto'}}
                        title="ç§‘ç›®ã®èª¬æ˜ã‚’è¡¨ç¤º"
                      >
                        â„¹ï¸
                      </button>
                    </h2>
                    <button
                      onClick={() => setShowExpenseFilter(true)}
                      className="bg-blue-500 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-blue-600 transition-colors"
                      style={{touchAction: 'auto'}}
                    >
                      ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                    </button>
                  </div>
                  <button
                    onClick={() => setShowExpenses(false)}
                    className={`text-2xl ${isDarkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}`}
                    style={{touchAction: 'auto'}}
                  >
                    âœ•
                  </button>
                </div>

                <div
                  style={{
                    flex: 1,
                    overflowY: 'auto',
                    WebkitOverflowScrolling: 'touch',
                    minHeight: 0
                  }}
                >
                  <div className="p-4">
                    {/* å¹´é–“é›†è¨ˆ */}
                    {(() => {
                      const currentYear = new Date().getFullYear();

                      const yearlyExpenses = Object.entries(expenses)
                        .filter(([id, expense]) => {
                          const [year] = expense.date.split('-');
                          return parseInt(year) === currentYear;
                        })
                        .reduce((sum, [id, expense]) => {
                          const percentage = expense.businessPercentage ?? 100;
                          return sum + Math.floor(expense.amount * percentage / 100);
                        }, 0);

                      return (
                        <div className="bg-orange-50 rounded-xl p-4 border-2 border-orange-200 mb-4">
                          <div className="text-sm text-gray-600 mb-1">
                            {currentYear}å¹´ã®çµŒè²»
                          </div>
                          <div className="text-2xl font-bold text-orange-600">
                            Â¥{yearlyExpenses.toLocaleString()}
                          </div>
                        </div>
                      );
                    })()}

                    {/* æ–°è¦è¿½åŠ ãƒœã‚¿ãƒ³ */}
                    <button
                      onClick={() => {
                        setEditingExpense({
                          date: formatDateToLocal(new Date()),
                          amount: 0,
                          photo: null,
                          accountingSubject: 'travel',
                          creditAccount: '',
                          businessPercentage: 100,
                          memo: ''
                        });
                        setEditingExpenseId(null);
                        setShowExpenseInput(true);
                      }}
                      className="w-full bg-red-500 text-white py-3 rounded-xl font-medium hover:bg-red-600 transition-colors mb-4"
                    >
                      â• æ–°è¦çµŒè²»ã‚’è¿½åŠ 
                    </button>

                    {/* çµŒè²»ãƒªã‚¹ãƒˆ */}
                    <div className="space-y-2">
                      {Object.entries(expenses)
                        .filter(([id, expense]) => {
                          // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
                          if (expenseFilter.startDate && expense.date < expenseFilter.startDate) return false;
                          if (expenseFilter.endDate && expense.date > expenseFilter.endDate) return false;
                          if (expenseFilter.accountingSubject && expense.accountingSubject !== expenseFilter.accountingSubject) return false;
                          if (expenseFilter.vendor && !expense.vendor?.toLowerCase().includes(expenseFilter.vendor.toLowerCase())) return false;
                          return true;
                        })
                        .sort(([, a], [, b]) => new Date(b.date) - new Date(a.date))
                        .map(([id, expense]) => (
                          <div
                            key={id}
                            className="relative overflow-hidden"
                            onTouchStart={(e) => {
                              const touch = e.touches[0];
                              e.currentTarget.dataset.startX = touch.clientX;
                              e.currentTarget.dataset.startY = touch.clientY;
                            }}
                            onTouchMove={(e) => {
                              const touch = e.touches[0];
                              const startX = parseFloat(e.currentTarget.dataset.startX);
                              const startY = parseFloat(e.currentTarget.dataset.startY);
                              const deltaX = touch.clientX - startX;
                              const deltaY = touch.clientY - startY;

                              // æ¨ªæ–¹å‘ã®ã‚¹ãƒ¯ã‚¤ãƒ—ã®æ–¹ãŒå¤§ãã„å ´åˆã®ã¿å‡¦ç†
                              if (Math.abs(deltaX) > Math.abs(deltaY) && deltaX < -30) {
                                setSwipedExpenseId(id);
                              } else if (deltaX > 10) {
                                setSwipedExpenseId(null);
                              }
                            }}
                            onTouchEnd={() => {
                              // ã‚¿ãƒƒãƒçµ‚äº†æ™‚ã®å‡¦ç†
                            }}
                          >
                            <div className="flex items-center">
                              <button
                                onClick={() => {
                                  if (swipedExpenseId === id) {
                                    setSwipedExpenseId(null);
                                  } else {
                                    setEditingExpense({
                                      ...expense,
                                      accountingSubject: expense.accountingSubject || 'travel',
                                      creditAccount: expense.creditAccount || '',
                                      businessPercentage: expense.businessPercentage ?? 100,
                                      memo: expense.memo || ''
                                    });
                                    setEditingExpenseId(id);
                                    setShowExpenseInput(true);
                                  }
                                }}
                                className={`w-full bg-white rounded-lg p-3 border-2 border-gray-200 hover:border-red-300 transition-all text-left ${
                                  swipedExpenseId === id ? '-translate-x-20' : ''
                                }`}
                                style={{ transition: 'transform 0.3s ease' }}
                              >
                                <div>
                                  <div style={{ display: 'grid', gridTemplateColumns: '50px 1fr 30px 100px', gap: '8px', alignItems: 'center' }}>
                                    <div className="text-sm text-gray-500 whitespace-nowrap">
                                      {new Date(expense.date + 'T00:00:00').toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric' })}
                                    </div>
                                    <div className="font-medium text-gray-800 truncate">
                                      {accountingSubjects[expense.accountingSubject] || 'æ—…è²»äº¤é€šè²»'}
                                      {expense.isLocked && (
                                        <span className="ml-1 text-xs bg-green-100 text-green-800 px-1 py-0.5 rounded">ç¢ºå®š</span>
                                      )}
                                    </div>
                                    <div className="text-center">
                                      {expense.photo && (
                                        <span className="text-gray-400 text-lg">ğŸ“·</span>
                                      )}
                                    </div>
                                    <div className="text-right">
                                      <div className="text-lg font-bold text-gray-800 whitespace-nowrap">
                                        Â¥{Math.floor(expense.amount * (expense.businessPercentage ?? 100) / 100).toLocaleString()}
                                      </div>
                                      {(expense.businessPercentage ?? 100) < 100 && (
                                        <div className="text-xs text-gray-500">
                                          (Â¥{expense.amount.toLocaleString()} Ã— {expense.businessPercentage}%)
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                  <div className="mt-1 text-sm text-gray-500 flex items-start gap-2" style={{ paddingLeft: '58px' }}>
                                    <div className="flex-shrink-0" style={{ minWidth: '120px' }}>
                                      {expense.vendor ? `ğŸ“${expense.vendor}` : ''}
                                    </div>
                                    {expense.memo && (
                                      <div className="flex-1 truncate">{expense.memo}</div>
                                    )}
                                  </div>
                                </div>
                              </button>
                              {swipedExpenseId === id && (
                                <button
                                  onClick={async () => {
                                    if (confirm('ã“ã®çµŒè²»ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                                      try {
                                        // Delete from Supabase
                                        const { error } = await supabaseClient
                                          .from('expenses')
                                          .delete()
                                          .eq('id', id)
                                          .eq('user_id', session.user.id);

                                        if (error) throw error;

                                        // Delete photo from storage if exists
                                        const expense = expenses[id];
                                        if (expense.photo && !expense.photo.startsWith('data:image/')) {
                                          const fileName = expense.photo.split('/').pop();
                                          await supabaseClient.storage
                                            .from('expense-photos')
                                            .remove([`${session.user.id}/${fileName}`]);
                                        }

                                        setExpenses(prev => {
                                          const newExpenses = { ...prev };
                                          delete newExpenses[id];
                                          return newExpenses;
                                        });
                                        setSwipedExpenseId(null);
                                      } catch (error) {
                                        console.error('Delete error:', error);
                                        alert('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                                      }
                                    }
                                  }}
                                  className="absolute right-0 top-0 bottom-0 w-20 bg-red-500 text-white font-medium flex items-center justify-center rounded-r-lg"
                                >
                                  å‰Šé™¤
                                </button>
                              )}
                            </div>
                          </div>
                        ))}
                    </div>

                    {Object.keys(expenses).length === 0 && (
                      <div className="text-center text-gray-500 py-8">
                        çµŒè²»ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
                      </div>
                    )}
                  </div>
                </div>

                <div
                  className={`p-4 border-t ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}
                  style={{flexShrink: 0, touchAction: 'none'}}
                >
                  <button
                    onClick={() => setShowExpenses(false)}
                    className="w-full bg-gray-500 text-white py-3 rounded-xl font-medium hover:bg-gray-600 transition-colors"
                    style={{touchAction: 'auto'}}
                  >
                    é–‰ã˜ã‚‹
                  </button>
                </div>
              </div>
            )}

            {/* çµŒè²»å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« */}
            {showExpenseInput && editingExpense && (
              <div
                className={`fixed inset-0 z-[60] ${isDarkMode ? 'bg-gray-900' : 'bg-white'}`}
                style={{
                  display: 'flex',
                  flexDirection: 'column',
                  overflow: 'hidden'
                }}
              >
                <div
                  className={`border-b p-4 flex items-center justify-between ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}
                  style={{flexShrink: 0, touchAction: 'none'}}
                >
                  <h2 className={`text-xl font-bold flex items-center gap-2 ${isDarkMode ? 'text-white' : 'text-gray-800'}`}>
                    <span className="text-2xl">ğŸ’¸</span>
                    {editingExpenseId ? 'çµŒè²»ã‚’ç·¨é›†' : 'æ–°è¦çµŒè²»'}
                  </h2>
                  <button
                    onClick={() => setShowExpenseInput(false)}
                    className={`text-2xl ${isDarkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}`}
                    style={{touchAction: 'auto'}}
                  >
                    Ã—
                  </button>
                </div>

                <div
                  style={{
                    flex: 1,
                    overflowY: 'auto',
                    WebkitOverflowScrolling: 'touch',
                    minHeight: 0
                  }}
                >
                  <div className="p-6 space-y-4">
                    {/* æ—¥ä»˜ */}
                    <div>
                      <label className={`block text-sm font-medium mb-2 ${isDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        æ—¥ä»˜
                      </label>
                      <input
                        type="date"
                        value={editingExpense.date}
                        onChange={(e) => setEditingExpense({...editingExpense, date: e.target.value})}
                        className={`w-full px-4 py-3 border-2 rounded-xl focus:outline-none ${isDarkMode ? 'bg-gray-700 border-gray-600 text-white focus:border-red-400' : 'border-gray-200 focus:border-red-500'}`}
                        style={{
                          WebkitAppearance: 'none',
                          MozAppearance: 'none',
                          appearance: 'none',
                          minHeight: '3rem',
                          lineHeight: '1.5',
                          fontSize: '16px'
                        }}
                      />
                    </div>

                    {/* å–å¼•å…ˆ */}
                    <div className="relative">
                      <label className={`block text-sm font-medium mb-2 ${isDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        å–å¼•å…ˆï¼ˆåº—èˆ—åç­‰ï¼‰
                      </label>
                      <input
                        type="text"
                        value={editingExpense?.vendor || ''}
                        onChange={(e) => {
                          setEditingExpense({...editingExpense, vendor: e.target.value});
                          try {
                            const suggestions = getVendorSuggestions(e.target.value);
                            setVendorSuggestions(suggestions);
                            setShowVendorSuggestions(suggestions.length > 0);
                          } catch (error) {
                            console.error('Error getting vendor suggestions:', error);
                            setVendorSuggestions([]);
                            setShowVendorSuggestions(false);
                          }
                        }}
                        onFocus={(e) => {
                          try {
                            const suggestions = getVendorSuggestions(e.target.value);
                            setVendorSuggestions(suggestions);
                            setShowVendorSuggestions(suggestions.length > 0);
                          } catch (error) {
                            console.error('Error getting vendor suggestions:', error);
                            setVendorSuggestions([]);
                            setShowVendorSuggestions(false);
                          }
                        }}
                        onBlur={() => {
                          // å€™è£œé¸æŠã®ãŸã‚ã«å°‘ã—é…å»¶
                          setTimeout(() => setShowVendorSuggestions(false), 200);
                        }}
                        className={`w-full px-4 py-3 border-2 rounded-xl focus:outline-none ${isDarkMode ? 'bg-gray-700 border-gray-600 text-white focus:border-red-400' : 'border-gray-200 focus:border-red-500'}`}
                        placeholder="ä¾‹ï¼šã‚¨ãƒã‚ªã‚¹ã€‡ã€‡åº—ã€Amazonã€ã€‡ã€‡ãƒ¢ãƒ¼ã‚¿ãƒ¼ã‚¹"
                      />

                      {/* åº—èˆ—åå€™è£œãƒªã‚¹ãƒˆ */}
                      {showVendorSuggestions && vendorSuggestions.length > 0 && (
                        <div className={`absolute z-10 w-full mt-1 border-2 rounded-xl shadow-lg max-h-60 overflow-y-auto ${isDarkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-200'}`}>
                          {vendorSuggestions.map((suggestion, index) => (
                            <div
                              key={index}
                              className={`px-4 py-3 cursor-pointer ${isDarkMode ? 'hover:bg-gray-600' : 'hover:bg-red-50'}`}
                              onClick={() => {
                                setEditingExpense({...editingExpense, vendor: suggestion.vendor});
                                setShowVendorSuggestions(false);
                              }}
                            >
                              <span className={isDarkMode ? 'text-white' : 'text-gray-800'}>{suggestion.vendor}</span>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>

                    {/* ãƒ¡ãƒ¢æ¬„ */}
                    <div>
                      <label className={`block text-sm font-medium mb-2 ${isDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        ãƒ¡ãƒ¢ãƒ»å‚™è€ƒ
                      </label>
                      <textarea
                        value={editingExpense?.memo || ''}
                        onChange={(e) => setEditingExpense({...editingExpense, memo: e.target.value})}
                        className={`w-full px-4 py-3 border-2 rounded-xl focus:outline-none resize-none ${isDarkMode ? 'bg-gray-700 border-gray-600 text-white focus:border-red-400' : 'border-gray-200 focus:border-red-500'}`}
                        placeholder="ä¾‹ï¼šæ‰“ã¡åˆã‚ã›ç”¨ã€ã€‡ã€‡æ¡ˆä»¶ã®ç§»å‹•è²»ãªã©"
                        rows="2"
                      />
                    </div>

                    {/* é‡‘é¡ã¨äº‹æ¥­ä½¿ç”¨å‰²åˆ */}
                    <div className="grid grid-cols-2 gap-3">
                      <div>
                        <label className={`block text-sm font-medium mb-2 ${isDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                          é‡‘é¡
                        </label>
                        <div className="flex items-center gap-1">
                          <input
                            type="number"
                            value={editingExpense.amount || ''}
                            onChange={(e) => setEditingExpense({...editingExpense, amount: parseInt(e.target.value) || 0})}
                            className={`w-full px-3 py-3 border-2 rounded-xl focus:outline-none ${isDarkMode ? 'bg-gray-700 border-gray-600 text-white focus:border-red-400' : 'border-gray-200 focus:border-red-500'}`}
                            placeholder="0"
                          />
                          <span className={`font-medium text-sm whitespace-nowrap ml-1 ${isDarkMode ? 'text-gray-300' : 'text-gray-600'}`}>å††</span>
                        </div>
                      </div>
                      <div>
                        <label className={`block text-sm font-medium mb-2 ${isDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                          äº‹æ¥­å‰²åˆ
                        </label>
                        <div className="flex items-center gap-1">
                          <input
                            type="number"
                            min="0"
                            max="100"
                            value={editingExpense.businessPercentage ?? 100}
                            onChange={(e) => {
                              const inputValue = e.target.value;
                              if (inputValue === '') {
                                setEditingExpense({...editingExpense, businessPercentage: ''});
                              } else {
                                const value = Math.min(100, Math.max(0, parseInt(inputValue) || 0));
                                setEditingExpense({...editingExpense, businessPercentage: value});
                              }
                            }}
                            onFocus={(e) => e.target.select()}
                            onBlur={(e) => {
                              if (e.target.value === '') {
                                setEditingExpense({...editingExpense, businessPercentage: 100});
                              }
                            }}
                            className={`w-full px-3 py-3 border-2 rounded-xl focus:outline-none ${isDarkMode ? 'bg-gray-700 border-gray-600 text-white focus:border-red-400' : 'border-gray-200 focus:border-red-500'}`}
                            placeholder="100"
                          />
                          <span className={`font-medium text-sm whitespace-nowrap ml-1 ${isDarkMode ? 'text-gray-300' : 'text-gray-600'}`}>%</span>
                        </div>
                      </div>
                    </div>

                    {/* å€Ÿæ–¹ç§‘ç›®ã¨è²¸æ–¹ç§‘ç›® */}
                    <div className="grid grid-cols-2 gap-3">
                      <div>
                        <label className={`block text-sm font-medium mb-2 ${isDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                          å€Ÿæ–¹ç§‘ç›®
                        </label>
                        <select
                          value={editingExpense.accountingSubject || 'travel'}
                          onChange={(e) => {
                            setEditingExpense({...editingExpense, accountingSubject: e.target.value});
                          }}
                          className={`w-full px-4 py-3 border-2 rounded-xl focus:outline-none ${isDarkMode ? 'bg-gray-700 border-gray-600 text-white focus:border-red-400' : 'border-gray-200 focus:border-red-500'}`}
                        >
                          <option value="travel">æ—…è²»äº¤é€šè²»ï¼ˆã‚¬ã‚½ãƒªãƒ³ãƒ»é§è»Šå ´ç­‰ï¼‰</option>
                          <option value="supplies">æ¶ˆè€—å“è²»ï¼ˆè£…å‚™å“ç­‰ï¼‰</option>
                          <option value="communication">é€šä¿¡è²»ï¼ˆæºå¸¯é›»è©±ç­‰ï¼‰</option>
                          <option value="repairs">ä¿®ç¹•è²»ï¼ˆè»Šä¸¡æ•´å‚™ç­‰ï¼‰</option>
                          <option value="entertainment">æ¥å¾…äº¤éš›è²»ï¼ˆä¼šé£Ÿç­‰ï¼‰</option>
                          <option value="insurance">æå®³ä¿é™ºæ–™ï¼ˆè»Šä¸¡ä¿é™ºç­‰ï¼‰</option>
                          <option value="depreciation">æ¸›ä¾¡å„Ÿå´è²»ï¼ˆè»Šä¸¡ãƒ»ãƒã‚¤ã‚¯ï¼‰</option>
                          <option value="rent">åœ°ä»£å®¶è³ƒï¼ˆé§è»Šå ´æœˆæ¥µç­‰ï¼‰</option>
                          <option value="utilities">æ°´é“å…‰ç†±è²»</option>
                          <option value="welfare">ç¦åˆ©åšç”Ÿè²»</option>
                          <option value="tax">ç§Ÿç¨å…¬èª²ï¼ˆè‡ªå‹•è»Šç¨ç­‰ï¼‰</option>
                          <option value="advertising">åºƒå‘Šå®£ä¼è²»</option>
                          <option value="shipping">è·é€ é‹è³ƒ</option>
                          <option value="misc">é›‘è²»ï¼ˆãã®ä»–ï¼‰</option>
                        </select>
                      </div>
                      <div>
                        <label className={`block text-sm font-medium mb-2 ${isDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                          è²¸æ–¹ç§‘ç›®
                        </label>
                        <select
                          value={editingExpense.creditAccount || ''}
                          onChange={(e) => {
                            setEditingExpense({...editingExpense, creditAccount: e.target.value});
                          }}
                          className={`w-full px-4 py-3 border-2 rounded-xl focus:outline-none ${isDarkMode ? 'bg-gray-700 border-gray-600 text-white focus:border-red-400' : 'border-gray-200 focus:border-red-500'}`}
                        >
                          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                          {Object.entries(creditAccountSubjects).map(([key, name]) => (
                            <option key={key} value={key}>
                              {name}
                            </option>
                          ))}
                        </select>
                      </div>
                    </div>

                    {/* å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ */}
                    <div>
                      <label className={`block text-sm font-medium mb-2 ${isDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»ã‚¹ã‚¯ã‚·ãƒ§
                      </label>
                      <input
                        type="file"
                        accept="image/*"
                        onChange={(e) => {
                          const file = e.target.files[0];
                          if (file) {
                            // ç”»åƒã‚’ãƒªã‚µã‚¤ã‚ºã—ã¦ä¿å­˜
                            const reader = new FileReader();
                            reader.onload = (event) => {
                              const img = new Image();
                              img.onload = () => {
                                // ãƒªã‚µã‚¤ã‚ºã®æœ€å¤§ã‚µã‚¤ã‚º
                                const MAX_WIDTH = 1200;
                                const MAX_HEIGHT = 1200;

                                let width = img.width;
                                let height = img.height;

                                // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿ã£ã¦ãƒªã‚µã‚¤ã‚º
                                if (width > height) {
                                  if (width > MAX_WIDTH) {
                                    height = height * (MAX_WIDTH / width);
                                    width = MAX_WIDTH;
                                  }
                                } else {
                                  if (height > MAX_HEIGHT) {
                                    width = width * (MAX_HEIGHT / height);
                                    height = MAX_HEIGHT;
                                  }
                                }

                                // Canvasã§ãƒªã‚µã‚¤ã‚º
                                const canvas = document.createElement('canvas');
                                canvas.width = width;
                                canvas.height = height;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, width, height);

                                // JPEGå½¢å¼ã§åœ§ç¸®ï¼ˆå“è³ª80%ï¼‰
                                const resizedDataUrl = canvas.toDataURL('image/jpeg', 0.8);
                                setEditingExpense({...editingExpense, photo: resizedDataUrl});

                                // OCRå‡¦ç†ã‚’å®Ÿè¡Œï¼ˆVision APIã‚­ãƒ¼ãŒã‚ã‚‹å ´åˆï¼‰
                                if (visionApiKey) {
                                  extractReceiptData(resizedDataUrl).then(result => {
                                    if (result) {
                                      // èªè­˜çµæœã‚’è‡ªå‹•å…¥åŠ›
                                      setEditingExpense(prev => {
                                        const updateData = {
                                          ...prev,
                                          date: result.date,
                                          amount: result.amount,
                                          memo: result.itemName ? (prev.memo ? prev.memo + '\n' + result.itemName : result.itemName) : prev.memo
                                        };

                                        // å€Ÿæ–¹ç§‘ç›®ãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆã¯è¨­å®šï¼ˆã‚¬ã‚½ãƒªãƒ³ãƒ¬ã‚·ãƒ¼ãƒˆç­‰ï¼‰
                                        if (result.accountingSubject) {
                                          updateData.accountingSubject = result.accountingSubject;
                                        }

                                        // æ”¯æ‰•æ–¹æ³•ãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆã¯è²¸æ–¹ç§‘ç›®ã‚’è¨­å®š
                                        if (result.paymentMethod) {
                                          updateData.creditAccount = result.paymentMethod;
                                        }

                                        // åº—èˆ—åãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆã¯è¨­å®š
                                        if (result.vendor) {
                                          updateData.vendor = result.vendor;
                                        }

                                        return updateData;
                                      });

                                      // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                                      if (result.amount > 0 || result.itemName || result.paymentMethod) {
                                        const paymentMethodName = result.paymentMethod === 'cash' ? 'ç¾é‡‘' :
                                                                 result.paymentMethod === 'credit' ? 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ' :
                                                                 result.paymentMethod === 'ordinaryDeposit' ? 'æ™®é€šé é‡‘' : '';
                                        console.log('OCRèªè­˜æˆåŠŸ:', result, paymentMethodName ? `æ”¯æ‰•æ–¹æ³•: ${paymentMethodName}` : '');
                                      }
                                    }
                                  });
                                }
                              };
                              img.src = event.target.result;
                            };
                            reader.readAsDataURL(file);
                          }
                        }}
                        className={`w-full px-4 py-3 border-2 rounded-xl focus:outline-none text-sm ${isDarkMode ? 'bg-gray-700 border-gray-600 text-white focus:border-red-400' : 'border-gray-200 focus:border-red-500'}`}
                      />
                      {isProcessingOCR && (
                        <div className="mt-2 p-3 bg-blue-50 rounded-lg">
                          <div className="flex items-center gap-2 text-blue-700">
                            <svg className="animate-spin h-5 w-5" viewBox="0 0 24 24">
                              <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"></circle>
                              <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span className="text-sm font-medium">ãƒ¬ã‚·ãƒ¼ãƒˆã‚’èªè­˜ä¸­...</span>
                          </div>
                        </div>
                      )}
                      {editingExpense.photo && (
                        <div className="mt-2">
                          <img
                            src={editingExpense.photo}
                            alt="ãƒ¬ã‚·ãƒ¼ãƒˆ"
                            onClick={() => {
                              setPreviewImage(editingExpense.photo);
                              setShowImagePreview(true);
                            }}
                            className="w-full rounded-lg border-2 border-gray-200 cursor-pointer hover:border-blue-400 transition-colors"
                            style={{ maxHeight: '200px', objectFit: 'contain' }}
                          />
                          <button
                            type="button"
                            onClick={() => setEditingExpense({...editingExpense, photo: null})}
                            className="mt-2 text-sm text-red-600 hover:text-red-800"
                          >
                            ç”»åƒã‚’å‰Šé™¤
                          </button>
                        </div>
                      )}
                    </div>
                  </div>
                </div>

                <div
                  className={`p-4 border-t ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}
                  style={{flexShrink: 0, touchAction: 'none'}}
                >
                  <div className="flex gap-2">
                    <button
                      onClick={async () => {
                          try {
                            // ãƒãƒƒã‚·ãƒ¥å€¤ã®è¨ˆç®—ï¼ˆæ”¹ã–ã‚“é˜²æ­¢ï¼‰
                            const calculateHash = async (data) => {
                              const msgBuffer = new TextEncoder().encode(JSON.stringify(data));
                              const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                              const hashArray = Array.from(new Uint8Array(hashBuffer));
                              return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                            };

                            let photoUrl = editingExpense.photo;

                            // Upload photo to Supabase Storage if it's a base64 string
                            if (photoUrl && photoUrl.startsWith('data:image/')) {
                              const base64Data = photoUrl.split(',')[1];
                              const byteCharacters = atob(base64Data);
                              const byteNumbers = new Array(byteCharacters.length);
                              for (let i = 0; i < byteCharacters.length; i++) {
                                byteNumbers[i] = byteCharacters.charCodeAt(i);
                              }
                              const byteArray = new Uint8Array(byteNumbers);
                              const blob = new Blob([byteArray], { type: 'image/jpeg' });

                              const fileName = `${session.user.id}/${Date.now()}.jpg`;
                              const { data: uploadData, error: uploadError } = await supabaseClient.storage
                                .from('expense-photos')
                                .upload(fileName, blob);

                              if (uploadError) throw uploadError;

                              // Get public URL
                              const { data: { publicUrl } } = supabaseClient.storage
                                .from('expense-photos')
                                .getPublicUrl(fileName);

                              photoUrl = publicUrl;
                            }

                            if (editingExpenseId) {
                              // ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å¤‰æ›´ä¸å¯
                              if (expenses[editingExpenseId]?.isLocked) {
                                alert('ã“ã®çµŒè²»ã¯ç¢ºå®šæ¸ˆã¿ã®ãŸã‚å¤‰æ›´ã§ãã¾ã›ã‚“ã€‚');
                                return;
                              }

                              // Update existing expense
                              const { error } = await supabaseClient
                                .from('expenses')
                                .update({
                                  date: editingExpense.date,
                                  amount: editingExpense.amount,
                                  business_percentage: editingExpense.businessPercentage,
                                  accounting_subject: editingExpense.accountingSubject || '',
                                  credit_account: editingExpense.creditAccount || '',
                                  photo_url: photoUrl || null,
                                  memo: editingExpense.memo || '',
                                  vendor: normalizeVendorName(editingExpense.vendor || ''),
                                  updated_at: new Date().toISOString()
                                })
                                .eq('id', editingExpenseId)
                                .eq('user_id', session.user.id);

                              if (error) throw error;

                              setExpenses(prev => ({
                                ...prev,
                                [editingExpenseId]: { ...editingExpense, photo: photoUrl }
                              }));
                            } else {
                              // ãƒãƒƒã‚·ãƒ¥å€¤ã‚’è¨ˆç®—ï¼ˆæ”¹ã–ã‚“é˜²æ­¢ï¼‰
                              const dataToHash = {
                                date: editingExpense.date,
                                amount: editingExpense.amount,
                                vendor: normalizeVendorName(editingExpense.vendor || ''),
                                photo: photoUrl
                              };
                              const originalHash = await calculateHash(dataToHash);

                              // Create new expense
                              const { data, error } = await supabaseClient
                                .from('expenses')
                                .insert({
                                  user_id: session.user.id,
                                  date: editingExpense.date,
                                  amount: editingExpense.amount,
                                  business_percentage: editingExpense.businessPercentage,
                                  accounting_subject: editingExpense.accountingSubject || '',
                                  credit_account: editingExpense.creditAccount || '',
                                  photo_url: photoUrl || null,
                                  memo: editingExpense.memo || '',
                                  vendor: normalizeVendorName(editingExpense.vendor || ''),
                                  uploaded_at: new Date().toISOString(),
                                  original_hash: originalHash
                                })
                                .select()
                                .single();

                              if (error) throw error;

                              setExpenses(prev => ({
                                ...prev,
                                [data.id]: { ...editingExpense, photo: photoUrl }
                              }));
                            }
                            setShowExpenseInput(false);
                          } catch (error) {
                            console.error('Save error:', error);
                            alert('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                          }
                        }}
                        className="flex-[2] bg-red-500 text-white py-3 rounded-xl font-medium hover:bg-red-600 transition-colors"
                        style={{touchAction: 'auto'}}
                      >
                        ä¿å­˜
                      </button>
                      <button
                        onClick={() => setShowExpenseInput(false)}
                        className="flex-1 bg-gray-500 text-white py-3 rounded-xl font-medium hover:bg-gray-600 transition-colors"
                        style={{touchAction: 'auto'}}
                      >
                        é–‰ã˜ã‚‹
                      </button>
                    </div>
                </div>
              </div>
            )}

            {/* çµŒè²»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« */}
            {showExpenseFilter && (
              <div
                className={`fixed inset-0 z-[60] ${isDarkMode ? 'bg-gray-900' : 'bg-white'}`}
                style={{
                  display: 'flex',
                  flexDirection: 'column',
                  overflow: 'hidden'
                }}
              >
                <div
                  className={`border-b p-4 flex items-center justify-between ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}
                  style={{flexShrink: 0, touchAction: 'none'}}
                >
                  <h2 className={`text-xl font-bold ${isDarkMode ? 'text-white' : 'text-gray-800'}`}>ğŸ” æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h2>
                  <button
                    onClick={() => setShowExpenseFilter(false)}
                    className={`text-2xl ${isDarkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}`}
                    style={{touchAction: 'auto'}}
                  >
                    âœ•
                  </button>
                </div>

                <div
                  className="flex-1 overflow-y-auto"
                  style={{touchAction: 'auto'}}
                >
                  <div className="p-4 space-y-4">
                    {/* æ—¥ä»˜ç¯„å›² */}
                    <div>
                      <label className={`block text-sm font-medium mb-2 ${isDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>ğŸ“… æ—¥ä»˜ç¯„å›²</label>
                      <div className="grid grid-cols-2 gap-3">
                        <input
                          type="date"
                          value={expenseFilter.startDate || ''}
                          onChange={(e) => setExpenseFilter({...expenseFilter, startDate: e.target.value})}
                          className={`px-4 py-3 border-2 rounded-xl focus:outline-none ${isDarkMode ? 'bg-gray-700 border-gray-600 text-white focus:border-blue-400' : 'border-gray-200 focus:border-blue-500'}`}
                          placeholder="é–‹å§‹æ—¥"
                        />
                        <input
                          type="date"
                          value={expenseFilter.endDate || ''}
                          onChange={(e) => setExpenseFilter({...expenseFilter, endDate: e.target.value})}
                          className={`px-4 py-3 border-2 rounded-xl focus:outline-none ${isDarkMode ? 'bg-gray-700 border-gray-600 text-white focus:border-blue-400' : 'border-gray-200 focus:border-blue-500'}`}
                          placeholder="çµ‚äº†æ—¥"
                        />
                      </div>
                    </div>

                    {/* å€Ÿæ–¹ç§‘ç›® */}
                    <div>
                      <label className={`block text-sm font-medium mb-2 ${isDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>ğŸ“‹ å€Ÿæ–¹ç§‘ç›®</label>
                      <select
                        value={expenseFilter.accountingSubject || ''}
                        onChange={(e) => setExpenseFilter({...expenseFilter, accountingSubject: e.target.value})}
                        className={`w-full px-4 py-3 border-2 rounded-xl focus:outline-none ${isDarkMode ? 'bg-gray-700 border-gray-600 text-white focus:border-blue-400' : 'border-gray-200 focus:border-blue-500'}`}
                      >
                        <option value="">ã™ã¹ã¦</option>
                        <option value="travel">æ—…è²»äº¤é€šè²»ï¼ˆã‚¬ã‚½ãƒªãƒ³ãƒ»é§è»Šå ´ç­‰ï¼‰</option>
                        <option value="supplies">æ¶ˆè€—å“è²»ï¼ˆè£…å‚™å“ç­‰ï¼‰</option>
                        <option value="communication">é€šä¿¡è²»ï¼ˆæºå¸¯é›»è©±ç­‰ï¼‰</option>
                        <option value="repairs">ä¿®ç¹•è²»ï¼ˆè»Šä¸¡æ•´å‚™ç­‰ï¼‰</option>
                        <option value="entertainment">æ¥å¾…äº¤éš›è²»ï¼ˆä¼šé£Ÿç­‰ï¼‰</option>
                        <option value="utilities">æ°´é“å…‰ç†±è²»</option>
                        <option value="rent">åœ°ä»£å®¶è³ƒ</option>
                        <option value="insurance">ä¿é™ºæ–™</option>
                        <option value="misc">é›‘è²»</option>
                      </select>
                    </div>

                    {/* å–å¼•å…ˆ */}
                    <div>
                      <label className={`block text-sm font-medium mb-2 ${isDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>ğŸª å–å¼•å…ˆ</label>
                      <input
                        type="text"
                        value={expenseFilter.vendor || ''}
                        onChange={(e) => setExpenseFilter({...expenseFilter, vendor: e.target.value})}
                        className={`w-full px-4 py-3 border-2 rounded-xl focus:outline-none ${isDarkMode ? 'bg-gray-700 border-gray-600 text-white focus:border-blue-400' : 'border-gray-200 focus:border-blue-500'}`}
                        placeholder="å–å¼•å…ˆåã§æ¤œç´¢"
                      />
                    </div>

                    {/* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ä¸­ã®è¡¨ç¤º */}
                    {(expenseFilter.startDate || expenseFilter.endDate || expenseFilter.accountingSubject || expenseFilter.vendor) && (
                      <div className={`rounded-xl p-4 border-2 ${isDarkMode ? 'bg-blue-900 border-blue-700' : 'bg-blue-50 border-blue-200'}`}>
                        <div className="flex items-center gap-2 mb-2">
                          <span className={`text-lg ${isDarkMode ? 'text-blue-400' : 'text-blue-600'}`}>ğŸ”</span>
                          <span className={`font-bold ${isDarkMode ? 'text-blue-300' : 'text-blue-800'}`}>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ä¸­</span>
                        </div>
                        <div className={`text-xs space-y-1 ${isDarkMode ? 'text-blue-400' : 'text-blue-700'}`}>
                          {expenseFilter.startDate && <div>é–‹å§‹æ—¥: {expenseFilter.startDate}</div>}
                          {expenseFilter.endDate && <div>çµ‚äº†æ—¥: {expenseFilter.endDate}</div>}
                          {expenseFilter.accountingSubject && <div>å€Ÿæ–¹ç§‘ç›®: {accountingSubjects[expenseFilter.accountingSubject]}</div>}
                          {expenseFilter.vendor && <div>å–å¼•å…ˆ: {expenseFilter.vendor}</div>}
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                <div
                  className={`p-4 border-t space-y-2 ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}
                  style={{flexShrink: 0, touchAction: 'none'}}
                >
                  <button
                    onClick={() => {
                      setExpenseFilter({});
                      setShowExpenseFilter(false);
                    }}
                    className={`w-full py-3 rounded-xl font-medium transition-colors ${isDarkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                    style={{touchAction: 'auto'}}
                  >
                    ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢
                  </button>
                  <button
                    onClick={() => setShowExpenseFilter(false)}
                    className="w-full bg-blue-500 text-white py-3 rounded-xl font-medium hover:bg-blue-600 transition-colors"
                    style={{touchAction: 'auto'}}
                  >
                    ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
                  </button>
                </div>
              </div>
            )}

            {/* ç§‘ç›®èª¬æ˜ãƒ¢ãƒ¼ãƒ€ãƒ« */}
            {showExpenseGuide && (
              <div
                className={`fixed inset-0 z-[60] ${isDarkMode ? 'bg-gray-900' : 'bg-white'}`}
                style={{
                  display: 'flex',
                  flexDirection: 'column',
                  overflow: 'hidden'
                }}
              >
                <div
                  className={`border-b p-4 flex items-center justify-between ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}
                  style={{flexShrink: 0, touchAction: 'none'}}
                >
                  <h2 className={`text-xl font-bold ${isDarkMode ? 'text-white' : 'text-gray-800'}`}>ğŸ“‹ çµŒè²»ç§‘ç›®ã®èª¬æ˜</h2>
                  <button
                    onClick={() => setShowExpenseGuide(false)}
                    className={`text-2xl ${isDarkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}`}
                    style={{touchAction: 'auto'}}
                  >
                    âœ•
                  </button>
                </div>

                <div
                  className="flex-1 overflow-y-auto"
                  style={{touchAction: 'auto'}}
                >
                  <div className="p-4 space-y-3">
                    <div className="bg-blue-50 rounded-xl p-4 border-2 border-blue-200">
                      <div className="font-bold text-blue-800 mb-2">ğŸš— æ—…è²»äº¤é€šè²»</div>
                      <div className="text-sm text-gray-700 space-y-1">
                        <div>â€¢ ã‚¬ã‚½ãƒªãƒ³ä»£ï¼ˆãƒã‚¤ã‚ªã‚¯ã€ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼ã€è»½æ²¹ï¼‰</div>
                        <div>â€¢ é§è»Šå ´ä»£ã€ã‚³ã‚¤ãƒ³ãƒ‘ãƒ¼ã‚­ãƒ³ã‚°</div>
                        <div>â€¢ é«˜é€Ÿé“è·¯æ–™é‡‘</div>
                        <div>â€¢ æ´—è»Šä»£</div>
                        <div>â€¢ é›»è»Šã€ãƒã‚¹ã€ã‚¿ã‚¯ã‚·ãƒ¼ä»£</div>
                        <div>â€¢ å‡ºå¼µæ™‚ã®ç§»å‹•è²»ï¼ˆæ–°å¹¹ç·šã€é£›è¡Œæ©Ÿç­‰ï¼‰</div>
                        <div>â€¢ å‡ºå¼µæ™‚ã®å®¿æ³Šè²»ï¼ˆãƒ›ãƒ†ãƒ«ã€æ—…é¤¨ç­‰ï¼‰</div>
                      </div>
                    </div>

                    <div className="bg-green-50 rounded-xl p-4 border-2 border-green-200">
                      <div className="font-bold text-green-800 mb-2">ğŸ“¦ æ¶ˆè€—å“è²»</div>
                      <div className="text-sm text-gray-700 space-y-1">
                        <div>â€¢ é…é”ç”¨ãƒãƒƒã‚°ã€ä¿æ¸©ãƒãƒƒã‚°</div>
                        <div>â€¢ ã‚¹ãƒãƒ›ãƒ›ãƒ«ãƒ€ãƒ¼ã€å……é›»å™¨</div>
                        <div>â€¢ æ–‡æˆ¿å…·ã€ãƒ¡ãƒ¢å¸³</div>
                        <div>â€¢ 10ä¸‡å††æœªæº€ã®å‚™å“</div>
                      </div>
                    </div>

                    <div className="bg-purple-50 rounded-xl p-4 border-2 border-purple-200">
                      <div className="font-bold text-purple-800 mb-2">ğŸ“± é€šä¿¡è²»</div>
                      <div className="text-sm text-gray-700 space-y-1">
                        <div>â€¢ æºå¸¯é›»è©±æ–™é‡‘ï¼ˆæ¥­å‹™ä½¿ç”¨åˆ†ï¼‰</div>
                        <div>â€¢ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ–™é‡‘</div>
                        <div>â€¢ ãƒ¢ãƒã‚¤ãƒ«Wi-Fiæ–™é‡‘</div>
                      </div>
                    </div>

                    <div className="bg-orange-50 rounded-xl p-4 border-2 border-orange-200">
                      <div className="font-bold text-orange-800 mb-2">ğŸ”§ ä¿®ç¹•è²»</div>
                      <div className="text-sm text-gray-700 space-y-1">
                        <div>â€¢ è»Šä¸¡ã®ä¿®ç†ä»£</div>
                        <div>â€¢ ã‚¿ã‚¤ãƒ¤äº¤æ›ã€ã‚ªã‚¤ãƒ«äº¤æ›</div>
                        <div>â€¢ ãƒã‚¤ã‚¯ã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹</div>
                        <div>â€¢ è»Šæ¤œè²»ç”¨</div>
                      </div>
                    </div>

                    <div className="bg-red-50 rounded-xl p-4 border-2 border-red-200">
                      <div className="font-bold text-red-800 mb-2">ğŸ½ï¸ æ¥å¾…äº¤éš›è²»</div>
                      <div className="text-sm text-gray-700 space-y-1">
                        <div>â€¢ å–å¼•å…ˆã¨ã®ä¼šé£Ÿè²»</div>
                        <div>â€¢ æ‰“ã¡åˆã‚ã›æ™‚ã®é£²é£Ÿè²»</div>
                        <div>â€¢ ãŠä¸­å…ƒã€ãŠæ­³æš®</div>
                        <div>â€¢ æ…¶å¼”è²»ï¼ˆç¥å„€ã€é¦™å…¸ç­‰ï¼‰</div>
                        <div className="text-xs text-red-600 mt-2">â€»å¹´é–“800ä¸‡å††ã¾ã§æé‡‘ç®—å…¥å¯èƒ½</div>
                      </div>
                    </div>

                    <div className="bg-yellow-50 rounded-xl p-4 border-2 border-yellow-200">
                      <div className="font-bold text-yellow-800 mb-2">ğŸ’¡ æ°´é“å…‰ç†±è²»</div>
                      <div className="text-sm text-gray-700 space-y-1">
                        <div>â€¢ é›»æ°—ä»£ï¼ˆæ¥­å‹™ä½¿ç”¨åˆ†ï¼‰</div>
                        <div>â€¢ æ°´é“ä»£ï¼ˆæ¥­å‹™ä½¿ç”¨åˆ†ï¼‰</div>
                        <div>â€¢ ã‚¬ã‚¹ä»£ï¼ˆæ¥­å‹™ä½¿ç”¨åˆ†ï¼‰</div>
                      </div>
                    </div>

                    <div className="bg-pink-50 rounded-xl p-4 border-2 border-pink-200">
                      <div className="font-bold text-pink-800 mb-2">ğŸ  åœ°ä»£å®¶è³ƒ</div>
                      <div className="text-sm text-gray-700 space-y-1">
                        <div>â€¢ äº‹å‹™æ‰€å®¶è³ƒ</div>
                        <div>â€¢ é§è»Šå ´è³ƒè²¸æ–™</div>
                        <div>â€¢ è‡ªå®…å®¶è³ƒï¼ˆäº‹æ¥­ä½¿ç”¨åˆ†ï¼‰</div>
                      </div>
                    </div>

                    <div className="bg-indigo-50 rounded-xl p-4 border-2 border-indigo-200">
                      <div className="font-bold text-indigo-800 mb-2">ğŸ›¡ï¸ ä¿é™ºæ–™</div>
                      <div className="text-sm text-gray-700 space-y-1">
                        <div>â€¢ è‡ªå‹•è»Šä¿é™ºï¼ˆä»»æ„ä¿é™ºï¼‰</div>
                        <div>â€¢ ãƒã‚¤ã‚¯ä¿é™º</div>
                        <div>â€¢ è‡ªè»¢è»Šä¿é™º</div>
                        <div>â€¢ è³ å„Ÿè²¬ä»»ä¿é™º</div>
                      </div>
                    </div>

                    <div className="bg-gray-50 rounded-xl p-4 border-2 border-gray-200">
                      <div className="font-bold text-gray-800 mb-2">ğŸ“ é›‘è²»</div>
                      <div className="text-sm text-gray-700 space-y-1">
                        <div>â€¢ ä¸Šè¨˜ã«è©²å½“ã—ãªã„å°‘é¡ã®çµŒè²»</div>
                        <div>â€¢ æ‰‹æ•°æ–™ã€æŒ¯è¾¼æ‰‹æ•°æ–™</div>
                        <div>â€¢ ãã®ä»–ã®çµŒè²»</div>
                      </div>
                    </div>
                  </div>
                </div>

                <div
                  className={`p-4 border-t ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}
                  style={{flexShrink: 0, touchAction: 'none'}}
                >
                  <button
                    onClick={() => setShowExpenseGuide(false)}
                    className="w-full bg-gray-500 text-white py-3 rounded-xl font-medium hover:bg-gray-600 transition-colors"
                    style={{touchAction: 'auto'}}
                  >
                    é–‰ã˜ã‚‹
                  </button>
                </div>
              </div>
            )}

            {/* ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« */}
            {showImagePreview && previewImage && (
              <div
                className="fixed inset-0 bg-black/90 flex items-center justify-center z-[70] p-4"
                onClick={() => setShowImagePreview(false)}
              >
                <div className="relative max-w-4xl w-full max-h-full flex flex-col items-center">
                  <button
                    onClick={() => setShowImagePreview(false)}
                    className="absolute top-2 right-2 bg-white/90 hover:bg-white text-gray-800 rounded-full w-10 h-10 flex items-center justify-center text-2xl font-bold shadow-lg z-10"
                    style={{touchAction: 'auto'}}
                  >
                    Ã—
                  </button>
                  <img
                    src={previewImage}
                    alt="ãƒ¬ã‚·ãƒ¼ãƒˆæ‹¡å¤§"
                    className="max-w-full max-h-[90vh] object-contain rounded-lg"
                    onClick={(e) => e.stopPropagation()}
                  />
                </div>
              </div>
            )}

            {/* è²¸å€Ÿå¯¾ç…§è¡¨ãƒ¢ãƒ¼ãƒ€ãƒ« */}
            {showBalanceSheet && (
              <div
                className={`fixed inset-0 z-50 ${isDarkMode ? 'bg-gray-900' : 'bg-white'}`}
                style={{
                  display: 'flex',
                  flexDirection: 'column',
                  overflow: 'hidden'
                }}
              >
                <div
                  className={`border-b p-4 flex items-center justify-between ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}
                  style={{flexShrink: 0, touchAction: 'none'}}
                >
                  <h2 className={`text-xl font-bold ${isDarkMode ? 'text-white' : 'text-gray-800'}`}>ğŸ“Š è²¸å€Ÿå¯¾ç…§è¡¨</h2>
                  <button
                    onClick={() => setShowBalanceSheet(false)}
                    className={`text-2xl ${isDarkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}`}
                    style={{touchAction: 'auto'}}
                  >
                    âœ•
                  </button>
                </div>

                <div
                  className="flex-1 overflow-y-auto"
                  style={{touchAction: 'auto'}}
                >
                  <div className="p-4">
                    {(() => {
                      // å…¨æœŸé–“ã®é›†è¨ˆã‚’è¨ˆç®—
                      const allTimeEarnings = Object.entries(dailyData).reduce((sum, [date, data]) => {
                        return sum + (data.earnings || 0) + (data.quest || 0);
                      }, 0);

                      const totalExpenses = Object.entries(expenses || {}).reduce((sum, [id, expense]) => {
                        return sum + Math.floor((expense.amount || 0) * (expense.businessPercentage ?? 100) / 100);
                      }, 0);

                      const netProfit = allTimeEarnings - totalExpenses;

                      // ã‚«ãƒ†ã‚´ãƒªåˆ¥çµŒè²»é›†è¨ˆ
                      const expensesByCategory = {};
                      Object.entries(expenses || {}).forEach(([id, expense]) => {
                        const category = expense.accountingSubject || 'misc';
                        if (!expensesByCategory[category]) {
                          expensesByCategory[category] = 0;
                        }
                        expensesByCategory[category] += Math.floor((expense.amount || 0) * (expense.businessPercentage ?? 100) / 100);
                      });

                      return (
                        <div className="space-y-6">
                          {/* è³‡ç”£ã®éƒ¨ */}
                          <div className="bg-green-50 rounded-xl p-4">
                            <h3 className="font-bold text-green-800 text-lg mb-4">è³‡ç”£ã®éƒ¨</h3>
                            <div className="space-y-2">
                              <div className="flex justify-between items-center p-2 bg-white rounded-lg">
                                <span className="text-gray-700">ç¾é‡‘ãƒ»é é‡‘</span>
                                <span className="font-bold text-green-600">Â¥{netProfit.toLocaleString()}</span>
                              </div>
                              <div className="flex justify-between items-center p-2 bg-white rounded-lg">
                                <span className="text-gray-700">å£²æ›é‡‘ï¼ˆæœªåå…¥é‡‘ï¼‰</span>
                                <span className="font-bold text-gray-600">Â¥0</span>
                              </div>
                              <div className="border-t-2 border-green-300 pt-2 mt-3">
                                <div className="flex justify-between items-center">
                                  <span className="font-bold text-green-800">è³‡ç”£åˆè¨ˆ</span>
                                  <span className="font-bold text-green-800 text-lg">Â¥{netProfit.toLocaleString()}</span>
                                </div>
                              </div>
                            </div>
                          </div>

                          {/* è² å‚µã®éƒ¨ */}
                          <div className="bg-red-50 rounded-xl p-4">
                            <h3 className="font-bold text-red-800 text-lg mb-4">è² å‚µã®éƒ¨</h3>
                            <div className="space-y-2">
                              <div className="flex justify-between items-center p-2 bg-white rounded-lg">
                                <span className="text-gray-700">æœªæ‰•é‡‘</span>
                                <span className="font-bold text-gray-600">Â¥0</span>
                              </div>
                              <div className="flex justify-between items-center p-2 bg-white rounded-lg">
                                <span className="text-gray-700">é ã‚Šé‡‘</span>
                                <span className="font-bold text-gray-600">Â¥0</span>
                              </div>
                              <div className="border-t-2 border-red-300 pt-2 mt-3">
                                <div className="flex justify-between items-center">
                                  <span className="font-bold text-red-800">è² å‚µåˆè¨ˆ</span>
                                  <span className="font-bold text-red-800 text-lg">Â¥0</span>
                                </div>
                              </div>
                            </div>
                          </div>

                          {/* ç´”è³‡ç”£ã®éƒ¨ */}
                          <div className="bg-blue-50 rounded-xl p-4">
                            <h3 className="font-bold text-blue-800 text-lg mb-4">ç´”è³‡ç”£ã®éƒ¨</h3>
                            <div className="space-y-2">
                              <div className="flex justify-between items-center p-2 bg-white rounded-lg">
                                <span className="text-gray-700">å…ƒå…¥é‡‘</span>
                                <span className="font-bold text-gray-600">Â¥0</span>
                              </div>
                              <div className="flex justify-between items-center p-2 bg-white rounded-lg">
                                <span className="text-gray-700">å½“æœŸç´”åˆ©ç›Š</span>
                                <span className="font-bold text-blue-600">Â¥{netProfit.toLocaleString()}</span>
                              </div>
                              <div className="border-t-2 border-blue-300 pt-2 mt-3">
                                <div className="flex justify-between items-center">
                                  <span className="font-bold text-blue-800">ç´”è³‡ç”£åˆè¨ˆ</span>
                                  <span className="font-bold text-blue-800 text-lg">Â¥{netProfit.toLocaleString()}</span>
                                </div>
                              </div>
                            </div>
                          </div>

                          {/* ãƒãƒ©ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯ */}
                          <div className="bg-gray-100 rounded-xl p-4">
                            <div className="flex justify-between items-center">
                              <span className="font-bold text-gray-700">è²¸å€Ÿãƒãƒ©ãƒ³ã‚¹</span>
                              <span className="font-bold text-green-600 text-lg">
                                {netProfit === netProfit ? 'âœ… ä¸€è‡´' : 'âŒ ä¸ä¸€è‡´'}
                              </span>
                            </div>
                          </div>
                        </div>
                      );
                    })()}
                  </div>
                </div>

                <div
                  className={`p-4 border-t ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}
                  style={{flexShrink: 0, touchAction: 'none'}}
                >
                  <button
                    onClick={() => setShowBalanceSheet(false)}
                    className="w-full bg-gray-500 text-white py-3 rounded-xl font-medium hover:bg-gray-600 transition-colors"
                    style={{touchAction: 'auto'}}
                  >
                    é–‰ã˜ã‚‹
                  </button>
                </div>
              </div>
            )}

            {/* æç›Šè¨ˆç®—æ›¸ãƒ¢ãƒ¼ãƒ€ãƒ« */}
            {showIncomeStatement && (
              <div
                className={`fixed inset-0 z-50 ${isDarkMode ? 'bg-gray-900' : 'bg-white'}`}
                style={{
                  display: 'flex',
                  flexDirection: 'column',
                  overflow: 'hidden'
                }}
              >
                <div
                  className={`border-b p-4 flex items-center justify-between ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}
                  style={{flexShrink: 0, touchAction: 'none'}}
                >
                  <h2 className={`text-xl font-bold ${isDarkMode ? 'text-white' : 'text-gray-800'}`}>ğŸ“ˆ æç›Šè¨ˆç®—æ›¸</h2>
                  <button
                    onClick={() => setShowIncomeStatement(false)}
                    className={`text-2xl ${isDarkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}`}
                    style={{touchAction: 'auto'}}
                  >
                    âœ•
                  </button>
                </div>

                <div
                  className="flex-1 overflow-y-auto"
                  style={{touchAction: 'auto'}}
                >
                  <div className="p-4">
                    {(() => {
                      // æœŸé–“é¸æŠï¼ˆå¹´é–“ãƒ™ãƒ¼ã‚¹ï¼‰
                      const periodType = incomeStatementPeriod;
                      const setPeriodType = setIncomeStatementPeriod;

                      const now = new Date();
                      const thisYear = now.getFullYear();

                      let startDate, endDate, periodLabel;

                      switch (periodType) {
                        case 'thisYear':
                          startDate = new Date(thisYear, 0, 1);
                          endDate = new Date(thisYear, 11, 31);
                          periodLabel = `${thisYear}å¹´åº¦`;
                          break;
                        case 'lastYear':
                          startDate = new Date(thisYear - 1, 0, 1);
                          endDate = new Date(thisYear - 1, 11, 31);
                          periodLabel = `${thisYear - 1}å¹´åº¦`;
                          break;
                        case 'all':
                          startDate = new Date('2020-01-01');
                          endDate = new Date('2099-12-31');
                          periodLabel = 'å…¨æœŸé–“';
                          break;
                        default:
                          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ä»Šå¹´
                          startDate = new Date(thisYear, 0, 1);
                          endDate = new Date(thisYear, 11, 31);
                          periodLabel = `${thisYear}å¹´åº¦`;
                      }

                      // æœŸé–“å†…ã®ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
                      let periodEarnings = 0;
                      let periodQuest = 0;
                      let periodDeliveries = 0;
                      let periodHours = 0;
                      let periodDays = 0;

                      Object.entries(dailyData).forEach(([dateStr, data]) => {
                        const date = new Date(dateStr + 'T00:00:00');
                        if (date >= startDate && date <= endDate) {
                          periodEarnings += data.earnings || 0;
                          periodQuest += data.quest || 0;
                          periodDeliveries += data.deliveries || 0;
                          periodHours += data.hours || 0;
                          if (data.hours > 0) periodDays++;
                        }
                      });

                      const totalRevenue = periodEarnings + periodQuest;

                      // æœŸé–“å†…ã®çµŒè²»ã‚’é›†è¨ˆï¼ˆæ—¥æœ¬èªã®å‹˜å®šç§‘ç›®åã§ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°ï¼‰
                      const periodExpensesByJapanese = {};
                      let totalPeriodExpenses = 0;

                      Object.entries(expenses || {}).forEach(([id, expense]) => {
                        const expenseDate = new Date(expense.date + 'T00:00:00');
                        if (expenseDate >= startDate && expenseDate <= endDate) {
                          const category = expense.accountingSubject || 'misc';
                          const amount = Math.floor((expense.amount || 0) * (expense.businessPercentage ?? 100) / 100);

                          // ã‚«ãƒ†ã‚´ãƒªã‚’æ—¥æœ¬èªåã«å¤‰æ›
                          const japaneseName = accountingSubjects[category] || accountingSubjects.misc;

                          if (!periodExpensesByJapanese[japaneseName]) {
                            periodExpensesByJapanese[japaneseName] = 0;
                          }
                          periodExpensesByJapanese[japaneseName] += amount;
                          totalPeriodExpenses += amount;
                        }
                      });

                      const netIncome = totalRevenue - totalPeriodExpenses;
                      const profitMargin = totalRevenue > 0 ? (netIncome / totalRevenue * 100).toFixed(1) : 0;

                      return (
                        <div className="space-y-6">
                          {/* æœŸé–“é¸æŠ */}
                          <div className="flex gap-2 flex-wrap justify-center">
                            <button
                              onClick={() => setPeriodType('thisYear')}
                              className={`px-6 py-3 rounded-lg font-medium transition-colors text-base ${
                                periodType === 'thisYear'
                                  ? 'bg-teal-500 text-white shadow-lg'
                                  : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                              }`}
                            >
                              ä»Šå¹´åº¦
                            </button>
                            <button
                              onClick={() => setPeriodType('lastYear')}
                              className={`px-6 py-3 rounded-lg font-medium transition-colors text-base ${
                                periodType === 'lastYear'
                                  ? 'bg-teal-500 text-white shadow-lg'
                                  : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                              }`}
                            >
                              å‰å¹´åº¦
                            </button>
                            <button
                              onClick={() => setPeriodType('all')}
                              className={`px-6 py-3 rounded-lg font-medium transition-colors text-base ${
                                periodType === 'all'
                                  ? 'bg-teal-500 text-white shadow-lg'
                                  : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                              }`}
                            >
                              å…¨æœŸé–“
                            </button>
                          </div>

                          {/* æœŸé–“è¡¨ç¤º */}
                          <div className="bg-gray-100 rounded-xl p-3 text-center">
                            <span className="font-bold text-gray-700 text-lg">{periodLabel}</span>
                          </div>

                          {/* å£²ä¸Šé«˜ */}
                          <div className="bg-green-50 rounded-xl p-4">
                            <h3 className="font-bold text-green-800 text-lg mb-4">å£²ä¸Šé«˜</h3>
                            <div className="space-y-2">
                              <div className="flex justify-between items-center p-2 bg-white rounded-lg">
                                <span className="text-gray-700">é…é”å£²ä¸Š</span>
                                <span className="font-bold text-gray-700">Â¥{periodEarnings.toLocaleString()}</span>
                              </div>
                              <div className="flex justify-between items-center p-2 bg-white rounded-lg">
                                <span className="text-gray-700">ã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬</span>
                                <span className="font-bold text-gray-700">Â¥{periodQuest.toLocaleString()}</span>
                              </div>
                              <div className="border-t-2 border-green-300 pt-2 mt-3">
                                <div className="flex justify-between items-center">
                                  <span className="font-bold text-green-800">å£²ä¸Šé«˜åˆè¨ˆ</span>
                                  <span className="font-bold text-green-800 text-lg">Â¥{totalRevenue.toLocaleString()}</span>
                                </div>
                              </div>
                            </div>
                          </div>

                          {/* å£²ä¸ŠåŸä¾¡ãƒ»çµŒè²» */}
                          <div className="bg-red-50 rounded-xl p-4">
                            <h3 className="font-bold text-red-800 text-lg mb-4">å£²ä¸ŠåŸä¾¡ãƒ»çµŒè²»</h3>
                            <div className="space-y-2">
                              {Object.entries(periodExpensesByJapanese).map(([japaneseName, amount]) => (
                                <div key={japaneseName} className="flex justify-between items-center p-2 bg-white rounded-lg">
                                  <span className="text-gray-700">{japaneseName}</span>
                                  <span className="font-bold text-gray-700">Â¥{amount.toLocaleString()}</span>
                                </div>
                              ))}
                              {Object.keys(periodExpensesByJapanese).length === 0 && (
                                <div className="text-center text-gray-500 py-2">çµŒè²»ãƒ‡ãƒ¼ã‚¿ãªã—</div>
                              )}
                              <div className="border-t-2 border-red-300 pt-2 mt-3">
                                <div className="flex justify-between items-center">
                                  <span className="font-bold text-red-800">çµŒè²»åˆè¨ˆ</span>
                                  <span className="font-bold text-red-800 text-lg">Â¥{totalPeriodExpenses.toLocaleString()}</span>
                                </div>
                              </div>
                            </div>
                          </div>

                          {/* å–¶æ¥­åˆ©ç›Š */}
                          <div className="bg-blue-50 rounded-xl p-4">
                            <h3 className="font-bold text-blue-800 text-lg mb-4">å–¶æ¥­åˆ©ç›Š</h3>
                            <div className="space-y-2">
                              <div className="flex justify-between items-center p-2 bg-white rounded-lg">
                                <span className="text-gray-700">å£²ä¸Šç·åˆ©ç›Š</span>
                                <span className="font-bold text-gray-700">Â¥{totalRevenue.toLocaleString()}</span>
                              </div>
                              <div className="flex justify-between items-center p-2 bg-white rounded-lg">
                                <span className="text-gray-700">è²©å£²ç®¡ç†è²»</span>
                                <span className="font-bold text-red-600">-Â¥{totalPeriodExpenses.toLocaleString()}</span>
                              </div>
                              <div className="border-t-2 border-blue-300 pt-2 mt-3">
                                <div className="flex justify-between items-center">
                                  <span className="font-bold text-blue-800">å–¶æ¥­åˆ©ç›Š</span>
                                  <span className={`font-bold text-lg ${netIncome >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                    Â¥{netIncome.toLocaleString()}
                                  </span>
                                </div>
                              </div>
                            </div>
                          </div>

                          {/* åˆ©ç›Šç‡ãƒ»çµ±è¨ˆ */}
                          <div className="bg-purple-50 rounded-xl p-4">
                            <h3 className="font-bold text-purple-800 text-lg mb-4">çµŒå–¶æŒ‡æ¨™</h3>
                            <div className="space-y-2">
                              <div className="flex justify-between items-center p-2 bg-white rounded-lg">
                                <span className="text-gray-700">åˆ©ç›Šç‡</span>
                                <span className="font-bold text-purple-600">{profitMargin}%</span>
                              </div>
                              <div className="flex justify-between items-center p-2 bg-white rounded-lg">
                                <span className="text-gray-700">ç¨¼åƒæ—¥æ•°</span>
                                <span className="font-bold text-gray-700">{periodDays}æ—¥</span>
                              </div>
                              <div className="flex justify-between items-center p-2 bg-white rounded-lg">
                                <span className="text-gray-700">ç·é…é”ä»¶æ•°</span>
                                <span className="font-bold text-gray-700">{periodDeliveries}ä»¶</span>
                              </div>
                              <div className="flex justify-between items-center p-2 bg-white rounded-lg">
                                <span className="text-gray-700">å¹³å‡æ™‚çµ¦</span>
                                <span className="font-bold text-gray-700">
                                  Â¥{periodHours > 0 ? Math.round(totalRevenue / periodHours).toLocaleString() : 0}
                                </span>
                              </div>
                              <div className="flex justify-between items-center p-2 bg-white rounded-lg">
                                <span className="text-gray-700">1æ—¥å¹³å‡å£²ä¸Š</span>
                                <span className="font-bold text-gray-700">
                                  Â¥{periodDays > 0 ? Math.round(totalRevenue / periodDays).toLocaleString() : 0}
                                </span>
                              </div>
                            </div>
                          </div>
                        </div>
                      );
                    })()}
                  </div>
                </div>

                <div
                  className={`p-4 border-t ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}
                  style={{flexShrink: 0, touchAction: 'none'}}
                >
                  <button
                    onClick={() => setShowIncomeStatement(false)}
                    className="w-full bg-gray-500 text-white py-3 rounded-xl font-medium hover:bg-gray-600 transition-colors"
                    style={{touchAction: 'auto'}}
                  >
                    é–‰ã˜ã‚‹
                  </button>
                </div>
              </div>
            )}

            {/* é€±é–“å£²ä¸Šä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« */}
            {showWeeklySalesList && (
              <div
                className={`fixed inset-0 z-50 ${isDarkMode ? 'bg-gray-900' : 'bg-white'}`}
                style={{
                  display: 'flex',
                  flexDirection: 'column',
                  overflow: 'hidden'
                }}
              >
                <div
                  className={`border-b p-4 flex items-center justify-between ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}
                  style={{flexShrink: 0, touchAction: 'none'}}
                >
                  <h2 className={`text-xl font-bold ${isDarkMode ? 'text-white' : 'text-gray-800'}`}>ğŸ“Š é€±é–“å£²ä¸Šä¸€è¦§</h2>
                  <button
                    onClick={() => setShowWeeklySalesList(false)}
                    className={`text-2xl ${isDarkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}`}
                    style={{touchAction: 'auto'}}
                  >
                    Ã—
                  </button>
                </div>

                <div
                  style={{
                    flex: 1,
                    overflowY: 'auto',
                    WebkitOverflowScrolling: 'touch',
                    minHeight: 0
                  }}
                >
                  <div className="p-4 space-y-3">
                    {(() => {
                      // dailyDataã‹ã‚‰é€±ã”ã¨ã«é›†è¨ˆ
                      const weeklyData = {};

                      Object.entries(dailyData).forEach(([dateStr, data]) => {
                        const date = new Date(dateStr);
                        const dayOfWeek = date.getDay();

                        // ãã®æ—¥ã®é€±ã®æœˆæ›œæ—¥ã‚’è¨ˆç®—
                        const monday = new Date(date);
                        monday.setDate(date.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
                        const mondayStr = formatDateToLocal(monday);

                        if (!weeklyData[mondayStr]) {
                          weeklyData[mondayStr] = {
                            hours: 0,
                            deliveries: 0,
                            earnings: 0,
                            quest: 0,
                            days: 0
                          };
                        }

                        weeklyData[mondayStr].hours += data.hours || 0;
                        weeklyData[mondayStr].deliveries += data.deliveries || 0;
                        weeklyData[mondayStr].earnings += data.earnings || 0;
                        weeklyData[mondayStr].quest += data.quest || 0;
                        weeklyData[mondayStr].days += 1;
                      });

                      // ä»Šé€±ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                      const today = new Date();
                      const mondayOfThisWeek = new Date(today);
                      mondayOfThisWeek.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1));
                      mondayOfThisWeek.setHours(0, 0, 0, 0);
                      const thisMondayStr = formatDateToLocal(mondayOfThisWeek);

                      // ä»Šé€±ã®hoursã‹ã‚‰è¨ˆç®—ï¼ˆå®Ÿåƒã®ã¿: æ™‚é–“ãƒ»ä»¶æ•°ãƒ»é‡‘é¡å…¨ã¦å…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ï¼‰
                      const thisWeekData = {
                        hours: 0,
                        deliveries: 0,
                        earnings: 0,
                        quest: 0,
                        days: 0
                      };

                      Object.values(hours).forEach(dayData => {
                        // å®Ÿåƒã®æ¡ä»¶: æ™‚é–“ãƒ»ä»¶æ•°ãƒ»é‡‘é¡å…¨ã¦ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹
                        if (dayData.hours > 0 && dayData.deliveries > 0 && dayData.earnings > 0) {
                          thisWeekData.hours += dayData.hours;
                          thisWeekData.deliveries += dayData.deliveries;
                          thisWeekData.earnings += dayData.earnings;
                          thisWeekData.days += 1;
                        }
                      });

                      // ä»Šé€±ã®ã‚¯ã‚¨ã‚¹ãƒˆã‚’è¨ˆç®—ï¼ˆå®Ÿåƒä»¶æ•°ã®ã¿ã‚’ä½¿ç”¨ï¼‰
                      let weekdayDeliveries = 0;
                      let weekdayQuest = 0;
                      weekdays.forEach(day => {
                        const dayData = hours[day];
                        // å®Ÿåƒã®æ¡ä»¶: æ™‚é–“ãƒ»ä»¶æ•°ãƒ»é‡‘é¡å…¨ã¦ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹
                        if (dayData.hours > 0 && dayData.deliveries > 0 && dayData.earnings > 0) {
                          weekdayDeliveries += dayData.deliveries;
                        }
                      });

                      // ãƒ‡ãƒãƒƒã‚°ç”¨: ã‚¯ã‚¨ã‚¹ãƒˆè¨­å®šã‚’å‡ºåŠ›
                      console.log('weekdayDeliveries:', weekdayDeliveries);
                      console.log('weekdayQuests:', weekdayQuests);

                      let cumulative = 0;
                      for (let i = 0; i < weekdayQuests.length; i++) {
                        const quest = weekdayQuests[i];
                        if (weekdayDeliveries >= cumulative + quest.count) {
                          console.log(`Quest ${i + 1} é”æˆ: ${quest.count}ä»¶ã§${quest.reward}å††`);
                          weekdayQuest += quest.reward;
                          cumulative += quest.count;
                        } else {
                          // å‰ã®ã‚¯ã‚¨ã‚¹ãƒˆãŒæœªé”æˆãªã‚‰ã€æ¬¡ã®ã‚¯ã‚¨ã‚¹ãƒˆã¯è¨ˆç®—ã—ãªã„
                          console.log(`Quest ${i + 1} æœªé”æˆ: ${cumulative + quest.count}ä»¶å¿…è¦ã€ç¾åœ¨${weekdayDeliveries}ä»¶`);
                          break;
                        }
                      }

                      let weekendDeliveries = 0;
                      let weekendQuest = 0;
                      weekends.forEach(day => {
                        const dayData = hours[day];
                        // å®Ÿåƒã®æ¡ä»¶: æ™‚é–“ãƒ»ä»¶æ•°ãƒ»é‡‘é¡å…¨ã¦ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹
                        if (dayData.hours > 0 && dayData.deliveries > 0 && dayData.earnings > 0) {
                          weekendDeliveries += dayData.deliveries;
                        }
                      });

                      cumulative = 0;
                      for (let i = 0; i < weekendQuests.length; i++) {
                        const quest = weekendQuests[i];
                        if (weekendDeliveries >= cumulative + quest.count) {
                          weekendQuest += quest.reward;
                          cumulative += quest.count;
                        } else {
                          // å‰ã®ã‚¯ã‚¨ã‚¹ãƒˆãŒæœªé”æˆãªã‚‰ã€æ¬¡ã®ã‚¯ã‚¨ã‚¹ãƒˆã¯è¨ˆç®—ã—ãªã„
                          break;
                        }
                      }

                      thisWeekData.quest = weekdayQuest + weekendQuest;

                      if (thisWeekData.hours > 0) {
                        weeklyData[thisMondayStr] = thisWeekData;
                      }

                      // é€±ã‚’æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆã—ã¦ã€ä»Šé€±ä»¥å‰ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                      const sortedWeeks = Object.entries(weeklyData)
                        .filter(([mondayStr]) => mondayStr <= thisMondayStr) // ä»Šé€±ä»¥å‰ã®ã¿
                        .sort((a, b) => b[0].localeCompare(a[0]));

                      if (sortedWeeks.length === 0) {
                        return <div className="text-center text-gray-500 py-8">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>;
                      }

                      return sortedWeeks.map(([mondayStr, data]) => {
                        const monday = new Date(mondayStr);
                        const sunday = new Date(monday);
                        sunday.setDate(monday.getDate() + 6);

                        const totalEarnings = data.earnings + data.quest;
                        const avgHourlyWage = data.hours > 0 ? Math.round(totalEarnings / data.hours) : 0;

                        const isThisWeek = mondayStr === thisMondayStr;

                        return (
                          <div
                            key={mondayStr}
                            className={`rounded-xl p-4 border-2 ${isThisWeek ? 'bg-green-50 border-green-300' : 'bg-gray-50 border-gray-200'}`}
                          >
                            <div className="flex justify-between items-center mb-3">
                              <div>
                                <div className="font-bold text-gray-800">
                                  {monday.getMonth() + 1}/{monday.getDate()} - {sunday.getMonth() + 1}/{sunday.getDate()}
                                </div>
                                {isThisWeek && (
                                  <div className="text-xs text-green-600 font-medium">ä»Šé€±</div>
                                )}
                              </div>
                              <div className="text-right">
                                <div className="text-2xl font-bold text-green-600">
                                  Â¥{totalEarnings.toLocaleString()}
                                </div>
                                <div className="text-xs text-gray-500">
                                  {data.days}æ—¥ç¨¼åƒ
                                </div>
                              </div>
                            </div>

                            <div className="grid grid-cols-3 gap-2 text-sm">
                              <div className="bg-white rounded-lg p-2">
                                <div className="text-xs text-gray-600">ç¨¼åƒæ™‚é–“</div>
                                <div className="font-bold text-gray-800">{data.hours.toFixed(1)}h</div>
                              </div>
                              <div className="bg-white rounded-lg p-2">
                                <div className="text-xs text-gray-600">é…é”ä»¶æ•°</div>
                                <div className="font-bold text-gray-800">{data.deliveries}ä»¶</div>
                              </div>
                              <div className="bg-white rounded-lg p-2">
                                <div className="text-xs text-gray-600">å¹³å‡æ™‚çµ¦</div>
                                <div className="font-bold text-gray-800">Â¥{avgHourlyWage}</div>
                              </div>
                            </div>

                            {data.quest > 0 && (
                              <div className="mt-2 text-xs text-gray-600 flex justify-between">
                                <span>åŸºæœ¬å£²ä¸Š: Â¥{data.earnings.toLocaleString()}</span>
                                <span>ã‚¯ã‚¨ã‚¹ãƒˆ: Â¥{data.quest.toLocaleString()}</span>
                              </div>
                            )}
                          </div>
                        );
                      });
                    })()}
                  </div>
                </div>

                <div
                  className={`p-4 border-t ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}
                  style={{flexShrink: 0, touchAction: 'none'}}
                >
                  <button
                    onClick={() => setShowWeeklySalesList(false)}
                    className="w-full bg-gray-500 text-white py-3 rounded-xl font-medium hover:bg-gray-600 transition-colors"
                    style={{touchAction: 'auto'}}
                  >
                    é–‰ã˜ã‚‹
                  </button>
                </div>
              </div>
            )}

            {/* ãƒ“ãƒƒãƒˆã‚³ã‚¤ãƒ³ç©ã¿ç«‹ã¦ãƒ¢ãƒ¼ãƒ€ãƒ« */}
            {showBTCModal && (
              <div
                className={`fixed inset-0 z-50 ${isDarkMode ? 'bg-gray-900' : 'bg-white'}`}
                style={{
                  display: 'flex',
                  flexDirection: 'column',
                  overflow: 'hidden'
                }}
              >
                {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
                <div
                  className={`border-b p-4 flex items-center justify-between ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}
                  style={{flexShrink: 0, touchAction: 'none'}}
                >
                  <h2 className={`text-xl font-bold flex items-center gap-2 ${isDarkMode ? 'text-white' : 'text-gray-800'}`}>
                    <img src="BTC.png" alt="BTC" className="w-6 h-6" />
                    ãƒ“ãƒƒãƒˆã‚³ã‚¤ãƒ³ç©ã¿ç«‹ã¦è¨˜éŒ²
                  </h2>
                  <button
                    onClick={() => setShowBTCModal(false)}
                    className={`text-2xl ${isDarkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}`}
                    style={{touchAction: 'auto'}}
                  >
                    Ã—
                  </button>
                </div>

                {/* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
                <div
                  style={{
                    flex: 1,
                    overflowY: 'auto',
                    WebkitOverflowScrolling: 'touch',
                    minHeight: 0
                  }}
                >
                  <div className="p-4 flex items-center justify-center h-full">
                    <div className="text-center">
                      <div className="text-6xl mb-4">ğŸš§</div>
                      <h3 className={`text-xl font-bold mb-2 ${isDarkMode ? 'text-white' : 'text-gray-800'}`}>æº–å‚™ä¸­</h3>
                      <p className={isDarkMode ? 'text-gray-400' : 'text-gray-600'}>ã‚³ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯APIã¨ã®é€£æºã‚’å®Ÿè£…äºˆå®šã§ã™</p>
                    </div>
                  </div>
                </div>

                {/* ãƒ•ãƒƒã‚¿ãƒ¼ */}
                <div
                  className={`p-4 border-t ${isDarkMode ? 'border-gray-700' : 'border-gray-200'}`}
                  style={{flexShrink: 0, touchAction: 'none'}}
                >
                  <button
                    onClick={() => setShowBTCModal(false)}
                    className="w-full bg-gray-500 text-white py-3 rounded-xl font-medium hover:bg-gray-600 transition-colors"
                    style={{touchAction: 'auto'}}
                  >
                    é–‰ã˜ã‚‹
                  </button>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    // å£²ä¸Šãƒ‡ãƒ¼ã‚¿CSVç”Ÿæˆé–¢æ•°
    function generateSalesCSV() {
      const dailyData = JSON.parse(localStorage.getItem('dailyData') || '{}');

      // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆ
      const sortedEntries = Object.entries(dailyData).sort((a, b) => a[0].localeCompare(b[0]));

      if (sortedEntries.length === 0) {
        alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return null;
      }

      let csv = '\uFEFF'; // BOM for UTF-8

      // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
      csv += 'ã€æ—¥åˆ¥å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã€‘\n';
      csv += 'æ—¥ä»˜,æ›œæ—¥,ç¨¼åƒæ™‚é–“,é…é”ä»¶æ•°,åŸºæœ¬å£²ä¸Š,ã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬,åˆè¨ˆå£²ä¸Š,å¹³å‡å˜ä¾¡,æ™‚çµ¦,é›¨ã®æ—¥,ç¥æ—¥\n';

      // æœˆåˆ¥é›†è¨ˆç”¨ã®ãƒ‡ãƒ¼ã‚¿
      const monthlyData = {};
      const yearlyData = {};

      // æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›
      sortedEntries.forEach(([dateStr, data]) => {
        const date = new Date(dateStr + 'T00:00:00');
        const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
        const dayOfWeek = dayNames[date.getDay()];
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const monthKey = `${year}-${String(month).padStart(2, '0')}`;

        // ãƒ‡ãƒ¼ã‚¿ã®è¨ˆç®—
        const totalEarnings = (data.earnings || 0) + (data.quest || 0);
        const avgPrice = data.deliveries > 0 ? Math.round(data.earnings / data.deliveries) : 0;
        const hourlyWage = data.hours > 0 ? Math.round(totalEarnings / data.hours) : 0;
        const isRainy = data.isRainy ? 'â—‹' : '';
        const isHoliday = data.isHoliday ? 'â—‹' : '';

        // CSVã«è¿½åŠ 
        csv += `${dateStr},${dayOfWeek},${data.hours || 0},${data.deliveries || 0},${data.earnings || 0},${data.quest || 0},${totalEarnings},${avgPrice},${hourlyWage},${isRainy},${isHoliday}\n`;

        // æœˆåˆ¥é›†è¨ˆ
        if (!monthlyData[monthKey]) {
          monthlyData[monthKey] = {
            hours: 0,
            deliveries: 0,
            earnings: 0,
            quest: 0,
            days: 0,
            rainyDays: 0,
            holidays: 0
          };
        }
        monthlyData[monthKey].hours += data.hours || 0;
        monthlyData[monthKey].deliveries += data.deliveries || 0;
        monthlyData[monthKey].earnings += data.earnings || 0;
        monthlyData[monthKey].quest += data.quest || 0;
        monthlyData[monthKey].days += 1;
        if (data.isRainy) monthlyData[monthKey].rainyDays += 1;
        if (data.isHoliday) monthlyData[monthKey].holidays += 1;

        // å¹´åˆ¥é›†è¨ˆ
        if (!yearlyData[year]) {
          yearlyData[year] = {
            hours: 0,
            deliveries: 0,
            earnings: 0,
            quest: 0,
            days: 0,
            rainyDays: 0,
            holidays: 0
          };
        }
        yearlyData[year].hours += data.hours || 0;
        yearlyData[year].deliveries += data.deliveries || 0;
        yearlyData[year].earnings += data.earnings || 0;
        yearlyData[year].quest += data.quest || 0;
        yearlyData[year].days += 1;
        if (data.isRainy) yearlyData[year].rainyDays += 1;
        if (data.isHoliday) yearlyData[year].holidays += 1;
      });

      // æœˆåˆ¥é›†è¨ˆã‚’è¿½åŠ 
      csv += '\nã€æœˆåˆ¥é›†è¨ˆã€‘\n';
      csv += 'å¹´æœˆ,ç¨¼åƒæ—¥æ•°,ç¨¼åƒæ™‚é–“,é…é”ä»¶æ•°,åŸºæœ¬å£²ä¸Š,ã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬,åˆè¨ˆå£²ä¸Š,å¹³å‡æ™‚çµ¦,1æ—¥å¹³å‡,é›¨ã®æ—¥æ•°,ç¥æ—¥æ•°\n';

      Object.entries(monthlyData).sort((a, b) => a[0].localeCompare(b[0])).forEach(([monthKey, data]) => {
        const totalEarnings = data.earnings + data.quest;
        const avgHourlyWage = data.hours > 0 ? Math.round(totalEarnings / data.hours) : 0;
        const avgDaily = data.days > 0 ? Math.round(totalEarnings / data.days) : 0;

        csv += `${monthKey},${data.days},${data.hours.toFixed(1)},${data.deliveries},${data.earnings},${data.quest},${totalEarnings},${avgHourlyWage},${avgDaily},${data.rainyDays},${data.holidays}\n`;
      });

      // å¹´åˆ¥é›†è¨ˆã‚’è¿½åŠ 
      csv += '\nã€å¹´åˆ¥é›†è¨ˆã€‘\n';
      csv += 'å¹´,ç¨¼åƒæ—¥æ•°,ç¨¼åƒæ™‚é–“,é…é”ä»¶æ•°,åŸºæœ¬å£²ä¸Š,ã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬,åˆè¨ˆå£²ä¸Š,å¹³å‡æ™‚çµ¦,1æ—¥å¹³å‡,é›¨ã®æ—¥æ•°,ç¥æ—¥æ•°\n';

      Object.entries(yearlyData).sort((a, b) => a[0].localeCompare(b[0])).forEach(([year, data]) => {
        const totalEarnings = data.earnings + data.quest;
        const avgHourlyWage = data.hours > 0 ? Math.round(totalEarnings / data.hours) : 0;
        const avgDaily = data.days > 0 ? Math.round(totalEarnings / data.days) : 0;

        csv += `${year},${data.days},${data.hours.toFixed(1)},${data.deliveries},${data.earnings},${data.quest},${totalEarnings},${avgHourlyWage},${avgDaily},${data.rainyDays},${data.holidays}\n`;
      });

      return csv;
    }

    // CSVç”Ÿæˆé–¢æ•°
    function generateExpenseCSV() {
      const expenses = JSON.parse(localStorage.getItem('expenses') || '{}');

      const creditAccountSubjects = {
        cash: 'ç¾é‡‘',
        credit: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ',
        ordinaryDeposit: 'æ™®é€šé é‡‘'
      };

      let csv = '\uFEFF'; // BOM for UTF-8
      csv += 'æ—¥ä»˜,å€Ÿæ–¹ç§‘ç›®,è²¸æ–¹ç§‘ç›®,æ”¯æ‰•é‡‘é¡,äº‹æ¥­å‰²åˆ(%),çµŒè²»è¨ˆä¸Šé¡,ãƒ¡ãƒ¢ãƒ»å‚™è€ƒ,å†™çœŸ\n';

      Object.entries(expenses)
        .sort(([, a], [, b]) => new Date(a.date) - new Date(b.date))
        .forEach(([id, expense]) => {
          const date = expense.date;
          const debitSubject = accountingSubjects[expense.accountingSubject] || 'æ—…è²»äº¤é€šè²»';
          const creditSubject = creditAccountSubjects[expense.creditAccount] || '';
          const amount = expense.amount || 0;
          const percentage = expense.businessPercentage ?? 100;
          const businessAmount = Math.floor(amount * percentage / 100);
          const memo = expense.memo || '';
          const photo = expense.photo ? 'æœ‰' : 'ç„¡';

          csv += `${date},${debitSubject},${creditSubject},${amount},${percentage},${businessAmount},"${memo}",${photo}\n`;
        });

      return csv;
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ - ã‚¨ãƒ©ãƒ¼ã‚’ç”»é¢ã«è¡¨ç¤ºï¼ˆrenderã®å‰ã«è¨­å®šï¼‰
    window.onerror = function(msg, url, lineNo, columnNo, error) {
      console.error('Global error caught:', { msg, url, lineNo, columnNo, error });

      // localStorageã®çŠ¶æ…‹ã‚’ç¢ºèª
      let localStorageInfo = '';
      try {
        const keys = Object.keys(localStorage);
        localStorageInfo = `<p><strong>localStorage keys:</strong> ${keys.join(', ')}</p>`;
      } catch (e) {
        localStorageInfo = `<p><strong>localStorage:</strong> ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“</p>`;
      }

      const errorDiv = document.createElement('div');
      errorDiv.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:white;z-index:99999;padding:20px;overflow:auto;font-family:monospace;font-size:14px;';
      errorDiv.innerHTML = `
        <h1 style="color:red;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h1>
        <p><strong>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</strong> ${msg}</p>
        <p><strong>URL:</strong> ${url || 'unknown'}</p>
        <p><strong>è¡Œ:</strong> ${lineNo}</p>
        <p><strong>åˆ—:</strong> ${columnNo}</p>
        <p><strong>ã‚¨ãƒ©ãƒ¼:</strong> ${error?.stack || error || 'null'}</p>
        ${localStorageInfo}
        <div style="margin-top:20px;">
          <button onclick="localStorage.clear();location.reload();" style="padding:10px 20px;font-size:16px;margin-right:10px;">
            localStorageã‚’ã‚¯ãƒªã‚¢ã—ã¦å†èª­ã¿è¾¼ã¿
          </button>
          <button onclick="location.reload();" style="padding:10px 20px;font-size:16px;">
            ãã®ã¾ã¾å†èª­ã¿è¾¼ã¿
          </button>
        </div>
      `;
      document.body.appendChild(errorDiv);
      return false;
    };

    // Promise rejection ã®ã‚¨ãƒ©ãƒ¼ã‚‚ã‚­ãƒ£ãƒƒãƒ
    window.addEventListener('unhandledrejection', function(event) {
      const errorDiv = document.createElement('div');
      errorDiv.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:white;z-index:99999;padding:20px;overflow:auto;font-family:monospace;font-size:14px;';
      errorDiv.innerHTML = `
        <h1 style="color:red;">Promise ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h1>
        <p><strong>ç†ç”±:</strong> ${event.reason}</p>
        <button onclick="localStorage.clear();location.reload();" style="padding:10px 20px;font-size:16px;margin-top:20px;">
          localStorageã‚’ã‚¯ãƒªã‚¢ã—ã¦å†èª­ã¿è¾¼ã¿
        </button>
      `;
      document.body.appendChild(errorDiv);
    });

    // Render the app
    try {
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    } catch (error) {
      const errorDiv = document.createElement('div');
      errorDiv.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:white;z-index:99999;padding:20px;overflow:auto;font-family:monospace;font-size:14px;';
      errorDiv.innerHTML = `
        <h1 style="color:red;">ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼</h1>
        <p><strong>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</strong> ${error.message}</p>
        <p><strong>ã‚¹ã‚¿ãƒƒã‚¯:</strong></p>
        <pre style="background:#f5f5f5;padding:10px;overflow:auto;">${error.stack}</pre>
        <button onclick="localStorage.clear();location.reload();" style="padding:10px 20px;font-size:16px;margin-top:20px;">
          localStorageã‚’ã‚¯ãƒªã‚¢ã—ã¦å†èª­ã¿è¾¼ã¿
        </button>
      `;
      document.body.appendChild(errorDiv);
      throw error;
    }

    // Service Workerã®ç™»éŒ²
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(registration => console.log('SW registered'))
          .catch(err => console.log('SW registration failed'));
      });
    }
  </script>
</body>
</html>